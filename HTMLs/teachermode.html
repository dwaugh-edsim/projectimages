<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>SITUATION ROOM // COMMAND CENTER</title>
    <!-- Tailwind CSS + DaisyUI via CDN -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Oswald:wght@700&display=swap"
        rel="stylesheet">
    <link rel="icon" type="image/png" href="images/logic_gear_logo.png">

    <!-- SYSTEM SCRIPTS -->
    <script src="config.js"></script>
    <script>
        // --- BOOTSTRAP CONFIGURATION (Silent Defaults) ---
        const SB_URL = localStorage.getItem('TM_SUPABASE_URL') || (typeof CONFIG !== 'undefined' ? CONFIG.SB_URL : '');
        const SB_KEY = localStorage.getItem('TM_SUPABASE_KEY') || (typeof CONFIG !== 'undefined' ? CONFIG.SB_KEY : '');
        const TEACHER_HANDLE = localStorage.getItem('TM_TEACHER_HANDLE') || (typeof CONFIG !== 'undefined' ? CONFIG.TEACHER_ID : '');
        let GOOGLE_CLIENT_ID = localStorage.getItem('TM_GCP_CLIENT_ID') || "985904065235-u0115ektel546fs42mar5rch46utkki6.apps.googleusercontent.com";
    </script>
    <script src="critical_crypto.js"></script>
    <script src="https://accounts.google.com/gsi/client" onload="initGoogleAuth()" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Quill Rich Text Editor (Legacy Port) -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script src="https://unpkg.com/turndown/dist/turndown.js"></script>
    <script src="supabase_bridge.js"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .font-display {
            font-family: 'Oswald', sans-serif;
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Legacy Scrollbar Patch */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0f0f0f;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Smooth Tabs Transition */
        .tab-content {
            transition: all 0.2s ease-in-out;
        }
    </style>
</head>

<body class="min-h-screen bg-base-300 text-base-content overflow-hidden flex flex-col">

    <!-- TOP NAVBAR -->
    <div class="navbar bg-base-100 border-b border-base-content/10 px-4 h-16 flex-none z-50 shadow-md">
        <div class="flex-1 gap-4">
            <div class="flex items-center gap-3">
                <img src="images/logic_gear_logo.png" class="h-8 w-8 drop-shadow-[0_0_5px_rgba(0,255,204,0.5)]">
                <div>
                    <h1 class="text-xl font-display tracking-widest text-primary leading-none">SITUATION ROOM</h1>
                    <button
                        class="btn btn-xs btn-ghost text-[0.6rem] font-mono opacity-50 tracking-widest hover:opacity-100"
                        onclick="openSettings()">COMMAND CENTER v3.0 // CONFIG</button>
                </div>
            </div>
            <div class="divider divider-horizontal mx-0"></div>

            <!-- GLOBAL STATUS BADGES -->
            <div class="flex gap-2">
                <div id="status-badge-sb" class="badge badge-outline badge-xs gap-1 font-mono">
                    <div class="w-1.5 h-1.5 rounded-full bg-error"></div> SB_OFFLINE
                </div>
                <div id="status-badge-auth" class="badge badge-outline badge-xs gap-1 font-mono opacity-50">
                    GUEST
                </div>
            </div>
        </div>

        <div class="flex-none gap-2">
            <!-- SETTINGS BTN -->
            <button class="btn btn-ghost btn-circle btn-sm" onclick="openSettings()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </button>
            <div class="dropdown dropdown-end">
                <div tabindex="0" role="button" class="btn btn-ghost btn-circle avatar placeholder">
                    <div class="bg-neutral text-neutral-content rounded-full w-8">
                        <span id="user-avatar-initials">G</span>
                    </div>
                </div>
                <ul tabindex="0"
                    class="menu menu-sm dropdown-content mt-3 z-[1] p-2 shadow bg-base-100 rounded-box w-52">
                    <li><a onclick="initGoogleAuth()">Verify Identity</a></li>
                    <li><a onclick="toggleAboutModal()">About System</a></li>
                    <li><a onclick="document.documentElement.setAttribute('data-theme', 'light')">Light Mode</a></li>
                    <li><a onclick="document.documentElement.setAttribute('data-theme', 'dark')">Dark Mode</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- MAIN APP SHELL -->
    <div class="flex-1 flex overflow-hidden">

        <!-- SIDEBAR NAVIGATION -->
        <div class="w-64 bg-base-200 border-r border-base-content/10 flex flex-col p-4 gap-2">

            <!-- Navigation Menu -->
            <ul class="menu bg-base-100 w-full rounded-box gap-1">
                <li>
                    <a class="active font-bold" onclick="switchMainTab('dashboard')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                        </svg>
                        Dashboard
                    </a>
                </li>
                <li>
                    <a class="font-bold" onclick="switchMainTab('forge')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                        </svg>
                        Mission Forge
                    </a>
                </li>
                <li>
                    <a class="font-bold" onclick="switchMainTab('classes')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                        Class Directory
                    </a>
                </li>
                <li>
                    <a class="font-bold" onclick="switchMainTab('library')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z" />
                        </svg>
                        Library
                    </a>
                </li>
            </ul>

            <div class="divider my-2"></div>

            <!-- System Consolse Status -->
            <div class="card bg-base-300 shadow-inner flex-1 overflow-hidden flex flex-col">
                <div
                    class="px-3 py-2 bg-base-content/5 text-[0.65rem] font-bold opacity-50 uppercase tracking-wider flex justify-between">
                    <span>System Log</span>
                    <button class="hover:text-primary" onclick="window.location.reload()">REBOOT</button>
                </div>
                <div id="sm-console"
                    class="p-2 font-mono text-[0.6rem] overflow-y-auto flex-1 leading-relaxed opacity-70">
                    <div class="text-success">> SYSTEM INIT...</div>
                </div>
            </div>

        </div>

        <!-- MAIN CONTENT AREA -->
        <div class="flex-1 bg-base-300 p-6 overflow-y-auto relative" id="main-scroll-area">

            <!-- VIEW: DASHBOARD -->
            <div id="view-dashboard" class="space-y-6 max-w-7xl mx-auto tab-view">

                <!-- Quick Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="stat bg-base-100 shadow rounded-box border border-base-content/5">
                        <div class="stat-figure text-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                class="inline-block w-8 h-8 stroke-current">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </div>
                        <div class="stat-title font-display tracking-wide">Active Missions</div>
                        <div class="stat-value text-primary" id="dash-stat-missions">--</div>
                        <div class="stat-desc">Ready to deploy</div>
                    </div>

                    <div class="stat bg-base-100 shadow rounded-box border border-base-content/5">
                        <div class="stat-figure text-secondary">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                class="inline-block w-8 h-8 stroke-current">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z">
                                </path>
                            </svg>
                        </div>
                        <div class="stat-title font-display tracking-wide">Students</div>
                        <div class="stat-value text-secondary" id="dash-stat-students">--</div>
                        <div class="stat-desc">Registered seats</div>
                    </div>

                    <div class="stat bg-base-100 shadow rounded-box border border-base-content/5">
                        <div class="stat-figure text-accent">
                            <div class="radial-progress bg-base-200 text-accent border-4 border-base-200"
                                style="--value:70; --size:2.5rem;" role="progressbar">70%</div>
                        </div>
                        <div class="stat-title font-display tracking-wide">Sync Status</div>
                        <div class="stat-value text-accent" id="dash-stat-sync">ONLINE</div>
                        <div class="stat-desc">Database connected</div>
                    </div>
                </div>

                <!-- Action Cards -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Create Card -->
                    <div class="card bg-base-100 shadow-xl image-full h-64 group cursor-pointer transition-all hover:scale-[1.01]"
                        onclick="switchMainTab('forge')">
                        <figure><img
                                src="https://images.unsplash.com/photo-1614726365723-49cfae92782f?q=80&w=2669&auto=format&fit=crop"
                                class="opacity-40 group-hover:opacity-60 transition-opacity" alt="Space" /></figure>
                        <div class="card-body justify-end">
                            <h2 class="card-title text-3xl font-display tracking-wider text-base-100 mix-blend-overlay">
                                MISSION FORGE</h2>
                            <p class="grow-0 text-base-200/80">Launch the AI Architect to build custom scenarios.</p>
                            <div class="card-actions justify-end">
                                <button class="btn btn-primary gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                    </svg>
                                    Initialize New Forge
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Manage Card -->
                    <div class="card bg-base-100 shadow-xl border border-base-content/10 h-64">
                        <div class="card-body">
                            <h2 class="card-title font-display tracking-wide">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-secondary" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                                </svg>
                                Recent Activity
                            </h2>
                            <div class="overflow-y-auto flex-1 -mx-4 px-4">
                                <ul class="timeline timeline-vertical timeline-compact timeline-snap-icon w-full">
                                    <li>
                                        <hr class="bg-primary" />
                                        <div class="timeline-middle">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                                                fill="currentColor" class="h-5 w-5 text-primary">
                                                <path fill-rule="evenodd"
                                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z"
                                                    clip-rule="evenodd" />
                                            </svg>
                                        </div>
                                        <div class="timeline-end mb-2">
                                            <time class="font-mono italic text-xs opacity-50">Just now</time>
                                            <div class="text-sm font-bold text-base-content">System Ready</div>
                                            <div class="text-xs opacity-70">Dashboard initialized successfully.</div>
                                        </div>
                                        <hr />
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: FORGE (Placeholder for Logic Transplant) -->
            <div id="view-forge" class="hidden tab-view h-full flex flex-col">
                <!-- Forge Header -->
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-display tracking-widest text-primary flex items-center gap-2">
                            MISSION FORGE
                            <div class="badge badge-warning badge-sm font-mono align-top animate-pulse">AI ALPHA</div>
                        </h2>
                        <p class="text-sm opacity-60">Modular Mission Construction Pipeline</p>
                    </div>
                    <!-- Pipeline Stepper Container (matches Logic ID) -->
                    <div id="pipeline-stepper" class="steps">
                        <!-- Injected by JS -->
                    </div>
                </div>

                <!-- Forge Main Area -->
                <div
                    class="bg-base-100 rounded-xl shadow-xl border border-base-content/10 overflow-hidden relative flex h-[max(600px,calc(100vh-250px))]">

                    <!-- Forge Panel (Inputs) -->
                    <div id="forge-panel"
                        class="w-1/3 border-r border-base-content/10 p-6 flex flex-col gap-4 overflow-y-auto bg-base-200/50">
                        <div class="flex justify-between items-end">
                            <span class="text-xs font-bold tracking-widest text-primary">CURRENT PHASE</span>
                            <button class="btn btn-ghost btn-xs" onclick="resetForge()">RESET</button>
                            <button class="btn btn-secondary btn-outline btn-xs gap-1" onclick="openWorkshop()">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path
                                        d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                                    <path fill-rule="evenodd"
                                        d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"
                                        clip-rule="evenodd" />
                                </svg>
                                WORKSHOP
                            </button>
                        </div>
                        <h2 id="forge-title" class="text-3xl font-display uppercase leading-tight">INITIALIZING...</h2>
                        <p id="forge-desc" class="text-sm opacity-70 mb-4">Establishing secure connection to neural
                            core...</p>

                        <!-- Dynamic Input Zones -->
                        <div id="curriculum-zone" class="card bg-base-100 border border-base-300 p-4 shadow-sm text-sm">
                            <div class="flex justify-between mb-2">
                                <span class="font-bold text-xs uppercase opacity-50">Context Hooks</span>
                            </div>
                            <!-- Selects (IDs match old logic) -->
                            <select id="f-country" class="select select-bordered select-xs w-full mb-2"
                                onchange="updateForgeRegions()">
                                <option value="">Select Country...</option>
                            </select>
                            <select id="f-region" class="select select-bordered select-xs w-full mb-2 hidden"
                                onchange="updateForgeCourses()"></select>
                            <select id="f-course" class="select select-bordered select-xs w-full mb-2 hidden"
                                onchange="updateForgeOutcomes()"></select>

                            <div class="divider text-[0.6rem] opacity-30 my-1">TARGET OUTCOMES</div>
                            <div id="f-outcomes" class="max-h-40 overflow-y-auto space-y-1 pr-2 custom-scrollbar">
                                <p class="text-center opacity-30 text-[0.6rem] py-4">SELECT COURSE TO LOAD OUTCOMES</p>
                            </div>

                            <!-- Custom Add Lab (Legacy Port) -->
                            <div id="custom-add-zone" class="mt-4 pt-4 border-t border-base-content/10 hidden">
                                <div class="space-y-2">
                                    <input id="custom-country" type="text" placeholder="COUNTRY (e.g. Canada)"
                                        class="input input-bordered input-xs w-full">
                                    <input id="custom-region" type="text" placeholder="REGION (e.g. Ontario)"
                                        class="input input-bordered input-xs w-full">
                                    <input id="custom-course-name" type="text" placeholder="COURSE NAME"
                                        class="input input-bordered input-xs w-full">
                                    <textarea id="custom-outcomes-raw" placeholder="OUTCOMES (ONE PER LINE)"
                                        class="textarea textarea-bordered textarea-xs w-full h-20"></textarea>
                                    <button class="btn btn-xs btn-primary w-full" onclick="saveCustomCourse()">SAVE TO
                                        LOCAL LAB</button>
                                </div>
                            </div>
                            <div class="text-center mt-2">
                                <button id="custom-toggle-btn" onclick="toggleCustomAdd()"
                                    class="btn btn-link btn-xs no-underline opacity-50 hover:opacity-100">+ ADD CUSTOM
                                    COURSE</button>
                            </div>
                        </div>

                        <div class="form-control flex-1">
                            <textarea id="f-input"
                                class="textarea textarea-bordered h-full font-mono text-sm leading-relaxed"
                                placeholder="Enter command context..."></textarea>
                        </div>

                        <div class="flex gap-2 mt-auto">
                            <button class="btn btn-neutral flex-1" onclick="forgeBack()">Back</button>
                            <button id="f-submit" class="btn btn-primary flex-[2]" onclick="processForge()">Submit
                                Command</button>
                        </div>
                    </div>

                    <!-- Forge Output (Chat) -->
                    <div id="forge-output" class="flex-1 bg-base-100 relative flex flex-col">
                        <div id="forge-chat" class="flex-1 p-6 overflow-y-auto space-y-4">
                            <div class="chat chat-start">
                                <div class="chat-image avatar placeholde">
                                    <div class="w-10 rounded-full bg-neutral text-neutral-content">
                                        <span>AI</span>
                                    </div>
                                </div>
                                <div class="chat-bubble chat-bubble-primary font-mono text-sm">
                                    <strong>CREATE SYSTEM ONLINE.</strong><br>
                                    Welcome to the V2 Forge integration. Select your curriculum context to begin.
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- VIEW: CLASS DIRECTORY -->
            <div id="view-classes" class="hidden tab-view max-w-7xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-display tracking-widest text-secondary">CLASS DIRECTORY</h2>
                        <p class="text-sm opacity-60" id="class-count-header">Manage student cohorts and assigned
                            missions.</p>
                    </div>
                    <button class="btn btn-secondary gap-2" onclick="registerClass()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        New Class
                    </button>
                </div>

                <div class="card bg-base-100 shadow-xl border border-base-content/10">
                    <div class="overflow-x-auto">
                        <table class="table table-zebra w-full" id="class-table-v3">
                            <thead>
                                <tr class="bg-base-200 uppercase text-xs font-bold tracking-wider opacity-70">
                                    <th>Class Name</th>
                                    <th>Access Code</th>
                                    <th>Students</th>
                                    <th>Missions</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="class-directory-list-body">
                                <!-- JS Injects Rows Here -->
                                <tr>
                                    <td colspan="5" class="text-center py-8 opacity-50">Loading class registry...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW: LIBRARY -->
            <div id="view-library" class="hidden tab-view max-w-7xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-display tracking-widest text-accent">MISSION LIBRARY</h2>
                        <p class="text-sm opacity-60">Archive of all generated and deployed simulations.</p>
                    </div>
                    <div class="flex gap-2">
                        <button class="btn btn-outline btn-sm" onclick="fetchMissions()">Refresh</button>
                        <button class="btn btn-accent btn-sm gap-2"
                            onclick="document.getElementById('file-input').click()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                            </svg>
                            Upload .BLOB
                        </button>
                        <input type="file" id="file-input" accept=".blob" class="hidden"
                            onchange="handleFile(this.files[0])">
                    </div>
                </div>

                <div id="hub-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- JS Injects Mission Cards Here -->
                </div>
            </div>

        </div>
    </div>

    <!-- Hidden Modals (DaisyUI Format) -->

    <!-- SETTINGS MODAL -->
    <dialog id="settings_modal" class="modal">
        <div class="modal-box bg-base-100 border border-base-content/10">
            <h3 class="font-bold text-lg font-display tracking-widest mb-4">SYSTEM CONFIGURATION</h3>

            <div class="space-y-4">
                <div class="form-control">
                    <label class="label"><span class="label-text text-xs font-bold opacity-70">GOOGLE CLOUD API KEY
                            (Gemini)</span></label>
                    <input type="password" id="cfg-gcp-key"
                        class="input input-bordered input-sm font-mono tracking-widest text-xs" placeholder="AIZA...">
                </div>

                <div class="form-control">
                    <label class="label"><span class="label-text text-xs font-bold opacity-70">GCP PROJECT
                            ID</span></label>
                    <input type="text" id="cfg-gcp-project" class="input input-bordered input-sm font-mono text-xs"
                        placeholder="my-project-123">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div class="form-control">
                        <label class="label"><span
                                class="label-text text-xs font-bold opacity-70">LOCATION</span></label>
                        <input type="text" id="cfg-gcp-location" class="input input-bordered input-sm font-mono text-xs"
                            placeholder="us-central1">
                    </div>
                    <div class="form-control">
                        <label class="label"><span class="label-text text-xs font-bold opacity-70">MODEL</span></label>
                        <input type="text" id="cfg-gcp-model" class="input input-bordered input-sm font-mono text-xs"
                            placeholder="gemini-1.5-flash">
                    </div>
                </div>

                <div class="divider text-xs opacity-50">IDENTITY & DATABASE</div>

                <div class="form-control">
                    <label class="label"><span class="label-text text-xs font-bold opacity-70">TEACHER HANDLE
                            (ID)</span></label>
                    <input type="text" id="cfg-teacher-id"
                        class="input input-bordered input-sm font-mono text-xs uppercase" placeholder="SMITH_01">
                </div>

                <div class="form-control">
                    <label class="label"><span class="label-text text-xs font-bold opacity-70">SUPABASE
                            URL</span></label>
                    <input type="text" id="cfg-sb-url" class="input input-bordered input-sm font-mono text-xs"
                        placeholder="https://xyz.supabase.co">
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text text-xs font-bold opacity-70">SUPABASE ANON
                            KEY</span></label>
                    <input type="password" id="cfg-sb-key" class="input input-bordered input-sm font-mono text-xs"
                        placeholder="eyJ...">
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text text-xs font-bold opacity-70">GCP CLIENT ID
                            (Auth)</span></label>
                    <input type="text" id="cfg-gcp-client-id" class="input input-bordered input-sm font-mono text-xs"
                        placeholder="9859...apps.googleusercontent.com">
                </div>
            </div>

            <div class="modal-action">
                <button class="btn btn-ghost btn-sm"
                    onclick="document.getElementById('settings_modal').close()">Cancel</button>
                <button class="btn btn-primary btn-sm" onclick="saveSettings()">SAVE CONFIG</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <!-- AUTH MODAL -->
    <dialog id="auth_modal" class="modal modal-bottom sm:modal-middle">
        <div class="modal-box bg-base-100 border border-primary/20">
            <h3 class="font-bold text-lg font-display text-primary tracking-widest text-center mb-4">IDENTITY
                VERIFICATION</h3>
            <div id="google-signin-container" class="flex justify-center my-4"></div>
            <p class="py-4 text-center text-xs opacity-60">Secure Teacher Access Required</p>
        </div>
    </dialog>

    <!-- HOSPITAL MODAL (Node Editor) -->
    <dialog id="hospital_modal" class="modal modal-bottom sm:modal-middle">
        <div
            class="modal-box w-11/12 max-w-5xl h-[80vh] bg-base-100 border border-secondary/20 p-0 flex flex-col overflow-hidden">
            <!-- Modal Header -->
            <div class="bg-base-200 px-6 py-4 border-b border-base-content/10 flex justify-between items-center">
                <h3 class="font-bold text-lg font-display tracking-widest text-secondary flex items-center gap-2">
                    MISSION HOSPITAL <span class="badge badge-outline badge-xs font-mono opacity-50">NODE EDITOR</span>
                </h3>
                <div class="flex gap-2">
                    <button class="btn btn-sm btn-ghost" onclick="closeHospital()">CANCEL</button>
                    <button class="btn btn-sm btn-secondary" onclick="saveHospitalChanges()">SAVE CHANGES</button>
                </div>
            </div>

            <!-- Modal Body -->
            <div class="flex-1 flex overflow-hidden">
                <!-- Slide List Sidebar -->
                <div class="w-64 bg-base-200/50 border-r border-base-content/10 overflow-y-auto p-4 space-y-2"
                    id="h-slide-list">
                    <!-- Injected JS -->
                    <button class="btn btn-block btn-outline btn-xs border-dashed opacity-50 hover:opacity-100">+ Add
                        Node</button>
                </div>

                <!-- Main Editor -->
                <div class="flex-1 overflow-y-auto p-8" id="h-editor-area">
                    <!-- Form -->
                    <div class="max-w-3xl mx-auto space-y-6">
                        <div class="form-control">
                            <label class="label"><span class="label-text font-bold">Node Title</span></label>
                            <input type="text" id="h-title" class="input input-bordered font-display tracking-wider"
                                value="INITIAL BRIEFING">
                        </div>

                        <div class="grid grid-cols-2 gap-6">
                            <div class="form-control">
                                <label class="label"><span class="label-text font-bold">Narrative Brief</span></label>
                                <textarea id="h-brief"
                                    class="textarea textarea-bordered h-40 font-mono text-sm leading-relaxed"></textarea>
                            </div>
                            <div class="form-control">
                                <label class="label"><span class="label-text font-bold text-accent">Visual
                                        Prompt</span></label>
                                <textarea id="h-visual"
                                    class="textarea textarea-bordered textarea-accent h-40 font-mono text-xs"></textarea>
                            </div>
                        </div>

                        <div class="divider text-xs opacity-50">DECISION MATRIX</div>

                        <div class="card bg-base-200 p-4">
                            <div class="form-control mb-2">
                                <label class="label"><span class="label-text font-bold">Choice A</span></label>
                                <input type="text" id="h-choice-a" class="input input-sm input-bordered">
                            </div>
                            <div class="form-control">
                                <label class="label"><span class="label-text font-bold">Choice B</span></label>
                                <input type="text" id="h-choice-b" class="input input-sm input-bordered">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <script>
        // --- UX GLUE CODE (V3) ---

        function switchMainTab(tabName) {
            // Hide all views
            document.querySelectorAll('.tab-view').forEach(el => el.classList.add('hidden'));

            // Show target
            document.getElementById(`view-${tabName}`).classList.remove('hidden');

            // Update Sidebar Active State
            document.querySelectorAll('.menu a').forEach(el => el.classList.remove('active'));
            // (Simplified: In prod, map tabName to index or specific ID)
        }

        function log(msg, type = 'info') {
            const c = document.getElementById('sm-console');
            const time = new Date().toLocaleTimeString();
            let color = 'text-base-content';
            if (type === 'error') color = 'text-error';
            if (type === 'success') color = 'text-success';
            if (type === 'warning') color = 'text-warning';

            c.innerHTML += `<div class="${color} hover:bg-base-content/5 px-1 rounded font-mono">> [${time}] ${msg}</div>`;
            c.scrollTop = c.scrollHeight;
        }

        // Overwrite legacy Alert logic with DaisyUI Toasts (if we had them implemented fully, for now just custom log)
        // window.alert = function(msg) { log(`ALERT: ${msg}`, 'warning'); }
    </script>

    <!-- CORE LOGIC TRANSPLANT -->
    <script>
        // --- GLOBAL STATE ---
        let googleUser = null;
        let accumulatedData = {
            metadata: {},
            slides: [],
            intelligenceGlossary: {},
            aiPromptsExtracted: false
        };
        let currentMissions = [];
        let allProgress = [];

        // --- FORGE PIPELINE CONFIG ---
        const FORGE_PHASES = {
            'brainstorm': { id: 'brainstorm', title: "MISSION BRAINSTORM", label: "INTEL", desc: "Define core learning objectives and scenario parameters.", prompt: "Analyze the requested curriculum parameters. Suggest 3 distinct, high-stakes mission scenarios that fit the topic. Focus on 'Situation Room' style dilemmas." },
            'research': { id: 'research', title: "DEEP SEARCH INTEL", label: "RESEARCH", desc: "Gather real-world context and source material.", prompt: "Identify key historical or geopolitical events relevant to the chosen scenario. Suggest search queries." },
            'narrative': { id: 'narrative', title: "NARRATIVE ARCHITECTURE", label: "BRIEF", desc: "Structuring the mission beat-sheet.", prompt: "Develop the chosen scenario into a 10-slide beat sheet. SLIDE 1: Briefing, SLIDES 2-9: Incidents/Intel, SLIDE 10: Final Decision." },
            'assets': { id: 'assets', title: "VISUAL ASSETS", label: "VISUALS", desc: "Generating field imagery and evidence.", prompt: "Suggest image prompts for each slide. Focus on 'satellite view', 'CCTV footage', 'classified documents', and 'tactical maps'." },
            'deploy': { id: 'deploy', title: "FINAL ASSEMBLY", label: "DEPLOY", desc: "Compile and publish mission dossier.", prompt: "Finalize the JSON structure." }
        };

        const FORGE_SYSTEM_CORE = `YOU ARE 'MOTHER', THE CENTRAL INTELLIGENCE ARCHITECT.
Your goal is to build immersive, high-stakes educational simulations ("Missions") for students.
Tone: Professional, urgent, military/intelligence aesthetic.
Output: Structured, concise, decisive.
Format: Use Markdown. Heavy use of **bold** for key terms.`;

        let forgePipeline = ['brainstorm', 'research', 'narrative', 'assets', 'deploy'];
        let currentPhaseIndex = 0;
        let forgeHistory = [];

        // --- PROXY CONFIG ---
        // Placeholder for direct AI calls. Real implementation would likely use `callGoogleImageAPI` or similar structure from original file.
        // For V3 v1.0, we will assume the environment provides a 'callAI' or similar, or we replicate the fetch logic.

        function getCurrentPhase() {
            const phaseId = forgePipeline[currentPhaseIndex];
            return FORGE_PHASES[phaseId];
        }

        // --- FORGE RENDER LOGIC (DAISYUI V3) ---
        function renderPipelineStepper() {
            const container = document.getElementById('pipeline-stepper');
            if (!container) return;

            let html = '';
            forgePipeline.forEach((phaseId, index) => {
                const phase = FORGE_PHASES[phaseId];
                // Status Logic: 'step-primary' for completed/current
                let statusClass = (index <= currentPhaseIndex) ? 'step-primary' : '';

                // DaisyUI Step Item
                html += `<li class="step ${statusClass} text-[0.6rem] font-bold tracking-wider" data-content="${index + 1}">${phase.label}</li>`;
            });

            container.innerHTML = html;
        }

        function updateForgeUI() {
            const phase = getCurrentPhase();

            // 1. Update Header Info
            const titleEl = document.getElementById('forge-title');
            const descEl = document.getElementById('forge-desc');
            const submitBtn = document.getElementById('f-submit');
            const inputEl = document.getElementById('f-input');

            if (titleEl) titleEl.innerText = phase.title;
            if (descEl) descEl.innerText = phase.desc;

            // Special Handling for Deep Search
            const outputArea = document.getElementById('forge-output');
            if (phase.id === 'research') {
                renderDeepSearch(outputArea);
            } else {
                // Restore Chat View if not already there
                if (!document.getElementById('forge-chat')) {
                    outputArea.innerHTML = `<div id="forge-chat" class="flex-1 p-6 overflow-y-auto space-y-4"></div>`;
                    // Restore history
                    forgeHistory.forEach(h => addForgeChat(h.role, h.content));
                }
            }

            // 2. Button State
            if (submitBtn) {
                if (phase.id === 'deploy') {
                    submitBtn.innerText = "DEPLOY MISSION";
                    submitBtn.classList.add('btn-warning');
                    submitBtn.onclick = deployMission;
                } else {
                    submitBtn.innerText = "SUBMIT COMMAND";
                    submitBtn.classList.remove('btn-warning');
                    submitBtn.onclick = processForge;
                }
            }

            // 3. Input Placeholder
            if (inputEl) {
                inputEl.placeholder = `Enter orders for ${phase.label} phase...`;
            }

            // 4. Update Visual Stepper
            renderPipelineStepper();

            // 5. Scroll Chat
            const chat = document.getElementById('forge-chat');
            if (chat) chat.scrollTop = chat.scrollHeight;

            log(`Forge UI Updated: Phase ${currentPhaseIndex + 1}/${forgePipeline.length} [${phase.label}]`);
        }

        function addForgeChat(role, message) {
            const chat = document.getElementById('forge-chat');
            const isAI = role === 'ai' || role === 'assistant';
            const bubbleClass = isAI ? 'chat-bubble-primary' : 'chat-bubble-neutral';
            const alignClass = isAI ? 'chat-start' : 'chat-end';
            const avatarTxt = isAI ? 'AI' : 'OP';
            const avatarBg = isAI ? 'bg-primary text-primary-content' : 'bg-neutral text-neutral-content';

            // Parse Markdown (using marked.js if available, else text)
            const htmlContent = (typeof marked !== 'undefined') ? marked.parse(message) : message;

            const html = `
            <div class="chat ${alignClass} opacity-0 animate-[fadeIn_0.3s_ease-out_forwards]">
                <div class="chat-image avatar placeholder">
                    <div class="w-8 rounded-full ${avatarBg}">
                        <span class="text-xs">${avatarTxt}</span>
                    </div>
                </div>
                <div class="chat-bubble ${bubbleClass} text-sm font-mono leading-relaxed shadow-md">
                    ${htmlContent}
                </div>
                <div class="chat-footer opacity-50 text-[0.6rem] mt-1">
                    ${new Date().toLocaleTimeString()}
                </div>
            </div>`;

            chat.insertAdjacentHTML('beforeend', html);
            chat.scrollTop = chat.scrollHeight;
        }

        // --- DEEP SEARCH LOGIC ---
        function renderDeepSearch(container) {
            container.innerHTML = `
                <div class="h-full flex flex-col p-6 bg-base-100">
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="ds-query" class="input input-bordered flex-1 font-mono text-sm" placeholder="Enter query for Global Knowledge Graph..." value="${accumulatedData.metadata.title || ''} context">
                        <button class="btn btn-primary" onclick="executeDeepSearch()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                            SCAN
                        </button>
                    </div>
                    <div id="ds-results" class="flex-1 overflow-y-auto space-y-4 pr-2">
                        <div class="alert alert-info shadow-sm text-xs opacity-80">
                            <span>Initializing Deep Search Protocol... awaiting query.</span>
                        </div>
                    </div>
                </div>`;
        }

        async function executeDeepSearch() {
            const query = document.getElementById('ds-query').value;
            const resultsContainer = document.getElementById('ds-results');
            if (!query) return;

            resultsContainer.innerHTML = `<div class="flex justify-center p-10"><span class="loading loading-bars loading-lg text-primary"></span></div>`;

            try {
                // Mock API Call (Replace with Google Custom Search API)
                await new Promise(r => setTimeout(r, 1500));

                const mockResults = [
                    { title: "Historical Context: " + query, snippet: "Comprehensive overview of the geopolitical situation surrounding..." },
                    { title: "Primary Sources Archive", snippet: "Declassified documents revealing initial intelligence reports..." },
                    { title: "Timeline of Events", snippet: "Key dates and milestones relevant to the crisis..." }
                ];

                let html = '';
                mockResults.forEach((r, i) => {
                    html += `
                    <div class="card bg-base-200 border border-base-content/10 shadow-sm hover:shadow-md transition-shadow">
                        <div class="card-body p-4">
                            <h3 class="font-bold text-sm text-secondary uppercase tracking-wider mb-1">${r.title}</h3>
                            <p class="text-xs opacity-70 mb-3 font-mono">${r.snippet}</p>
                            <div class="card-actions justify-end">
                                <button class="btn btn-xs btn-outline" onclick="addForgeChat('assistant', 'Integrating research: **${r.title}**'); this.innerText='INTEGRATED'; this.disabled=true;">+ ADD TO INTEL</button>
                            </div>
                        </div>
                    </div>`;
                });
                resultsContainer.innerHTML = html;
                log(`Deep Search Scan Complete: ${query}`, 'success');

            } catch (e) {
                resultsContainer.innerHTML = `<div class="alert alert-error text-xs">${e.message}</div>`;
            }
        }

        function resetForge() {
            if (!confirm("TERMINATE CURRENT FORGE SESSION? All unsaved intelligence will be lost.")) return;
            currentPhaseIndex = 0;
            forgeHistory = [];
            accumulatedData = { metadata: {}, slides: [] };

            // Clear Chat
            const chat = document.getElementById('forge-chat');
            chat.innerHTML = `
                <div class="divider text-xs opacity-50">SESSION TERMINATED</div>
                <div class="chat chat-start">
                    <div class="chat-bubble chat-bubble-primary font-mono text-sm">
                        SYSTEM READY. AWAITING NEW DIRECTIVES.
                    </div>
                </div>`;

            updateForgeUI();
            log("Forge Session Reset.", "warning");
        }

        // --- AUTH & INIT ---
        function initGoogleAuth() {
            if (typeof google !== 'undefined' && google.accounts) {
                google.accounts.id.initialize({
                    client_id: GOOGLE_CLIENT_ID,
                    callback: handleCredentialResponse
                });
                // google.accounts.id.prompt(); 
                log("Google Auth Initialized.");
            }
        }

        function handleCredentialResponse(response) {
            const responsePayload = decodeJwtResponse(response.credential);
            googleUser = responsePayload;

            document.getElementById('status-badge-auth').innerText = "AUTH_OK";
            document.getElementById('status-badge-auth').classList.remove('opacity-50');
            document.getElementById('status-badge-auth').classList.add('text-success');
            document.getElementById('user-avatar-initials').innerText = googleUser.given_name?.[0] || "U";

            log(`Identity Verified: ${googleUser.email}`, "success");
        }

        function decodeJwtResponse(token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        // --- STUB FUNCTIONS FOR MISSING LOGIC (Will be filled in Phase 2) ---
        async function processForge() {
            const inputEl = document.getElementById('f-input');
            const input = inputEl.value.trim();
            const phase = getCurrentPhase();

            // 1. Check for basic navigation commands
            if (input.toLowerCase().match(/^(next|proceed|advance|continue)$/)) {
                advancePhase();
                inputEl.value = '';
                return;
            }

            // 2. Prepare UI
            addForgeChat('user', input || "(Generating intel...)");
            inputEl.value = '';
            const loadingId = `msg-${Date.now()}`;
            // Add temp loading bubble
            const chat = document.getElementById('forge-chat');
            chat.insertAdjacentHTML('beforeend', `<div id="${loadingId}" class="chat chat-start"><div class="chat-bubble chat-bubble-secondary animate-pulse text-xs">AWAITING SATELLITE UPLINK...</div></div>`);
            chat.scrollTop = chat.scrollHeight;

            try {
                console.log("processForge: Initiating AI Request...", { phase, inputLength: input.length });
                // 3. Construct Prompt Context
                let context = `${FORGE_SYSTEM_CORE}\n\n`;

                // Curriculum Context
                const country = document.getElementById('f-country').value;
                const region = document.getElementById('f-region').value;
                const course = document.getElementById('f-course').value;
                const checks = document.querySelectorAll('.outcome-check:checked');
                const selectedOutcomes = Array.from(checks).map(c => c.value);

                if (country || region || course) {
                    context += `\n--- TEACHER CONTEXT ---\n`;
                    context += `LOCALE: ${country} | ${region}\n`;
                    context += `COURSE: ${course}\n`;
                    if (selectedOutcomes.length > 0) {
                        context += `TARGET OUTCOMES: ${selectedOutcomes.join(" | ")}\n`;
                        log(`Aligning with ${selectedOutcomes.length} outcomes.`, "info");
                    }
                }

                // Append History (Last 6 turns to save tokens)
                const recentHistory = forgeHistory.slice(-6);
                if (recentHistory.length > 0) {
                    context += `\n--- PREVIOUS INTEL ---\n`;
                    recentHistory.forEach(h => context += `${h.role.toUpperCase()}: ${h.content}\n`);
                }

                context += `\nCURRENT OBJECTIVE: ${phase.title}\nINSTRUCTION: ${phase.prompt}\nUSER COMMAND: ${input}`;

                // 4. API Call
                console.log("processForge: Sending context to AI...");
                const responseText = await callAI(context);
                console.log("processForge: AI success.", responseText.substring(0, 50));

                // 5. Handle Success
                const loader = document.getElementById(loadingId);
                if (loader) loader.remove();
                addForgeChat('ai', responseText);

                // Save to History
                forgeHistory.push({ role: 'user', content: input });
                forgeHistory.push({ role: 'assistant', content: responseText });

                log(`AI Directive Received [${phase.label}]`, "success");

            } catch (e) {
                console.error("processForge Failure:", e);
                const loader = document.getElementById(loadingId);
                if (loader) loader.remove();
                addForgeChat('ai', `**CONNECTION LOST**: ${e.message}`);
                log(`Forge Error: ${e.message}`, "error");
            }
        }

        async function callAI(prompt) {
            // Priority 1: Google Cloud Direct (via Config or LocalStorage)
            const gcpKey = localStorage.getItem('TM_GCP_KEY') || (typeof CONFIG !== 'undefined' ? CONFIG.GCP_KEY : '');

            if (gcpKey) {
                // Gemini API Path
                const model = "gemini-1.5-flash";
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${gcpKey}`;
                try {
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await res.json();
                    if (data.candidates) return data.candidates[0].content.parts[0].text;
                    throw new Error(data.error?.message || "Gemini API Blocked");
                } catch (e) {
                    log(`AI Error: ${e.message}. Falling back to Simulation.`, "warning");
                }
            }

            // Fallback: Smart Simulation (for UI testing or offline)
            await new Promise(r => setTimeout(r, 1000));
            const simResponses = [
                "**INTEL ACQUIRED.** \nBased on your parameters, I suggest a scenario involving a diplomatic standoff in the South China Sea. \n\n**Option A**: Naval blockade. \n**Option B**: Cyber-attack on infrastructure. \n\nPlease advise on vector.",
                "**NARRATIVE BRIEFING UPDATED.** \nDeveloping slide sequence: \n1. **The Incident**: Unidentified vessel enters exclusion zone. \n2. **Escalation**: Warning shots fired. \n3. **Crisis**: Ambassador recalled.",
                "**VISUAL ASSETS GENERATED.** \nPROMPT: `Satellite view, thermal imaging, 4k, cinematic lighting.` \nConfirm art style?"
            ];
            // Cycle response based on phase to look uniform
            return simResponses[currentPhaseIndex % simResponses.length] || "System operational. Awaiting command.";
        }

        function advancePhase() {
            if (currentPhaseIndex >= forgePipeline.length - 1) return;

            // Create a small "system event" in chat
            const chat = document.getElementById('forge-chat');
            chat.insertAdjacentHTML('beforeend', `
                <div class="divider text-primary text-xs font-mono my-4">PHASE COMPLETE</div>
            `);

            currentPhaseIndex++;
            updateForgeUI();
        }
        // --- WORKSHOP LOGIC ---
        let currentEditingSlideIndex = -1;

        function openWorkshop() {
            // Populate Slide List
            const list = document.getElementById('h-slide-list');
            const data = accumulatedData.slides || [];

            if (data.length === 0) {
                // Initialize with default if empty
                accumulatedData.slides = [{ title: "INITIAL BRIEFING", brief: "Mission parameters...", visual: "Satellite view of target...", options: ["Accept", "Decline"] }];
            }

            renderWorkshopSidebar();

            // Open Modal
            document.getElementById('workshop_modal').showModal();
            loadSlideEditor(0);
        }

        function renderWorkshopSidebar() {
            const list = document.getElementById('h-slide-list');
            let html = '';
            (accumulatedData.slides || []).forEach((s, i) => {
                const active = i === currentEditingSlideIndex ? 'btn-active btn-secondary' : 'btn-ghost';
                html += `<button class="btn btn-sm ${active} justify-start font-normal" onclick="loadSlideEditor(${i})">
                    <span class="opacity-50 font-mono text-xs mr-2 w-4">${i + 1}.</span>
                    <span class="truncate">${s.title || 'Untitled Node'}</span>
                </button>`;
            });
            html += `<button class="btn btn-sm btn-outline btn-xs border-dashed opacity-50 hover:opacity-100 mt-4" onclick="addWorkshopNode()">+ Add Node</button>`;
            list.innerHTML = html;
        }

        function loadSlideEditor(index) {
            currentEditingSlideIndex = index;
            const s = accumulatedData.slides[index];
            if (!s) return;

            document.getElementById('h-title').value = s.title || '';
            document.getElementById('h-brief').value = s.brief || '';
            document.getElementById('h-visual').value = s.visual || '';
            document.getElementById('h-choice-a').value = s.options?.[0] || '';
            document.getElementById('h-choice-b').value = s.options?.[1] || '';

            renderWorkshopSidebar(); // Refresh active state
        }

        function saveWorkshopChanges() {
            if (currentEditingSlideIndex === -1) return;

            // Commit current form to memory
            const s = accumulatedData.slides[currentEditingSlideIndex];
            s.title = document.getElementById('h-title').value;
            s.brief = document.getElementById('h-brief').value;
            s.visual = document.getElementById('h-visual').value;
            s.options = [
                document.getElementById('h-choice-a').value,
                document.getElementById('h-choice-b').value
            ];

            log(`Updated Node ${currentEditingSlideIndex + 1}: ${s.title}`, 'success');
            renderWorkshopSidebar();
        }

        function addWorkshopNode() {
            accumulatedData.slides.push({ title: "NEW NODE", brief: "", visual: "" });
            renderWorkshopSidebar();
            loadSlideEditor(accumulatedData.slides.length - 1);
        }

        function closeWorkshop() {
            document.getElementById('workshop_modal').close();
        }

        async function deployMission() {
            if (!confirm("CONFIRM DEPLOYMENT? This will compile the mission dossier.")) return;

            // Generate minimal JSON structure
            const missionId = `MISSION_${Date.now().toString().slice(-6)}`;
            const finalData = {
                metadata: {
                    id: missionId,
                    title: `Mission ${new Date().toLocaleDateString()}`,
                    author: googleUser?.email || "GUEST",
                    created: new Date().toISOString()
                },
                history: forgeHistory,
                slides: accumulatedData.slides
            };

            // Download Blob
            const blob = new Blob([JSON.stringify(finalData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${missionId}.blob`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            log(`Mission Deployed: ${missionId}`, "success");
            addForgeChat('ai', `**MISSION DEPLOYED.**\nDossier ID: \`${missionId}\`\nDownload initiated.`);
        }

        // --- CLASS DIRECTORY LOGIC ---
        async function refreshClasses() {
            // Mock data if Supabase offline
            if (!SupabaseBridge.client) {
                renderClasses([
                    { id: 1, class_name: "Demo Class A", passcode: "DEMO1", student_count: 12, mission_ids: [] },
                    { id: 2, class_name: "AP History", passcode: "HIST9", student_count: 28, mission_ids: [] }
                ]);
                return;
            }

            try {
                const classes = await SupabaseBridge.fetchClasses(googleUser?.email || 'GUEST');
                renderClasses(classes);
            } catch (e) {
                log("Class Sync Failed: " + e.message, "error");
            }
        }

        function renderClasses(classes) {
            const tbody = document.getElementById('class-directory-list-body');
            if (!tbody) return;

            if (!classes.length) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center opacity-50 py-8">No active classes found. Create one to begin.</td></tr>`;
                return;
            }

            let html = '';
            classes.forEach(c => {
                html += `
                <tr class="hover transition-colors">
                    <td class="font-bold text-primary">${c.class_name}</td>
                    <td>
                        <div class="badge badge-lg badge-neutral font-mono tracking-widest text-accent">${c.passcode}</div>
                    </td>
                    <td>
                        <div class="flex items-center gap-2">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-50" viewBox="0 0 20 20" fill="currentColor"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" /></svg>
                             ${c.student_count || 0}
                        </div>
                    </td>
                    <td>
                        <div class="tooltip" data-tip="Assigned Missions">
                             <span class="badge badge-sm badge-ghost">${(c.mission_ids || []).length}</span>
                        </div>
                    </td>
                    <td>
                        <div class="join">
                            <button class="btn btn-xs btn-outline join-item" onclick="editClassUI('${c.id}')">Edit</button>
                            <button class="btn btn-xs btn-outline join-item" onclick="manageStudentsUI('${c.passcode}')">Roster</button>
                            <button class="btn btn-xs btn-error btn-outline join-item" onclick="deleteClassUI('${c.id}')">X</button>
                        </div>
                    </td>
                </tr>`;
            });
            tbody.innerHTML = html;
        }

        // --- LIBRARY LOGIC ---
        async function fetchMissions() {
            // Mock data
            const mockMissions = [
                { id: "M001", name: "Cuban Missile Crisis", description: "Naval blockade simulation.", thumb: "https://images.unsplash.com/photo-1599839575945-a9e5af0c3fa5?auto=format&fit=crop&q=80&w=200" },
                { id: "M002", name: "Mars Colony v1", description: " Resource management failure scenario.", thumb: "https://images.unsplash.com/photo-1614728853970-32a2f51d15d6?auto=format&fit=crop&q=80&w=200" }
            ];

            if (SupabaseBridge.client) {
                try {
                    const realMissions = await SupabaseBridge.fetchMissions(googleUser?.email || 'GUEST');
                    currentMissions = realMissions.length ? realMissions : mockMissions;
                } catch (e) { }
            } else {
                currentMissions = mockMissions;
            }

            renderLibrary(currentMissions);
        }

        function renderLibrary(missions) {
            const grid = document.getElementById('hub-grid');
            if (!grid) return;

            let html = '';
            missions.forEach(m => {
                html += `
                <div class="card bg-base-100 shadow-xl image-full group">
                    <figure><img src="${m.thumb || 'https://images.unsplash.com/photo-1451187580459-43490279c0fa'}" alt="Mission" class="opacity-40 group-hover:opacity-60 transition-opacity w-full h-48 object-cover" /></figure>
                    <div class="card-body p-4 justify-between">
                        <div>
                            <h2 class="card-title text-base text-white tracking-wider mb-1">${m.name}</h2>
                            <p class="text-xs text-base-200/80 line-clamp-2">${m.description || "No description available."}</p>
                        </div>
                        <div class="card-actions justify-between items-center mt-2">
                            <div class="badge badge-xs badge-ghost font-mono">${m.id}</div>
                            <button class="btn btn-sm btn-primary" onclick="loadMission('${m.id}')">Load</button>
                        </div>
                    </div>
                </div>`;
            });

            if (!missions.length) html = `<div class="col-span-3 text-center opacity-50 p-10">No missions found. Check filters or connection.</div>`;
            grid.innerHTML = html;
        }

        // --- CURRICULUM CONTEXT ---
        async function fetchCurriculum() {
            console.log("fetchCurriculum: Initiating load...");
            try {
                log("Synchronizing Curriculum Hub...");

                // 1. Load static curriculum.json (fast, cached)
                console.log("fetchCurriculum: Fetching curriculum.json");
                const res = await fetch("curriculum.json?v=" + Date.now());
                if (res.ok) {
                    window.curriculumData = await res.json();
                    console.log("fetchCurriculum: Local data loaded.", Object.keys(window.curriculumData));
                    log("Local Curriculum Loaded.", "success");
                } else {
                    console.warn("fetchCurriculum: curriculum.json fetch failed", res.status);
                    window.curriculumData = window.curriculumData || {};
                }

                // 2. Fetch from Supabase (extended library)
                if (window.SupabaseBridge && SupabaseBridge.client) {
                    try {
                        const outcomes = await SupabaseBridge.fetchAllOutcomes();
                        outcomes.forEach(o => {
                            if (!window.curriculumData[o.country]) window.curriculumData[o.country] = {};
                            if (!window.curriculumData[o.country][o.region]) window.curriculumData[o.country][o.region] = {};
                            if (!window.curriculumData[o.country][o.region][o.course]) window.curriculumData[o.country][o.region][o.course] = [];

                            let target = window.curriculumData[o.country][o.region][o.course];
                            if (!Array.isArray(target)) {
                                window.curriculumData[o.country][o.region][o.course] = [];
                                target = window.curriculumData[o.country][o.region][o.course];
                            }
                            if (!target.includes(o.description)) target.push(o.description);
                        });
                        log(`Cloud Curriculum Synced: ${outcomes.length} outcomes.`, "success");
                    } catch (e) {
                        log(`Cloud Sync Warning: ${e.message}`, "warning");
                    }
                }

                // 3. Merge Local "Custom Lab" outcomes (Legacy Port)
                const custom = JSON.parse(localStorage.getItem('blob_custom_curriculum')) || {};
                console.log("fetchCurriculum: Blending custom labs...", Object.keys(custom));
                Object.keys(custom).forEach(country => {
                    if (!window.curriculumData[country]) window.curriculumData[country] = {};
                    Object.keys(custom[country]).forEach(region => {
                        if (!window.curriculumData[country][region]) window.curriculumData[country][region] = {};
                        Object.keys(custom[country][region]).forEach(course => {
                            window.curriculumData[country][region][course] = custom[country][region][course];
                        });
                    });
                });

                log("Curriculum Hybridization Complete.");
                updateForgeCountries(); // Re-populate with blended data

                // Populate Country Select
                const sel = document.getElementById('f-country');
                if (sel) {
                    sel.innerHTML = `<option value="">-- SELECT COUNTRY --</option>`;
                    Object.keys(window.curriculumData).sort().forEach(c => {
                        sel.innerHTML += `<option value="${c}">${c}</option>`;
                    });
                }

                // Sticky Restoration
                window.isRestoringCurriculum = true;
                const savedCountry = localStorage.getItem('TM_FORGE_COUNTRY');
                if (savedCountry && window.curriculumData[savedCountry]) {
                    if (sel) sel.value = savedCountry;
                    updateForgeRegions();

                    const savedRegion = localStorage.getItem('TM_FORGE_REGION');
                    const rSel = document.getElementById('f-region');
                    if (savedRegion && window.curriculumData[savedCountry][savedRegion]) {
                        rSel.value = savedRegion;
                        updateForgeCourses();

                        const savedCourse = localStorage.getItem('TM_FORGE_COURSE');
                        const cSel = document.getElementById('f-course');
                        if (savedCourse && window.curriculumData[savedCountry][savedRegion][savedCourse]) {
                            cSel.value = savedCourse;
                            updateForgeOutcomes();
                        }
                    }
                }
                window.isRestoringCurriculum = false;

            } catch (e) {
                log("Curriculum Hub Failure: " + e.message, "error");
            }
        }

        function updateForgeRegions() {
            const country = document.getElementById('f-country').value;
            const rSel = document.getElementById('f-region');
            const cSel = document.getElementById('f-course');
            const outDiv = document.getElementById('f-outcomes');

            if (!window.isRestoringCurriculum) {
                localStorage.setItem('TM_FORGE_COUNTRY', country);
                localStorage.removeItem('TM_FORGE_REGION');
                localStorage.removeItem('TM_FORGE_COURSE');
            }

            rSel.innerHTML = `<option value="">-- SELECT REGION --</option>`;
            cSel.innerHTML = `<option value="">-- SELECT COURSE --</option>`;
            rSel.classList.add('hidden');
            cSel.classList.add('hidden');
            if (outDiv) outDiv.innerHTML = `<p class="text-center opacity-30 text-[0.6rem] py-4">SELECT COURSE TO LOAD OUTCOMES</p>`;

            if (!country || !window.curriculumData[country]) return;

            Object.keys(window.curriculumData[country]).sort().forEach(r => {
                rSel.innerHTML += `<option value="${r}">${r}</option>`;
            });
            rSel.classList.remove('hidden');
        }

        function updateForgeCourses() {
            const country = document.getElementById('f-country').value;
            const region = document.getElementById('f-region').value;
            const cSel = document.getElementById('f-course');

            if (!window.isRestoringCurriculum) {
                localStorage.setItem('TM_FORGE_REGION', region);
                localStorage.removeItem('TM_FORGE_COURSE');
            }

            cSel.innerHTML = `<option value="">-- SELECT COURSE --</option>`;
            cSel.classList.add('hidden');

            if (!region || !window.curriculumData[country][region]) return;

            Object.keys(window.curriculumData[country][region]).sort().forEach(c => {
                cSel.innerHTML += `<option value="${c}">${c}</option>`;
            });
            cSel.classList.remove('hidden');
        }

        function updateForgeOutcomes() {
            const country = document.getElementById('f-country').value;
            const region = document.getElementById('f-region').value;
            const course = document.getElementById('f-course').value;
            const outDiv = document.getElementById('f-outcomes');

            if (!window.isRestoringCurriculum) {
                localStorage.setItem('TM_FORGE_COURSE', course);
            }

            if (!course || !window.curriculumData[country][region][course]) {
                if (outDiv) outDiv.innerHTML = `<p class="text-center opacity-30 text-[0.6rem] py-4">SELECT COURSE TO LOAD OUTCOMES</p>`;
                return;
            }

            const outcomes = window.curriculumData[country][region][course];
            let html = '';
            outcomes.forEach((o, i) => {
                html += `
                <label class="flex gap-2 items-start p-2 hover:bg-base-200 rounded cursor-pointer transition-colors group">
                    <input type="checkbox" value="${o}" class="checkbox checkbox-primary checkbox-xs mt-0.5 outcome-check">
                    <span class="text-[0.7rem] leading-tight opacity-70 group-hover:opacity-100">${o}</span>
                </label>`;
            });
            if (outDiv) outDiv.innerHTML = html;
            log(`Loaded ${outcomes.length} outcomes for ${course}.`, "success");
        }

        // --- CUSTOM COURSE LOGIC ---
        function toggleCustomAdd() {
            const zone = document.getElementById('custom-add-zone');
            zone.classList.toggle('hidden');
        }

        async function saveCustomCourse() {
            const country = document.getElementById('custom-country').value.trim() || "CUSTOM_LAB";
            const region = document.getElementById('custom-region').value.trim() || "LOCAL";
            const name = document.getElementById('custom-course-name').value.trim();
            const raw = document.getElementById('custom-outcomes-raw').value;

            if (!name || !raw) return alert("MISSING PARAMETERS: Course Name and Outcomes are required.");

            const outcomes = raw.split("\n").map(o => o.trim()).filter(o => o.length > 0);

            // Save to LocalStorage
            const custom = JSON.parse(localStorage.getItem('blob_custom_curriculum')) || {};
            if (!custom[country]) custom[country] = {};
            if (!custom[country][region]) custom[country][region] = {};
            custom[country][region][name] = outcomes;
            localStorage.setItem('blob_custom_curriculum', JSON.stringify(custom));

            // Sync to Supabase
            if (SupabaseBridge.client) {
                try {
                    for (const outcome of outcomes) {
                        await SupabaseBridge.saveCustomOutcome(country, region, name, outcome);
                    }
                    log(`Custom Course [${name}] synced to Supabase.`, "success");
                } catch (e) {
                    log(`Sync Error: ${e.message}`, "error");
                }
            }

            alert("Course Saved to Lab. Refreshing curriculum...");
            fetchCurriculum();
        }

        // --- UI HELPERS ---
        function openSettings() {
            console.log("openSettings: Interaction Hook Fired.");
            try {
                const modal = document.getElementById('settings_modal');
                if (!modal) {
                    console.error("openSettings: Modal element 'settings_modal' missing from DOM.");
                    log("CRITICAL: settings_modal element missing.", "error");
                    return;
                }

                const ids = {
                    'cfg-gcp-key': 'TM_GCP_KEY',
                    'cfg-gcp-project': 'TM_GCP_PROJECT',
                    'cfg-gcp-location': 'TM_GCP_LOCATION',
                    'cfg-gcp-model': 'TM_GCP_MODEL',
                    'cfg-gcp-client-id': 'TM_GCP_CLIENT_ID',
                    'cfg-teacher-id': 'TM_TEACHER_HANDLE',
                    'cfg-sb-url': 'TM_SUPABASE_URL',
                    'cfg-sb-key': 'TM_SUPABASE_KEY'
                };

                for (let [id, storageKey] of Object.entries(ids)) {
                    const el = document.getElementById(id);
                    if (el) {
                        let val = localStorage.getItem(storageKey) || '';
                        // Fallbacks for certain fields to match V2 defaults
                        if (!val && storageKey === 'TM_GCP_LOCATION') val = "us-central1";
                        if (!val && storageKey === 'TM_GCP_MODEL') val = "gemini-1.5-flash";
                        if (!val && storageKey === 'TM_GCP_CLIENT_ID') val = "985904065235-u0115ektel546fs42mar5rch46utkki6.apps.googleusercontent.com";

                        el.value = val;
                    }
                    else console.warn(`openSettings: Input field '${id}' missing.`);
                }

                modal.showModal();
                log("Opening System Configuration...");
            } catch (e) {
                console.error("openSettings: Execution Error", e);
                log("Settings Error: " + e.message, "error");
            }
        }

        function saveSettings() {
            try {
                const mappings = {
                    'cfg-gcp-key': 'TM_GCP_KEY',
                    'cfg-gcp-project': 'TM_GCP_PROJECT',
                    'cfg-gcp-location': 'TM_GCP_LOCATION',
                    'cfg-gcp-model': 'TM_GCP_MODEL',
                    'cfg-gcp-client-id': 'TM_GCP_CLIENT_ID',
                    'cfg-teacher-id': 'TM_TEACHER_HANDLE',
                    'cfg-sb-url': 'TM_SUPABASE_URL',
                    'cfg-sb-key': 'TM_SUPABASE_KEY'
                };

                for (let [id, storageKey] of Object.entries(mappings)) {
                    const el = document.getElementById(id);
                    if (el) {
                        let val = el.value.trim();
                        if (storageKey === 'TM_TEACHER_HANDLE') val = val.toUpperCase();
                        localStorage.setItem(storageKey, val);
                    }
                }

                log("Identity & Configuration Uplink Synchronized.", "success");
                alert("Settings Saved. Refreshing to apply cloud credentials.");
                location.reload();
            } catch (e) {
                console.error("saveSettings Error:", e);
                alert("Failed to save settings: " + e.message);
            }
        }

        async function loadMission(id) {
            const mission = currentMissions.find(m => m.id === id);
            if (!mission) return log(`Mission ${id} not found locally.`, 'error');

            if (confirm(`Load mission "${mission.name}" into Forge? Current progress will be overwritten.`)) {
                // Determine phase based on completeness (Mock logic)
                accumulatedData = { metadata: mission, slides: [] };
                forgeHistory = [];
                currentPhaseIndex = 1; // Jump to Narrative as example
                updateForgeUI();
                switchMainTab('forge');
                addForgeChat('ai', `**MISSION LOADED: ${mission.name}**\nResuming architecture sequence at Phase: ${getCurrentPhase().label}.`);
            }
        }

        async function editClassUI(id) {
            const newName = prompt("Enter new Class Name:");
            if (newName) {
                // Stub: await SupabaseBridge.updateClass...
                log(`Class ${id} renamed to ${newName} (Stub).`, 'success');
                refreshClasses();
            }
        }

        async function deleteClassUI(id) {
            if (confirm("Delete this class?")) {
                // Stub: await SupabaseBridge.deleteClass...
                log(`Class ${id} deleted (Stub).`, 'warning');
            }
        }

        function manageStudentsUI(passcode) {
            alert(`Student Management for [${passcode}] is under construction in V3.\nPlease use the Legacy Dashboard for roster edits.`);
        }

        // --- PAGE INITIALIZATION ---
        window.onload = () => {
            // Initialize Supabase Bridge
            if (typeof SupabaseBridge !== 'undefined' && SB_URL && SB_KEY) {
                const connected = SupabaseBridge.init(SB_URL, SB_KEY);
                if (connected) {
                    const badge = document.getElementById('status-badge-sb');
                    if (badge) {
                        badge.innerHTML = `<div class="w-1.5 h-1.5 rounded-full bg-success"></div> SB_ONLINE`;
                        badge.classList.remove('badge-outline');
                        badge.classList.add('badge-success', 'text-white');
                    }
                    log("Supabase Uplink Established.", "success");
                }
            }

            updateForgeUI();
            log("Command Center v3.0 Initialized.");
            refreshClasses();
            fetchMissions();
            fetchCurriculum();
        };
    </script>



</body>

</html>