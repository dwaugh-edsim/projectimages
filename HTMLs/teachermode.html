<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>SITUATION ROOM // COMMAND CENTER</title>
    <!-- Tailwind CSS + DaisyUI via CDN -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Oswald:wght@700&display=swap"
        rel="stylesheet">
    <link rel="icon" type="image/png" href="images/logic_gear_logo.png">

    <!-- SYSTEM SCRIPTS -->
    <script src="config.js"></script>
    <script>
        // --- BOOTSTRAP CONFIGURATION (Global Infrastructure) ---
        const SB_URL = "https://zwujpkuguevnkcqrkhas.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp3dWpwa3VndWV2bmtjcXJraGFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczODA0NDQsImV4cCI6MjA4Mjk1NjQ0NH0.H9tVz_expVsE7VLLLLEsnTMVsm5PQ09r7KlLe85MirA";
        const TEACHER_HANDLE = localStorage.getItem('TM_TEACHER_HANDLE') || (typeof CONFIG !== 'undefined' ? CONFIG.TEACHER_ID : 'DWAUGH');
        let GOOGLE_CLIENT_ID = localStorage.getItem('TM_GCP_CLIENT_ID') || "985904065235-u0115ektel546fs42mar5rch46utkki6.apps.googleusercontent.com";
        const HARDWIRED_PROXY = "https://nextjs-basic-lemon-one.vercel.app/api/chat";
    </script>
    <script src="critical_crypto.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Quill Rich Text Editor (Legacy Port) -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script src="https://unpkg.com/turndown/dist/turndown.js"></script>
    <script src="supabase_bridge.js"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .font-display {
            font-family: 'Oswald', sans-serif;
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Legacy Scrollbar Patch */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0f0f0f;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Smooth Tabs Transition */
        .tab-content {
            transition: all 0.2s ease-in-out;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
    </style>
</head>

<body class="min-h-screen bg-base-300 text-base-content overflow-hidden flex flex-col">

    <!-- TOP NAVBAR -->
    <div class="navbar bg-base-100 border-b border-base-content/10 px-4 h-16 flex-none z-50 shadow-md">
        <div class="flex-1 gap-4">
            <div class="flex items-center gap-3">
                <img src="images/logic_gear_logo.png" class="h-8 w-8 drop-shadow-[0_0_5px_rgba(0,255,204,0.5)]">
                <div>
                    <h1 class="text-xl font-display tracking-widest text-primary leading-none">SITUATION ROOM</h1>
                    <button
                        class="btn btn-xs btn-ghost text-[0.6rem] font-mono opacity-50 tracking-widest hover:opacity-100"
                        onclick="openSettings()">COMMAND CENTER v3.0 // CONFIG</button>
                </div>
            </div>
            <div class="divider divider-horizontal mx-0"></div>

            <!-- GLOBAL STATUS BADGES -->
            <div class="flex gap-2">
                <div id="status-badge-sb" class="badge badge-outline badge-xs gap-1 font-mono">
                    <div class="w-1.5 h-1.5 rounded-full bg-error"></div> SB_OFFLINE
                </div>
                <div id="status-badge-auth" class="badge badge-outline badge-xs gap-1 font-mono opacity-50">
                    GUEST
                </div>
            </div>
        </div>

        <div class="flex-none gap-2">
            <!-- SETTINGS BTN -->
            <button class="btn btn-ghost btn-circle btn-sm" onclick="openSettings()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </button>
            <div class="dropdown dropdown-end">
                <div tabindex="0" role="button" class="btn btn-ghost btn-circle avatar placeholder">
                    <div class="bg-neutral text-neutral-content rounded-full w-8">
                        <span id="user-avatar-initials">G</span>
                    </div>
                </div>
                <ul tabindex="0"
                    class="menu menu-sm dropdown-content mt-3 z-[1] p-2 shadow bg-base-100 rounded-box w-52">
                    <li><a onclick="openAuthModal()">Verify Identity</a></li>
                    <li><a onclick="toggleAboutModal()">About System</a></li>
                    <li><a onclick="document.documentElement.setAttribute('data-theme', 'light')">Light Mode</a></li>
                    <li><a onclick="document.documentElement.setAttribute('data-theme', 'dark')">Dark Mode</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- MAIN APP SHELL -->
    <div class="flex-1 flex overflow-hidden">

        <!-- SIDEBAR NAVIGATION -->
        <div class="w-64 bg-base-200 border-r border-base-content/10 flex flex-col p-4 gap-2">

            <!-- Navigation Menu -->
            <ul class="menu bg-base-100 w-full rounded-box gap-1">
                <li>
                    <a class="active font-bold" onclick="switchMainTab('dashboard')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                        </svg>
                        Dashboard
                    </a>
                </li>
                <li>
                    <a class="font-bold" onclick="switchMainTab('forge')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                        </svg>
                        Mission Forge
                    </a>
                </li>
                <li>
                    <a class="font-bold" onclick="switchMainTab('classes')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                        Class Directory
                    </a>
                </li>
                <li>
                    <a class="font-bold" onclick="switchMainTab('library')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z" />
                        </svg>
                        Library
                    </a>
                </li>
            </ul>

            <div class="divider my-2"></div>

            <!-- System Console Status -->
            <div id="log-parent"
                class="card bg-base-300 shadow-inner flex-1 overflow-hidden flex flex-col transition-all duration-300 ease-in-out">
                <div
                    class="px-3 py-2 bg-base-content/5 text-[0.65rem] font-bold opacity-50 uppercase tracking-wider flex justify-between items-center">
                    <span>System Log</span>
                    <div class="flex gap-2">
                        <button class="hover:text-primary transition-colors" onclick="toggleSystemLog()"
                            id="log-toggle-btn">SHRINK</button>
                        <button class="hover:text-primary transition-colors"
                            onclick="window.location.reload()">REBOOT</button>
                    </div>
                </div>
                <div id="sm-console"
                    class="p-2 font-mono text-[0.6rem] overflow-y-auto flex-1 leading-relaxed opacity-70">
                    <div class="text-success">> SYSTEM INIT...</div>
                </div>
            </div>

        </div>

        <!-- MAIN CONTENT AREA -->
        <div class="flex-1 bg-base-300 p-6 overflow-y-auto relative" id="main-scroll-area">

            <!-- VIEW: DASHBOARD -->
            <div id="view-dashboard" class="space-y-6 max-w-7xl mx-auto tab-view">

                <!-- Quick Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="stat bg-base-100 shadow rounded-box border border-base-content/5">
                        <div class="stat-figure text-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                class="inline-block w-8 h-8 stroke-current">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </div>
                        <div class="stat-title font-display tracking-wide">Active Missions</div>
                        <div class="stat-value text-primary" id="dash-stat-missions">--</div>
                        <div class="stat-desc">Ready to deploy</div>
                    </div>

                    <div class="stat bg-base-100 shadow rounded-box border border-base-content/5">
                        <div class="stat-figure text-secondary">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                class="inline-block w-8 h-8 stroke-current">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z">
                                </path>
                            </svg>
                        </div>
                        <div class="stat-title font-display tracking-wide">Students</div>
                        <div class="stat-value text-secondary" id="dash-stat-students">--</div>
                        <div class="stat-desc">Registered seats</div>
                    </div>

                    <div class="stat bg-base-100 shadow rounded-box border border-base-content/5">
                        <div class="stat-figure text-accent">
                            <div class="radial-progress bg-base-200 text-accent border-4 border-base-200"
                                style="--value:70; --size:2.5rem;" role="progressbar">70%</div>
                        </div>
                        <div class="stat-title font-display tracking-wide">Sync Status</div>
                        <div class="stat-value text-accent" id="dash-stat-sync">ONLINE</div>
                        <div class="stat-desc">Database connected</div>
                    </div>
                </div>

                <!-- Action Cards -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Create Card -->
                    <div class="card bg-base-100 shadow-xl image-full h-64 group cursor-pointer transition-all hover:scale-[1.01]"
                        onclick="switchMainTab('forge')">
                        <figure><img
                                src="https://images.unsplash.com/photo-1451187580459-43490279c0fa?w=800&auto=format&fit=crop"
                                class="opacity-40 group-hover:opacity-60 transition-opacity" alt="Space" /></figure>
                        <div class="card-body justify-end">
                            <h2 class="card-title text-3xl font-display tracking-wider text-base-100 mix-blend-overlay">
                                MISSION FORGE</h2>
                            <p class="grow-0 text-base-200/80">Launch the AI Architect to build custom scenarios.</p>
                            <div class="card-actions justify-end">
                                <button class="btn btn-primary gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                    </svg>
                                    Initialize New Forge
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Manage Card -->
                    <div class="card bg-base-100 shadow-xl border border-base-content/10 h-64">
                        <div class="card-body">
                            <h2 class="card-title font-display tracking-wide">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-secondary" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                                </svg>
                                Recent Activity
                            </h2>
                            <div class="overflow-y-auto flex-1 -mx-4 px-4">
                                <ul class="timeline timeline-vertical timeline-compact timeline-snap-icon w-full">
                                    <li>
                                        <hr class="bg-primary" />
                                        <div class="timeline-middle">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                                                fill="currentColor" class="h-5 w-5 text-primary">
                                                <path fill-rule="evenodd"
                                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z"
                                                    clip-rule="evenodd" />
                                            </svg>
                                        </div>
                                        <div class="timeline-end mb-2">
                                            <time class="font-mono italic text-xs opacity-50">Just now</time>
                                            <div class="text-sm font-bold text-base-content">System Ready</div>
                                            <div class="text-xs opacity-70">Dashboard initialized successfully.</div>
                                        </div>
                                        <hr />
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: FORGE (Placeholder for Logic Transplant) -->
            <div id="view-forge" class="hidden tab-view h-full flex flex-col">
                <!-- Forge Header -->
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-display tracking-widest text-primary flex items-center gap-2">
                            MISSION FORGE
                            <div class="badge badge-warning badge-sm font-mono align-top animate-pulse">AI ALPHA</div>
                        </h2>
                        <p class="text-sm opacity-60">Modular Mission Construction Pipeline</p>
                    </div>
                    <!-- Pipeline Stepper Container (matches Logic ID) -->
                    <div id="pipeline-stepper" class="steps">
                        <!-- Injected by JS -->
                    </div>
                </div>

                <!-- Forge Main Area -->
                <div
                    class="bg-base-100 rounded-xl shadow-xl border border-base-content/10 overflow-hidden relative flex h-[max(600px,calc(100vh-250px))]">

                    <!-- Forge Panel (Inputs) -->
                    <div id="forge-panel"
                        class="w-1/3 border-r border-base-content/10 p-6 flex flex-col gap-4 overflow-y-auto bg-base-200/50">
                        <div class="flex justify-between items-end">
                            <span class="text-xs font-bold tracking-widest text-primary">CURRENT PHASE</span>
                            <button class="btn btn-ghost btn-xs" onclick="resetForge()">RESET</button>
                            <button class="btn btn-ghost btn-xs" onclick="saveIdea()">SAVE</button>
                            <button class="btn btn-ghost btn-xs" onclick="openIdeaLoader()">LOAD</button>
                            <button class="btn btn-secondary btn-outline btn-xs gap-1" onclick="openHospital()">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path
                                        d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                                    <path fill-rule="evenodd"
                                        d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"
                                        clip-rule="evenodd" />
                                </svg>
                                WORKSHOP
                            </button>
                        </div>
                        <h2 id="forge-title" class="text-3xl font-display uppercase leading-tight">INITIALIZING...</h2>
                        <p id="forge-desc" class="text-sm opacity-70 mb-4">Establishing secure connection to neural
                            core...</p>

                        <!-- Dynamic Input Zones -->
                        <div id="curriculum-zone" class="card bg-base-100 border border-base-300 p-4 shadow-sm text-sm">
                            <div class="flex justify-between mb-2">
                                <span class="font-bold text-xs uppercase opacity-50">Context Hooks</span>
                            </div>
                            <!-- Selects (IDs match old logic) -->
                            <select id="f-country" class="select select-bordered select-xs w-full mb-2"
                                onchange="updateForgeRegions()">
                                <option value="">Select Country...</option>
                            </select>
                            <select id="f-region" class="select select-bordered select-xs w-full mb-2 hidden"
                                onchange="updateForgeCourses()"></select>
                            <select id="f-course" class="select select-bordered select-xs w-full mb-2 hidden"
                                onchange="updateForgeOutcomes()"></select>

                            <div class="divider text-[0.6rem] opacity-30 my-1">FORGE MODEL</div>
                            <select id="f-model" class="select select-bordered select-xs w-full mb-2">
                                <option value="xiaomi/mimo-v2-flash:free">Xiaomi MiMo V2 (China)</option>
                                <option value="google/gemini-2.0-flash-exp:free" selected>Gemini 2.0 Flash (Exp)
                                </option>
                                <option value="mistralai/devstral-2512:free">Mistral 2512 (France)</option>
                                <option value="nvidia/nemotron-nano-9b-v2:free">Nemotron Nano (US)</option>
                                <option value="meta-llama/llama-3.2-3b-instruct:free">Llama 3.2 3B (US)</option>
                            </select>

                            <div class="divider text-[0.6rem] opacity-30 my-1">TARGET OUTCOMES</div>
                            <div id="f-outcomes" class="max-h-40 overflow-y-auto space-y-1 pr-2 custom-scrollbar">
                                <p class="text-center opacity-30 text-[0.6rem] py-4">SELECT COURSE TO LOAD OUTCOMES</p>
                            </div>

                            <!-- Custom Add Lab (Legacy Port) -->
                            <div id="custom-add-zone" class="mt-4 pt-4 border-t border-base-content/10 hidden">
                                <div class="space-y-2">
                                    <input id="custom-country" type="text" placeholder="COUNTRY (e.g. Canada)"
                                        class="input input-bordered input-xs w-full">
                                    <input id="custom-region" type="text" placeholder="REGION (e.g. Ontario)"
                                        class="input input-bordered input-xs w-full">
                                    <input id="custom-course-name" type="text" placeholder="COURSE NAME"
                                        class="input input-bordered input-xs w-full">
                                    <textarea id="custom-outcomes-raw" placeholder="OUTCOMES (ONE PER LINE)"
                                        class="textarea textarea-bordered textarea-xs w-full h-20"></textarea>
                                    <button class="btn btn-xs btn-primary w-full" onclick="saveCustomCourse()">SAVE TO
                                        LOCAL LAB</button>
                                </div>
                            </div>
                            <div class="text-center mt-2">
                                <button id="custom-toggle-btn" onclick="toggleCustomAdd()"
                                    class="btn btn-link btn-xs no-underline opacity-50 hover:opacity-100">+ ADD CUSTOM
                                    COURSE</button>
                            </div>
                        </div>

                        <div class="form-control flex-1">
                            <textarea id="f-input"
                                class="textarea textarea-bordered h-full font-mono text-sm leading-relaxed"
                                placeholder="Enter command context..."></textarea>
                        </div>

                        <div class="flex flex-wrap gap-2 mt-auto">
                            <button class="btn btn-neutral btn-sm flex-1" onclick="forgeBack()">Back</button>
                            <button id="f-submit" class="btn btn-primary btn-sm flex-1" onclick="processForge()">Submit
                                Command</button>
                            <button id="f-next-phase" class="btn btn-success btn-sm flex-1 gap-1"
                                onclick="advancePhase()">
                                Authorize Next â†’
                            </button>
                        </div>
                    </div>

                    <!-- Forge Output (Chat) -->
                    <div id="forge-output" class="flex-1 bg-base-100 relative flex flex-col">
                        <div id="forge-chat" class="flex-1 p-6 overflow-y-auto space-y-4">
                            <div class="chat chat-start">
                                <div class="chat-image avatar placeholder">
                                    <div class="w-10 rounded-full bg-neutral text-neutral-content">
                                        <span>AI</span>
                                    </div>
                                </div>
                                <div class="chat-bubble chat-bubble-primary font-mono text-sm">
                                    <strong>CREATE SYSTEM ONLINE.</strong><br>
                                    Welcome to the V2 Forge integration. Select your curriculum context to begin.
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- VIEW: CLASS DIRECTORY -->
            <div id="view-classes" class="hidden tab-view max-w-7xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-display tracking-widest text-secondary">CLASS DIRECTORY</h2>
                        <p class="text-sm opacity-60" id="class-count-header">Manage student cohorts and assigned
                            missions.</p>
                    </div>
                    <button class="btn btn-secondary gap-2" onclick="registerClass()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        New Class
                    </button>
                </div>

                <div class="card bg-base-100 shadow-xl border border-base-content/10">
                    <div class="overflow-x-auto">
                        <table class="table table-zebra w-full" id="class-table-v3">
                            <thead>
                                <tr class="bg-base-200 uppercase text-xs font-bold tracking-wider opacity-70">
                                    <th>Class Name</th>
                                    <th>Access Code</th>
                                    <th>Students</th>
                                    <th>Missions</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="class-directory-list-body">
                                <!-- JS Injects Rows Here -->
                                <tr>
                                    <td colspan="5" class="text-center py-8 opacity-50">Loading class registry...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW: LIBRARY -->
            <div id="view-library" class="hidden tab-view max-w-7xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-display tracking-widest text-accent">MISSION LIBRARY</h2>
                        <p class="text-sm opacity-60">Archive of all generated and deployed simulations.</p>
                    </div>
                    <div class="flex gap-2">
                        <button class="btn btn-outline btn-sm" onclick="fetchMissions()">Refresh</button>
                        <button class="btn btn-accent btn-sm gap-2"
                            onclick="document.getElementById('file-input').click()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                            </svg>
                            Upload .BLOB
                        </button>
                        <input type="file" id="file-input" accept=".blob" class="hidden"
                            onchange="handleFile(this.files[0])">
                    </div>
                </div>

                <div id="hub-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- JS Injects Mission Cards Here -->
                </div>
            </div>

        </div>
    </div>

    <!-- Hidden Modals (DaisyUI Format) -->

    <!-- SETTINGS MODAL -->
    <dialog id="settings_modal" class="modal">
        <div class="modal-box bg-base-100 border border-base-content/10">
            <div class="space-y-4">
                <div class="form-control">
                    <label class="label"><span
                            class="label-text text-xs font-bold opacity-70 text-success uppercase tracking-widest">Global
                            AI Proxy (Hardwired)</span></label>
                    <div
                        class="bg-black/20 p-2 rounded border border-white/5 font-mono text-[10px] opacity-60 truncate">
                        https://nextjs-basic-lemon-one.vercel.app/api/chat
                    </div>
                </div>

                <div class="divider text-xs opacity-50">CLARK DIRECT (BACKUP)</div>

                <div class="form-control">
                    <label class="label"><span class="label-text text-xs font-bold opacity-70">GOOGLE CLOUD API KEY
                            (Gemini)</span></label>
                    <input type="password" id="cfg-gcp-key"
                        class="input input-bordered input-sm font-mono tracking-widest text-xs" placeholder="AIZA...">
                </div>

                <div class="form-control">
                    <label class="label"><span class="label-text text-xs font-bold opacity-70">GCP PROJECT
                            ID</span></label>
                    <input type="text" id="cfg-gcp-project" class="input input-bordered input-sm font-mono text-xs"
                        placeholder="my-project-123">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div class="form-control">
                        <label class="label"><span
                                class="label-text text-xs font-bold opacity-70">LOCATION</span></label>
                        <input type="text" id="cfg-gcp-location" class="input input-bordered input-sm font-mono text-xs"
                            placeholder="us-central1">
                    </div>
                    <div class="form-control">
                        <label class="label"><span class="label-text text-xs font-bold opacity-70">MODEL</span></label>
                        <input type="text" id="cfg-gcp-model" class="input input-bordered input-sm font-mono text-xs"
                            placeholder="gemini-1.5-flash">
                    </div>
                </div>

                <div class="divider text-xs opacity-50">IDENTITY & DATABASE</div>

                <div class="form-control">
                    <label class="label"><span class="label-text text-xs font-bold opacity-70">TEACHER HANDLE
                            (ID)</span></label>
                    <input type="text" id="cfg-teacher-id"
                        class="input input-bordered input-sm font-mono text-xs uppercase" placeholder="SMITH_01">
                </div>

                <div class="divider text-xs opacity-50 uppercase">Global Data Link</div>
                <div class="form-control">
                    <label class="label"><span class="label-text text-xs font-bold opacity-70">SUPABASE
                            UPLINK</span></label>
                    <div class="bg-black/20 p-2 rounded border border-white/5 font-mono text-[10px] opacity-60">
                        https://zwujpkuguevnkcqrkhas...
                    </div>
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text text-xs font-bold opacity-70">GCP CLIENT ID
                            (Auth)</span></label>
                    <input type="text" id="cfg-gcp-client-id" class="input input-bordered input-sm font-mono text-xs"
                        placeholder="9859...apps.googleusercontent.com">
                </div>
            </div>

            <div class="modal-action">
                <button class="btn btn-ghost btn-sm"
                    onclick="document.getElementById('settings_modal').close()">Cancel</button>
                <button class="btn btn-primary btn-sm" onclick="saveSettings()">SAVE CONFIG</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <!-- AUTH MODAL -->
    <dialog id="auth_modal" class="modal modal-bottom sm:modal-middle">
        <div class="modal-box bg-base-100 border border-primary/20">
            <h3 class="font-bold text-lg font-display text-primary tracking-widest text-center mb-4">IDENTITY
                VERIFICATION</h3>
            <div id="google-signin-container" class="flex justify-center my-4"></div>
            <p class="py-4 text-center text-xs opacity-60">Secure Teacher Access Required</p>
        </div>
    </dialog>

    <!-- HOSPITAL MODAL (Node Editor) -->
    <dialog id="hospital_modal" class="modal modal-bottom sm:modal-middle">
        <div
            class="modal-box w-11/12 max-w-7xl h-[90vh] bg-base-100 border border-secondary/20 p-0 flex flex-col overflow-hidden">
            <!-- Modal Header -->
            <div class="bg-base-200 px-6 py-4 border-b border-base-content/10 flex justify-between items-center">
                <h3 class="font-bold text-lg font-display tracking-widest text-secondary flex items-center gap-2">
                    MISSION HOSPITAL <span class="badge badge-outline badge-xs font-mono opacity-50">SURGICAL
                        THEATER</span>
                </h3>
                <div class="flex gap-2">
                    <button class="btn btn-sm btn-ghost" onclick="closeHospital()">CANCEL</button>
                    <button class="btn btn-sm btn-secondary" onclick="saveHospitalChanges()">SAVE CHANGES</button>
                </div>
            </div>

            <!-- Modal Body -->
            <div class="flex-1 flex overflow-hidden">
                <!-- Slide List Sidebar -->
                <div class="w-64 bg-base-200/50 border-r border-base-content/10 overflow-y-auto p-4 space-y-1"
                    id="h-slide-list">
                    <!-- Injected JS -->
                </div>

                <!-- Main Surgical Area -->
                <div class="flex-1 flex overflow-hidden" id="h-surgical-area">
                    <!-- Left: Visual Monitor -->
                    <div
                        class="w-1/3 border-r border-base-content/10 flex flex-col p-4 space-y-4 overflow-y-auto bg-black/10">
                        <div class="text-[10px] font-bold text-secondary tracking-widest uppercase opacity-50">Visual
                            Sensor Feed</div>
                        <div id="h-visual-preview"
                            class="bg-black/40 rounded border border-white/5 aspect-video flex items-center justify-center overflow-hidden">
                            <span class="text-xs opacity-20 font-mono">NO SIGNAL</span>
                        </div>
                        <div class="space-y-3">
                            <div class="form-control">
                                <label class="label py-1"><span
                                        class="label-text-alt text-[10px] font-bold opacity-50 uppercase">Slide
                                        Title</span></label>
                                <input type="text" id="h-title" class="input input-bordered input-sm font-display"
                                    placeholder="Node Title">
                            </div>
                            <div class="form-control">
                                <label class="label py-1"><span
                                        class="label-text-alt text-[10px] font-bold opacity-50 uppercase">Media URL
                                        (IMG/YT/PDF)</span></label>
                                <input type="text" id="h-media-url"
                                    class="input input-bordered input-sm font-mono text-[10px]"
                                    onchange="updateHospitalPreview(this.value)">
                            </div>
                            <div class="form-control">
                                <label class="label py-1"><span
                                        class="label-text-alt text-[10px] font-bold opacity-50 uppercase">Visual Prompt
                                        (AI Reference)</span></label>
                                <textarea id="h-visual-prompt"
                                    class="textarea textarea-bordered h-20 font-mono text-xs"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Narrative Input (Quill) -->
                    <div class="flex-1 flex flex-col overflow-hidden">
                        <!-- Tab Navigation -->
                        <div class="flex bg-base-300/50 p-1 gap-1 border-b border-base-content/10" id="h-tabs-nav">
                            <!-- Injected JS Tabs -->
                        </div>

                        <div class="flex-1 flex flex-col overflow-hidden bg-base-100">
                            <div id="quill-editor" class="flex-1 overflow-y-auto"></div>
                        </div>

                        <!-- Footer metadata -->
                        <div
                            class="bg-base-200 p-2 flex justify-between items-center text-[10px] font-mono opacity-50 border-t border-base-content/10">
                            <div>PATH: <span id="h-path">SLIDE -> CONTENT</span></div>
                            <div class="flex gap-4">
                                <div>DECISION A: <input type="text" id="h-choice-a"
                                        class="bg-transparent border-b border-white/10 outline-none w-24"></div>
                                <div>DECISION B: <input type="text" id="h-choice-b"
                                        class="bg-transparent border-b border-white/10 outline-none w-24"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <!-- INTEL MODAL (Narrative Viewer) -->
    <dialog id="intel_modal" class="modal">
        <div class="modal-box bg-base-100 border border-primary/20 max-w-2xl">
            <h3 id="intel-modal-title"
                class="font-bold text-lg font-display text-primary tracking-widest mb-4 uppercase">SLIDE INTEL</h3>
            <div id="intel-modal-content"
                class="prose prose-sm font-mono text-sm leading-relaxed max-h-[60vh] overflow-y-auto bg-black/20 p-4 rounded border border-white/5">
                <!-- Injected content -->
            </div>
            <div class="modal-action">
                <form method="dialog">
                    <button class="btn btn-sm btn-ghost">CLOSE</button>
                </form>
            </div>
        </div>
    </dialog>

    <script>
        // --- INTEL VIEWER LOGIC ---
        function openIntelModal(slideIdx) {
            const slide = accumulatedData.slides[slideIdx];
            if (!slide) return;

            const modal = document.getElementById('intel_modal');
            const title = document.getElementById('intel-modal-title');
            const content = document.getElementById('intel-modal-content');

            const slideTitle = slide.title || slide.shortTitle || `Slide ${slideIdx + 1}`;
            title.innerText = `INTEL: ${slideTitle.toUpperCase()}`;

            // Show content, prefer tabs.primary.content then brief/content
            const fullContent = slide.tabs?.primary?.content || slide.content || slide.brief || "*NO NARRATIVE DATA DETECTED*";
            content.innerHTML = (typeof marked !== 'undefined') ? marked.parse(fullContent) : fullContent;

            modal.showModal();
        }

        // --- UX GLUE CODE (V3) ---

        function switchMainTab(tabName) {
            // Hide all views
            document.querySelectorAll('.tab-view').forEach(el => el.classList.add('hidden'));

            // Show target
            document.getElementById(`view-${tabName}`).classList.remove('hidden');

            // Update Sidebar Active State
            document.querySelectorAll('.menu a').forEach(el => el.classList.remove('active'));
            // (Simplified: In prod, map tabName to index or specific ID)
        }

        function log(msg, type = 'info') {
            const c = document.getElementById('sm-console');
            const time = new Date().toLocaleTimeString();
            let color = 'text-base-content';
            if (type === 'error') color = 'text-error';
            if (type === 'success') color = 'text-success';
            if (type === 'warning') color = 'text-warning';

            c.innerHTML += `<div class="${color} hover:bg-base-content/5 px-1 rounded font-mono">> [${time}] ${msg}</div>`;
            c.scrollTop = c.scrollHeight;
        }

        function toggleSystemLog() {
            const parent = document.getElementById('log-parent');
            const console = document.getElementById('sm-console');
            const btn = document.getElementById('log-toggle-btn');
            const isShrunk = parent.classList.contains('flex-none');

            if (isShrunk) {
                parent.classList.remove('flex-none', 'h-10');
                parent.classList.add('flex-1');
                console.classList.remove('hidden');
                btn.innerText = 'SHRINK';
            } else {
                parent.classList.remove('flex-1');
                parent.classList.add('flex-none', 'h-10');
                console.classList.add('hidden');
                btn.innerText = 'EXPAND';
            }
        }

        // Overwrite legacy Alert logic with DaisyUI Toasts (if we had them implemented fully, for now just custom log)
        // window.alert = function(msg) { log(`ALERT: ${msg}`, 'warning'); }
    </script>

    <!-- CORE LOGIC TRANSPLANT -->
    <script>
        // --- GLOBAL STATE ---
        let googleUser = null;
        let accumulatedData = {
            metadata: {},
            slides: [],
            intelligenceGlossary: {},
            aiPromptsExtracted: false
        };
        let currentMissions = [];
        let allProgress = [];

        // --- FORGE PIPELINE CONFIG ---
        const FORGE_PHASES = {
            'brainstorm': { id: 'brainstorm', title: "MISSION BRAINSTORM", label: "INTEL", desc: "Define core learning objectives and scenario parameters.", prompt: "Analyze the requested curriculum parameters. Suggest 3 distinct, high-stakes mission scenarios that fit the topic. Focus on 'Situation Room' style dilemmas." },
            'research': { id: 'research', title: "DEEP SEARCH INTEL", label: "RESEARCH", desc: "Gather real-world context and source material.", prompt: "Identify key historical or geopolitical events relevant to the chosen scenario. Suggest search queries." },
            'narrative': { id: 'narrative', title: "NARRATIVE ARCHITECTURE", label: "BRIEF", desc: "Structuring the mission beat-sheet.", prompt: "Develop the chosen scenario into a 10-slide beat sheet. SLIDE 1: Briefing, SLIDES 2-9: Incidents/Intel, SLIDE 10: Final Decision." },
            'assets': { id: 'assets', title: "VISUAL ASSETS", label: "VISUALS", desc: "Generating field imagery and evidence.", prompt: "Suggest image prompts for each slide. Focus on 'satellite view', 'CCTV footage', 'classified documents', and 'tactical maps'." },
            'deploy': { id: 'deploy', title: "FINAL ASSEMBLY", label: "DEPLOY", desc: "Compile and publish mission dossier.", prompt: "Finalize the JSON structure." }
        };

        const FORGE_SYSTEM_CORE = `YOU ARE 'MOTHER', THE CENTRAL INTELLIGENCE ARCHITECT.
Your goal is to build immersive, high-stakes educational simulations ("Missions") for students.
Tone: Professional, urgent, military/intelligence aesthetic.
Output: Structured, concise, decisive.
Format: Use Markdown. Heavy use of **bold** for key terms.`;

        let forgePipeline = ['brainstorm', 'research', 'narrative', 'assets', 'deploy'];
        let currentPhaseIndex = 0;
        let forgeHistory = [];

        // --- PROXY CONFIG ---
        // Placeholder for direct AI calls. Real implementation would likely use `callGoogleImageAPI` or similar structure from original file.
        // For V3 v1.0, we will assume the environment provides a 'callAI' or similar, or we replicate the fetch logic.

        function getCurrentPhase() {
            const phaseId = forgePipeline[currentPhaseIndex];
            return FORGE_PHASES[phaseId];
        }

        // --- FORGE RENDER LOGIC (DAISYUI V3) ---
        function renderPipelineStepper() {
            const container = document.getElementById('pipeline-stepper');
            if (!container) return;

            let html = '';
            forgePipeline.forEach((phaseId, index) => {
                const phase = FORGE_PHASES[phaseId];
                // Status Logic: 'step-primary' for completed/current
                let statusClass = (index <= currentPhaseIndex) ? 'step-primary' : '';

                let badgeHtml = '';
                if (phaseId === 'narrative' && accumulatedData?.slides?.length > 0) {
                    badgeHtml = ` <div class="badge badge-accent badge-xs border-none font-bold">${accumulatedData.slides.length}</div>`;
                }

                // DaisyUI Step Item
                html += `<li class="step ${statusClass} text-[0.6rem] font-bold tracking-wider" data-content="${index + 1}">${phase.label}${badgeHtml}</li>`;
            });

            container.innerHTML = html;
        }

        function updateForgeUI() {
            const phase = getCurrentPhase();

            // 1. Update Header Info
            const titleEl = document.getElementById('forge-title');
            const descEl = document.getElementById('forge-desc');
            const submitBtn = document.getElementById('f-submit');
            const inputEl = document.getElementById('f-input');

            if (titleEl) titleEl.innerText = phase.title;
            if (descEl) descEl.innerText = phase.desc;

            // Special Handling for Deep Search & Assets
            const outputArea = document.getElementById('forge-output');
            if (phase.id === 'research' || phase.id === 'deepsearch') {
                renderDeepSearch(outputArea);
            } else if (phase.id === 'assets') {
                renderAssetsScreen(outputArea);
            } else if (phase.id === 'deploy') {
                renderBirthScreen(outputArea);
            } else {
                // Restore Chat View if not already there
                if (!document.getElementById('forge-chat')) {
                    outputArea.innerHTML = `<div id="forge-chat" class="flex-1 p-6 overflow-y-auto space-y-4"></div>`;
                    // Restore history
                    forgeHistory.forEach(h => addForgeChat(h.role, h.content));
                }
            }

            // 2. Button State
            if (submitBtn) {
                if (phase.id === 'deploy') {
                    submitBtn.innerText = "DEPLOY MISSION";
                    submitBtn.classList.add('btn-warning');
                    submitBtn.onclick = deployMission;
                } else {
                    submitBtn.innerText = "SUBMIT COMMAND";
                    submitBtn.classList.remove('btn-warning');
                    submitBtn.onclick = processForge;
                }
            }

            // 3. Input Placeholder
            if (inputEl) {
                inputEl.placeholder = `Enter orders for ${phase.label} phase...`;
            }

            // 4. Update Visual Stepper
            renderPipelineStepper();

            // 5. Scroll Chat
            const chat = document.getElementById('forge-chat');
            if (chat) chat.scrollTop = chat.scrollHeight;

            log(`Forge UI Updated: Phase ${currentPhaseIndex + 1}/${forgePipeline.length} [${phase.label}]`);
        }

        function addForgeChat(role, message, options = {}) {
            const chat = document.getElementById('forge-chat');
            if (!chat) return;
            const isAI = role === 'ai' || role === 'assistant';
            const bubbleClass = isAI ? 'chat-bubble-primary' : 'chat-bubble-neutral';
            const alignClass = isAI ? 'chat-start' : 'chat-end';
            const avatarTxt = isAI ? 'AI' : 'OP';
            const avatarBg = isAI ? 'bg-primary text-primary-content' : 'bg-neutral text-neutral-content';

            // Parse Markdown (using marked.js if available, else text)
            const htmlContent = (typeof marked !== 'undefined') ? marked.parse(message) : message;

            let nextBtnHtml = '';
            if (options.showNextPhaseButton) {
                nextBtnHtml = `
                    <div class="mt-4 flex justify-end">
                        <button class="btn btn-xs btn-outline btn-success gap-1 border-white/20 hover:border-white/40" onclick="advancePhase()">
                            AUTHORIZE NEXT PHASE â†’
                        </button>
                    </div>
                `;
            }

            const html = `
            <div class="chat ${alignClass} animate-fade-in">
                <div class="chat-image avatar placeholder">
                    <div class="w-8 rounded-full ${avatarBg}">
                        <span class="text-xs">${avatarTxt}</span>
                    </div>
                </div>
                <div class="chat-bubble ${bubbleClass} text-sm font-mono leading-relaxed shadow-md">
                    ${htmlContent}
                    ${nextBtnHtml}
                </div>
                <div class="chat-footer opacity-50 text-[0.6rem] mt-1">
                    ${new Date().toLocaleTimeString()}
                </div>
            </div>`;
            chat.insertAdjacentHTML('beforeend', html);
            chat.scrollTop = chat.scrollHeight;
        }

        // --- DEEP SEARCH LOGIC (Restored) ---
        function renderDeepSearch(container) {
            container.innerHTML = `
                <div class="h-full flex flex-col p-6 bg-base-100 gap-6 overflow-y-auto">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 flex-1">
                        <!-- Setup Panel -->
                        <div class="card bg-base-200 shadow-md border border-base-content/10 flex flex-col">
                            <div class="card-body p-4 flex flex-col gap-4">
                                <h3 class="card-title text-xs font-bold text-secondary tracking-widest uppercase">Research Target</h3>
                                <p class="text-[10px] opacity-60">AI will generate a tailored prompt for Gemini Deep Research based on your brainstorm history.</p>
                                <div id="deepsearch-prompt" contenteditable="true" class="flex-1 bg-black/40 border border-white/5 p-4 rounded font-mono text-xs text-secondary-focus overflow-y-auto min-h-[200px] leading-relaxed outline-none">
                                    ${getForgeContextForResearch()}
                                </div>
                                <div class="flex gap-2">
                                    <button class="btn btn-sm btn-secondary flex-1 font-bold" onclick="tailorDeepSearchPrompt()">TAILOR WITH AI</button>
                                    <button class="btn btn-sm btn-primary flex-1 font-bold" onclick="copyDeepSearchPrompt()">COPY PROMPT</button>
                                </div>
                            </div>
                        </div>

                        <!-- Harvest Panel -->
                        <div class="card bg-base-200 shadow-md border border-base-content/10 flex flex-col">
                            <div class="card-body p-4 flex flex-col gap-4">
                                <h3 class="card-title text-xs font-bold text-success tracking-widest uppercase">Research Harvest</h3>
                                <p class="text-[10px] opacity-60">Paste findings from your external research (Gemini, Perplexity) here. This anchors your story in reality.</p>
                                <textarea id="deepsearch-results" class="textarea textarea-bordered flex-1 bg-black/40 font-mono text-xs leading-relaxed" placeholder="Verifiable facts, stakeholders, dates, primary sources...">${accumulatedData.deepSearchResults || ''}</textarea>
                                <button class="btn btn-sm btn-success btn-outline w-full font-bold" onclick="saveDeepSearchResults()">ANCHOR TO NARRATIVE</button>
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        function getForgeContextForResearch() {
            const country = document.getElementById('f-country')?.value || 'Unknown';
            const region = document.getElementById('f-region')?.value || '';
            const course = document.getElementById('f-course')?.value || '';
            const title = accumulatedData.metadata?.title || 'Educational Simulation';

            // Extract history
            const context = forgeHistory.filter(m => m.role === 'assistant').slice(-2).map(m => m.content).join('\n\n');

            return `RESEARCH MISSION: "${title}"\nLOCALE: ${country} ${region}\nCOURSE: ${course}\n\nSCENARIO CONTEXT:\n${context || 'Awaiting further scenario development...'}\n\nPlease conduct deep research to provide factual foundations for this mission. I need verified facts, dates, stakeholder perspectives, and primary sources.`;
        }

        async function tailorDeepSearchPrompt() {
            const promptEl = document.getElementById('deepsearch-prompt');
            if (!promptEl) return;

            log('Optimizing research parameters...', 'info');
            const currentPrompt = promptEl.innerText;

            const systemInstruction = `You are a Research Architect. Rewrite this research prompt into a hyper-specific set of instructions for a Deep Research AI. 
            Mandate regional specificity, verified facts, primary documents, and stakeholder perspectives. Output ONLY the raw prompt.`;

            try {
                const responseText = await callAI(`SYSTEM: ${systemInstruction}\n\nCONTEXT:\n${currentPrompt}`);
                promptEl.innerText = responseText.trim();
                log('Research parameters optimized!', 'success');
            } catch (e) {
                log('Optimization Failed: ' + e.message, 'error');
            }
        }

        function copyDeepSearchPrompt() {
            const text = document.getElementById('deepsearch-prompt')?.innerText;
            if (!text) return;
            navigator.clipboard.writeText(text).then(() => {
                log('Research Prompt Copied to Clipboard', 'success');
                alert('Copied! Paste this into Gemini Deep Research or Perplexity.');
            });
        }

        function saveDeepSearchResults() {
            const results = document.getElementById('deepsearch-results')?.value.trim();
            if (!results) {
                if (!confirm("No research harvested. Anchor proceeding with simulated data only. Proceed?")) return;
            }
            accumulatedData.deepSearchResults = results;
            log('Mission anchored to research harvest.', 'success');
            addForgeChat('ai', 'âœ… **Research Anchored.** I will now use these verified sources to construct the operational narrative.');
        }

        async function executeDeepSearch() {
            // Deprecated in favor of Tailor/Harvest workflow
            log('Deep Search direct scan shifted to manual Harvest.', 'info');
        }

        function resetForge() {
            if (!confirm("TERMINATE CURRENT FORGE SESSION? All unsaved intelligence will be lost.")) return;
            currentPhaseIndex = 0;
            forgeHistory = [];
            accumulatedData = { metadata: {}, slides: [] };

            // Clear Chat
            const chat = document.getElementById('forge-chat');
            chat.innerHTML = `
                <div class="divider text-xs opacity-50">SESSION TERMINATED</div>
                <div class="chat chat-start">
                    <div class="chat-bubble chat-bubble-primary font-mono text-sm">
                        SYSTEM READY. AWAITING NEW DIRECTIVES.
                    </div>
                </div>`;

            updateForgeUI();
            log("Forge Session Reset.", "warning");
        }

        // --- AUTH & INIT ---
        function initGoogleAuth() {
            log("GSI_ENGINE: Establishing Secure Identity Link...");
            try {
                if (typeof google !== 'undefined' && google.accounts) {
                    google.accounts.id.initialize({
                        client_id: GOOGLE_CLIENT_ID,
                        callback: handleCredentialResponse
                    });
                    // Render the Google Sign-In button in the auth modal
                    google.accounts.id.renderButton(
                        document.getElementById("google-signin-container"),
                        { theme: "outline", size: "large", width: 280 }
                    );
                    log("Google Auth Initialized.", "success");
                } else {
                    log("GSI Library not loaded yet.", "warning");
                }
            } catch (e) {
                console.error("GSI Init Error:", e);
                log(`GSI Error: ${e.message}`, "error");
            }
        }

        function openAuthModal() {
            const modal = document.getElementById('auth_modal');
            if (modal) {
                initGoogleAuth(); // Ensure button is rendered
                modal.showModal();
            }
        }

        function handleCredentialResponse(response) {
            const responsePayload = decodeJwtResponse(response.credential);
            googleUser = responsePayload;

            document.getElementById('status-badge-auth').innerText = "AUTH_OK";
            document.getElementById('status-badge-auth').classList.remove('opacity-50');
            document.getElementById('status-badge-auth').classList.add('text-success');
            document.getElementById('user-avatar-initials').innerText = googleUser.given_name?.[0] || "U";

            log(`Identity Verified: ${googleUser.email}`, "success");

            // Close the auth modal on successful login
            const modal = document.getElementById('auth_modal');
            if (modal) modal.close();

            // Refresh data with authenticated teacher ID
            refreshClasses();
            fetchMissions();
        }

        function decodeJwtResponse(token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        // --- STUB FUNCTIONS FOR MISSING LOGIC (Will be filled in Phase 2) ---
        async function processForge() {
            const inputEl = document.getElementById('f-input');
            const input = inputEl.value.trim();
            const phase = getCurrentPhase();

            // 1. Check for basic navigation commands
            if (input.toLowerCase().match(/^(next|proceed|advance|continue)$/)) {
                advancePhase();
                inputEl.value = '';
                return;
            }

            // 2. Prepare UI
            addForgeChat('user', input || "(Generating intel...)");
            inputEl.value = '';
            const loadingId = `msg-${Date.now()}`;
            // Add temp loading bubble
            const chat = document.getElementById('forge-chat');
            chat.insertAdjacentHTML('beforeend', `<div id="${loadingId}" class="chat chat-start"><div class="chat-bubble chat-bubble-secondary animate-pulse text-xs">AWAITING SATELLITE UPLINK...</div></div>`);
            chat.scrollTop = chat.scrollHeight;

            try {
                console.log("processForge: Initiating AI Request...", { phase, inputLength: input.length });
                // 3. Construct Prompt Context
                let context = `${FORGE_SYSTEM_CORE}\n\n`;

                // Curriculum Context
                const country = document.getElementById('f-country').value;
                const region = document.getElementById('f-region').value;
                const course = document.getElementById('f-course').value;
                const checks = document.querySelectorAll('.outcome-check:checked');
                const selectedOutcomes = Array.from(checks).map(c => c.value);

                if (country || region || course) {
                    context += `\n--- TEACHER CONTEXT ---\n`;
                    context += `LOCALE: ${country} | ${region}\n`;
                    context += `COURSE: ${course}\n`;
                    if (selectedOutcomes.length > 0) {
                        context += `TARGET OUTCOMES: ${selectedOutcomes.join(" | ")}\n`;
                        log(`Aligning with ${selectedOutcomes.length} outcomes.`, "info");
                    }
                }

                // Append History (Last 6 turns to save tokens)
                const recentHistory = forgeHistory.slice(-6);
                if (recentHistory.length > 0) {
                    context += `\n--- PREVIOUS INTEL ---\n`;
                    recentHistory.forEach(h => context += `${h.role.toUpperCase()}: ${h.content}\n`);
                }

                // Research Context (Injection)
                if (accumulatedData.deepSearchResults) {
                    context += `\n--- VERIFIED RESEARCH HARVEST ---\n${accumulatedData.deepSearchResults}\n`;
                }

                context += `\nCURRENT OBJECTIVE: ${phase.title}\nINSTRUCTION: ${phase.prompt}\nUSER COMMAND: ${input}`;

                // 4. API Call
                console.log("processForge: Sending context to AI...");
                const responseText = await callAI(context);
                console.log("processForge: AI success.", responseText.substring(0, 50));

                // 5. Handle Success
                const loader = document.getElementById(loadingId);
                if (loader) loader.remove();

                const lowerResponse = responseText.toLowerCase();
                const shouldShowNext = lowerResponse.includes('authorize next') ||
                    lowerResponse.includes('proceed to next') ||
                    lowerResponse.includes('ready for visuals') ||
                    (phase.id === 'narrative' && lowerResponse.includes('slide 10:'));

                addForgeChat('ai', responseText, { showNextPhaseButton: shouldShowNext });

                // Save to History
                forgeHistory.push({ role: 'user', content: input });
                forgeHistory.push({ role: 'assistant', content: responseText });

                // Parse narrative if in applicable phase
                if (phase.id === 'narrative' || responseText.includes('SLIDE 1:')) {
                    parseNarrativeResponse(responseText);
                }

                log(`AI Directive Received [${phase.label}]`, "success");

            } catch (e) {
                console.error("processForge Failure:", e);
                const loader = document.getElementById(loadingId);
                if (loader) loader.remove();
                addForgeChat('ai', `**CONNECTION LOST**: ${e.message}`);
                log(`Forge Error: ${e.message}`, "error");
            }
        }


        // --- NARRATIVE PARSER (Restored from old version) ---
        function parseNarrativeResponse(text) {
            if (!text) return;

            log('Parsing narrative response for structured components...', 'info');

            // 1. Extract Mission Title if present
            const titleMatch = text.match(/Mission Title:\s*(.*)/i);
            if (titleMatch && titleMatch[1]) {
                if (!accumulatedData.metadata) accumulatedData.metadata = {};
                accumulatedData.metadata.title = titleMatch[1].trim();
                log(`Extracted Mission Title: ${accumulatedData.metadata.title}`, 'success');
            }

            // 2. Split into Slide Blocks
            // Format usually starts with "SLIDE X:"
            const slides = [];
            const slideBlocks = text.split(/SLIDE\s+\d+:\s+/i).slice(1); // Skip the preamble

            slideBlocks.forEach((block, idx) => {
                const slide = {
                    id: idx + 1,
                    type: 'BRIEFING', // Default
                    title: '',
                    content: '',
                    interactionPrompt: '',
                    options: [],
                    outcomes: {},
                    tabs: { primary: { label: 'Primary', content: '' }, intel: { label: 'Intel', content: '' }, legal: { label: 'Legal', content: '' } }
                };

                // Extract Type and Title
                const titleLineMatch = block.match(/SLIDE TYPE:\s*(.*?)\s*\|\s*TITLE:\s*(.*)/i);
                if (titleLineMatch) {
                    slide.type = titleLineMatch[1].trim();
                    slide.title = titleLineMatch[2].trim();
                    slide.shortTitle = slide.title.substring(0, 20);
                }

                // Extract Content
                const contentMatch = block.match(/CONTENT:\s*([\s\S]*?)(?=INTERACTION PROMPT:|OPTIONS:|OUTCOMES:|INTEL:|$)/i);
                if (contentMatch) {
                    slide.content = contentMatch[1].trim();
                }

                // Extract Interaction Prompt
                const promptMatch = block.match(/INTERACTION PROMPT:\s*([\s\S]*?)(?=OPTIONS:|OUTCOMES:|INTEL:|$)/i);
                if (promptMatch) {
                    slide.interactionPrompt = promptMatch[1].trim();
                }

                // Extract Options
                const optionsMatch = block.match(/OPTIONS:\s*([\s\S]*?)(?=OUTCOMES:|INTEL:|$)/i);
                if (optionsMatch) {
                    const opts = optionsMatch[1].match(/\["(.*?)"\]/g);
                    if (opts) {
                        slide.options = opts.map(o => o.replace(/\["(.*)"\]/, '$1'));
                    }
                }

                // Extract Intel / Tabs
                const intelMatch = block.match(/INTEL:\s*\{([\s\S]*?)\}/i);
                if (intelMatch) {
                    const rawIntel = intelMatch[1];
                    // Very loose parsing for AI-generated "JSON-like" objects
                    const primary = rawIntel.match(/PRIMARY:\s*"(.*?)"/i);
                    const legal = rawIntel.match(/LEGAL:\s*"(.*?)"/i);
                    const intelSecondary = rawIntel.match(/INTEL:\s*"(.*?)"/i);

                    if (primary) slide.tabs.primary.content = primary[1];
                    if (legal) slide.tabs.legal.content = legal[1];
                    if (intelSecondary) slide.tabs.intel.content = intelSecondary[1];
                }

                slides.push(slide);
            });

            // --- ROBUSTNESS: If no slides extracted, try looser parsing ---
            if (slides.length === 0) {
                log('Strict parser found no slides. Attempting looser extraction...', 'warning');

                // Try to extract any numbered sections
                const looseBlocks = text.split(/(?:^|\n)(?:###|##)\s*(?:Slide\s*)?\d+/i);
                if (looseBlocks.length > 1) {
                    looseBlocks.slice(1).forEach((block, idx) => {
                        const slide = {
                            id: idx + 1,
                            type: 'BRIEFING',
                            title: `Slide ${idx + 1}`,
                            content: block.trim().substring(0, 500),
                            tabs: { primary: { label: 'Primary', content: '' }, intel: { label: 'Intel', content: '' } }
                        };
                        slides.push(slide);
                    });
                }
            }

            if (slides.length > 0) {
                accumulatedData.slides = slides;
                log(`Successfully extracted ${slides.length} slides from narrative.`, 'success');

                // Update phase badge
                updatePhaseBadge('narrative', `${slides.length} slides`);
            }

            // 3. Extract Glossary if present
            const glossaryMatch = text.match(/INTELLIGENCE GLOSSARY:\s*([\s\S]*)$/i);
            if (glossaryMatch) {
                const items = [];
                const lines = glossaryMatch[1].split('\n');
                lines.forEach(line => {
                    const m = line.match(/^(.*?):\s*(.*)/);
                    if (m) {
                        items.push({ term: m[1].trim(), definition: m[2].trim() });
                    }
                });
                if (items.length > 0) {
                    accumulatedData.intelligenceGlossary = items;
                    log(`Extracted ${items.length} glossary terms.`, 'success');
                }
            }
        }


        function sanitizeForBirth(data) {
            // Create a deep copy and strip base64 image data, keeping only R2 URLs
            const sanitized = JSON.parse(JSON.stringify(data));

            // Helper to check if a string is a base64 data URI
            const isBase64 = (str) => {
                return typeof str === 'string' && str.startsWith('data:image');
            };

            // Helper to filter image URLs (only keep R2/HTTP URLs, remove base64)
            const filterImageUrl = (url) => {
                if (!url) return '';
                if (isBase64(url)) return ''; // Strip base64
                return url; // Keep R2/HTTP URLs
            };

            // Sanitize metadata
            if (sanitized.metadata) {
                sanitized.metadata.heroImage = filterImageUrl(sanitized.metadata.heroImage);
            }

            // Sanitize slides
            if (Array.isArray(sanitized.slides)) {
                sanitized.slides.forEach(slide => {
                    // Filter slide-level images
                    slide.image = filterImageUrl(slide.image);
                    slide.mediaURL = filterImageUrl(slide.mediaURL);

                    // Filter tab images
                    if (slide.tabs) {
                        Object.keys(slide.tabs).forEach(tabKey => {
                            const tab = slide.tabs[tabKey];
                            if (tab && tab.image) {
                                tab.image = filterImageUrl(tab.image);
                            }
                        });
                    }
                });
            }

            return sanitized;
        }
        function updatePhaseBadge(phaseId, badgeText) {
            // Simplified: Re-render the stepper which now supports badges
            renderPipelineStepper();
        }
        // --- MISSION SURGERY HELPERS ---
        function setNested(obj, path, value) {
            const parts = path.split('.');
            let current = obj;
            for (let i = 0; i < parts.length - 1; i++) {
                if (!current[parts[i]]) current[parts[i]] = {};
                current = current[parts[i]];
            }
            current[parts[parts.length - 1]] = value;
        }

        function formatText(text) {
            if (!text) return "";
            return text
                .replace(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/g,
                    '<div class="video-container" style="position:relative; padding-bottom:56.25%; height:0; overflow:hidden; margin:10px 0;"><iframe style="position:absolute; top:0; left:0; width:100%; height:100%; border:0;" src="https://www.youtube.com/embed/$1" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>')
                .replace(/(https?:\/\/.*\.pdf)/gi,
                    '<div class="pdf-container" style="height:300px; margin:10px 0;"><embed src="$1" type="application/pdf" width="100%" height="100%"></div>')
                .replace(/(https?:\/\/.*\.(?:mp4|avi|mov|webm))/gi,
                    '<video controls style="width:100%; max-height:300px; background:#000; margin:10px 0;"><source src="$1">Video not supported.</video>')
                .replace(/\n/g, '<br>');
        }

        async function callAI(prompt) {
            // Priority 0: HARDWIRED Vercel Proxy
            const selectedModel = document.getElementById('f-model')?.value || 'google/gemini-2.0-flash-exp:free';

            console.log("callAI: Connecting via Vercel Proxy...", HARDWIRED_PROXY);
            log(`AI Uplink: Proxy [${selectedModel}]`, "info");

            try {
                const res = await fetch(HARDWIRED_PROXY, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: prompt,
                        model: selectedModel
                    })
                });
                const data = await res.json();
                console.log("callAI: Vercel Response:", data);

                if (data.choices && data.choices[0]) {
                    const text = data.choices[0].message.content;
                    log("Proxy Intel Acquired.", "success");
                    return text;
                }
                if (data.message) {
                    return data.message;
                }
                throw new Error("Proxy response format invalid.");
            } catch (e) {
                console.error("callAI: Vercel Proxy Error:", e);
                log(`Proxy Error: ${e.message}. Falling back to GCP.`, "warning");
            }

            // Priority 1: Google Cloud Direct (via Config or LocalStorage)
            const gcpKey = localStorage.getItem('TM_GCP_KEY') || (typeof CONFIG !== 'undefined' ? CONFIG.GCP_KEY : '');

            console.log("callAI: Checking GCP Key...", gcpKey ? `Key found (${gcpKey.substring(0, 8)}...)` : "NO KEY");
            log(`AI Uplink: ${gcpKey ? 'GCP Key detected' : 'Proxy offline/missing - using backup'}`, gcpKey ? 'info' : 'warning');

            if (gcpKey) {
                // Gemini API Path
                const model = localStorage.getItem('TM_GCP_MODEL') || "gemini-1.5-flash";
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${gcpKey}`;
                console.log("callAI: Sending request to", model);
                log(`AI Request â†’ ${model}...`);

                try {
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await res.json();
                    console.log("callAI: Raw API Response:", data);

                    if (data.candidates && data.candidates[0]) {
                        const text = data.candidates[0].content.parts[0].text;
                        console.log("callAI: SUCCESS - Response length:", text.length);
                        log(`AI Response: ${text.substring(0, 50)}...`, "success");
                        return text;
                    }

                    // Handle specific error cases
                    const errMsg = data.error?.message || JSON.stringify(data);
                    console.error("callAI: API Error:", errMsg);
                    log(`API Error: ${errMsg}`, "error");
                    throw new Error(errMsg);
                } catch (e) {
                    console.error("callAI: Fetch failed:", e);
                    log(`AI Error: ${e.message}. Falling back to Simulation.`, "warning");
                }
            }

            // Fallback: Smart Simulation (for UI testing or offline)
            console.log("callAI: Using SIMULATION mode");
            log("Simulation Mode Active - No Uplink Detected", "warning");
            await new Promise(r => setTimeout(r, 1000));
            const simResponses = [
                "**INTEL ACQUIRED.** \nBased on your parameters, I suggest a scenario involving a diplomatic standoff in the South China Sea. \n\n**Option A**: Naval blockade. \n**Option B**: Cyber-attack on infrastructure. \n\nPlease advise on vector.",
                "**NARRATIVE BRIEFING UPDATED.** \nDeveloping slide sequence: \n1. **The Incident**: Unidentified vessel enters exclusion zone. \n2. **Escalation**: Warning shots fired. \n3. **Crisis**: Ambassador recalled.",
                "**VISUAL ASSETS GENERATED.** \nPROMPT: `Satellite view, thermal imaging, 4k, cinematic lighting.` \nConfirm art style?"
            ];
            // Cycle response based on phase to look uniform
            return simResponses[currentPhaseIndex % simResponses.length] || "System operational. Awaiting command.";
        }

        function advancePhase() {
            const currentPhase = getCurrentPhase();

            if (currentPhaseIndex >= forgePipeline.length - 1) {
                alert('You are already at the final phase (Deploy).');
                return;
            }

            // Special validation for narrative â†’ assets transition
            if (currentPhase.id === 'narrative') {
                const slideCount = accumulatedData?.slides?.length || 0;
                if (slideCount < 10) {
                    const proceed = confirm(`Only ${slideCount}/10 slides detected. Proceeding to Assets may result in missing content. Continue anyway?`);
                    if (!proceed) return;
                }
            }

            // Special validation for assets â†’ deploy transition
            if (currentPhase.id === 'assets') {
                let imgCount = 0;
                (accumulatedData.slides || []).forEach(s => {
                    if (s.image || s.tabs?.primary?.image) imgCount++;
                });
                if (imgCount < 5) {
                    const proceed = confirm(`Only ${imgCount} visual assets archived. Proceeding to Birth may result in incomplete data. Continue?`);
                    if (!proceed) return;
                }
            }

            // Create a small "system event" in chat
            const chat = document.getElementById('forge-chat');
            if (chat) {
                chat.insertAdjacentHTML('beforeend', `
                    <div class="divider text-primary text-xs font-mono my-4">PHASE COMPLETE</div>
                `);
            }

            currentPhaseIndex++;
            updateForgeUI();
            log(`Phase advanced to: ${getCurrentPhase().label}`, 'success');
        }

        function forgeBack() {
            if (currentPhaseIndex > 0) {
                currentPhaseIndex--;
                updateForgeUI();
                addForgeChat("ai", `Reverting to ${getCurrentPhase().label}. Command parameters preserved.`);
                log(`Forge reverted to: ${getCurrentPhase().label}`, 'warning');
            }
        }

        // --- MEDIA SCREEN PROMPT EXTRACTION (Restored) ---
        function extractAIPromptsFromHistory() {
            // Look for AI response containing markdown table with prompts
            const assistantMsgs = forgeHistory.filter(m => m.role === 'assistant');

            for (const msg of assistantMsgs.reverse()) { // Start from most recent
                const content = msg.content;

                // Try to find markdown table rows - support both 4-column and 6-column formats
                const tableRows4 = content.match(/\|[^|\n]+\|[^|\n]+\|[^|\n]+\|[^|\n]+\|/g);
                const tableRows6 = content.match(/\|[^|\n]+\|[^|\n]+\|[^|\n]+\|[^|\n]+\|[^|\n]+\|[^|\n]*\|/g);

                const tableRows = tableRows6 || tableRows4;
                const is6Column = !!tableRows6;

                if (tableRows && tableRows.length > 1) {
                    const prompts = [];

                    for (let i = 1; i < tableRows.length; i++) {
                        const row = tableRows[i];
                        const cells = row.split('|').map(c => c.trim()).filter(c => c);

                        // Skip table separator row
                        if (cells.length > 0 && cells.every(cell => /^[-:]+$/.test(cell))) {
                            continue;
                        }

                        if (cells.length >= 4) {
                            const aiPrompt = is6Column ? (cells[4] || '') : (cells[3] || '');
                            const itemName = cells[1] || '';

                            if (!aiPrompt || /^[-\s]+$/.test(aiPrompt)) continue;

                            prompts.push({
                                id: cells[0],
                                name: itemName,
                                prompt: aiPrompt
                            });
                        }
                    }

                    if (prompts.length > 0) {
                        if (!accumulatedData.metadata) accumulatedData.metadata = {};
                        if (!accumulatedData.slides) accumulatedData.slides = [];

                        // First prompt is typically Hero
                        if (prompts[0]) {
                            accumulatedData.metadata.heroPrompt = prompts[0].prompt;
                            prompts.shift();
                        }

                        // Distribute remaining prompts across slides (2 per slide)
                        for (let i = 0; i < prompts.length && i < 18; i++) {
                            const slideIdx = Math.floor(i / 2);
                            const isAlt = i % 2 === 1;

                            if (!accumulatedData.slides[slideIdx]) {
                                accumulatedData.slides[slideIdx] = { shortTitle: `Slide ${slideIdx + 1}` };
                            }

                            if (isAlt) {
                                accumulatedData.slides[slideIdx].altImagePrompt = prompts[i].prompt;
                            } else {
                                accumulatedData.slides[slideIdx].imagePrompt = prompts[i].prompt;
                            }
                        }

                        accumulatedData.aiPromptsExtracted = true;
                        log(`Extracted ${prompts.length + 1} AI prompts from Assets phase`, 'success');
                        return;
                    }
                }
            }
            accumulatedData.aiPromptsExtracted = true;
        }

        function renderAssetsScreen(outputArea) {
            if (!accumulatedData.aiPromptsExtracted) {
                extractAIPromptsFromHistory();
            }

            const missionId = accumulatedData?.metadata?.id || 'unnamed';
            const heroPrompt = accumulatedData.metadata?.heroPrompt || '';
            const heroImage = accumulatedData.metadata?.heroImage || '';

            let html = `
                <div class="p-6 h-full overflow-y-auto bg-base-200">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
                        <div>
                            <h2 class="text-2xl font-display tracking-widest text-primary flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                VISUAL ASSET MATRIX
                            </h2>
                            <p class="text-xs opacity-60 font-mono uppercase tracking-tighter">Mission ID: ${missionId}</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                             <button class="btn btn-sm btn-outline btn-primary font-mono text-[10px]" onclick="extractAIPromptsFromHistory(); renderAssetsScreen(document.getElementById('forge-output'))">RESYNC PROMPTS</button>
                             <button class="btn btn-sm btn-secondary font-mono text-[10px]" onclick="generateAllAssets()">GENERATE ALL</button>
                             <button class="btn btn-sm btn-accent font-mono text-[10px]" onclick="saveAllAssetsToR2()">SAVE ALL TO R2</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
                        <div class="col-span-full mb-4">
                            <div class="card bg-base-100 shadow-xl border border-primary/20">
                                <div class="card-body p-4 md:p-6">
                                    <div class="flex justify-between items-center mb-2">
                                        <h3 class="text-xs font-bold text-primary tracking-widest uppercase">Primary Mission Hero</h3>
                                        <span class="badge badge-primary badge-xs font-mono">SLOT: HERO</span>
                                    </div>
                                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                        <div class="lg:col-span-2 space-y-4">
                                            <div class="form-control">
                                                <label class="label py-1"><span class="label-text-alt opacity-50 text-[10px] uppercase font-bold">Image Synthesis Prompt</span></label>
                                                <textarea id="asset-hero-prompt" class="textarea textarea-bordered textarea-sm w-full h-24 font-mono text-xs leading-tight" placeholder="Synthetics prompt...">${heroPrompt}</textarea>
                                            </div>
                                            <div class="flex flex-col sm:flex-row gap-2">
                                                <div class="join flex-1">
                                                    <input id="asset-hero-url" type="text" class="input input-bordered input-xs join-item flex-1 font-mono text-[10px] text-success" placeholder="Asset URL (R2/HTTPS)" value="${heroImage}" onchange="updateAssetUrl('hero', this.value)">
                                                    <button class="btn btn-xs btn-primary join-item px-4 font-bold" onclick="generateAsset('hero')">GENERATE</button>
                                                </div>
                                                <button class="btn btn-xs btn-outline btn-accent font-bold" onclick="saveAssetToGit('hero')">R2 ARCHIVE</button>
                                            </div>
                                        </div>
                                        <div id="asset-hero-preview" class="bg-black/40 rounded border border-white/5 flex items-center justify-center min-h-[160px] overflow-hidden">
                                            ${heroImage ? `<img src="${heroImage}" class="max-h-[160px] object-contain shadow-2xl" onerror="this.src='https://placehold.co/600x400/000/0af?text=PREVIEW+FAILED'">` : '<div class="text-center opacity-20"><p class="text-[10px] font-mono">NO IMAGE DATA</p></div>'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
            `;

            const slides = accumulatedData.slides || [];
            slides.forEach((slide, i) => {
                const slideTitle = slide.title || slide.shortTitle || `Section ${i + 1}`;
                const primaryImg = slide.tabs?.primary?.image || slide.image || '';
                const altImg = slide.tabs?.intel?.image || slide.altImage || '';

                html += `
                    <div class="card bg-base-100 shadow-lg border border-base-content/10">
                        <div class="card-body p-3 space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-[10px] font-bold text-accent opacity-70 truncate max-w-[120px]">S${i + 1}A: ${slideTitle.substring(0, 18)}${slideTitle.length > 18 ? '...' : ''}</span>
                                <div class="flex items-center gap-1">
                                    <button class="btn btn-[8px] h-4 min-h-0 px-1 btn-ghost opacity-40 hover:opacity-100" onclick="openIntelModal(${i})">INTEL</button>
                                    <span class="badge badge-outline badge-xs opacity-50 font-mono">PRM</span>
                                </div>
                            </div>
                            <div id="asset-${i}-a-preview" class="bg-black/20 rounded aspect-video flex items-center justify-center border border-white/5 overflow-hidden">
                                ${primaryImg ? `<img src="${primaryImg}" class="max-h-full object-contain" onerror="this.style.display='none'">` : '<span class="text-[10px] opacity-20 font-mono uppercase">Offline</span>'}
                            </div>
                            <textarea id="asset-${i}-a-prompt" class="textarea textarea-bordered textarea-xs w-full h-16 font-mono text-[10px] leading-tight" placeholder="Prompt...">${slide.imagePrompt || ''}</textarea>
                            <input id="asset-${i}-a-url" type="text" class="input input-bordered input-xs w-full font-mono text-[9px] text-success" placeholder="URL" value="${primaryImg}" onchange="updateAssetUrl('${i}-a', this.value)">
                            <div class="grid grid-cols-2 gap-2">
                                <button class="btn btn-xs btn-primary font-mono text-[9px]" onclick="generateAsset('${i}-a')">GEN</button>
                                <button class="btn btn-xs btn-outline font-mono text-[9px]" onclick="saveAssetToGit('${i}-a')">R2</button>
                            </div>
                        </div>
                    </div>

                    <div class="card bg-base-100 shadow-lg border border-base-content/10">
                        <div class="card-body p-3 space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-[10px] font-bold text-warning opacity-70 truncate max-w-[120px]">S${i + 1}B: ${slideTitle.substring(0, 18)}${slideTitle.length > 18 ? '...' : ''}</span>
                                <div class="flex items-center gap-1">
                                    <button class="btn btn-[8px] h-4 min-h-0 px-1 btn-ghost opacity-40 hover:opacity-100" onclick="openIntelModal(${i})">INTEL</button>
                                    <span class="badge badge-outline badge-xs opacity-50 font-mono">ALT</span>
                                </div>
                            </div>
                            <div id="asset-${i}-b-preview" class="bg-black/20 rounded aspect-video flex items-center justify-center border border-white/5 overflow-hidden">
                                ${altImg ? `<img src="${altImg}" class="max-h-full object-contain" onerror="this.style.display='none'">` : '<span class="text-[10px] opacity-20 font-mono uppercase">Offline</span>'}
                            </div>
                            <textarea id="asset-${i}-b-prompt" class="textarea textarea-bordered textarea-xs w-full h-16 font-mono text-[10px] leading-tight" placeholder="Alt prompt...">${slide.altImagePrompt || ''}</textarea>
                            <input id="asset-${i}-b-url" type="text" class="input input-bordered input-xs w-full font-mono text-[9px] text-warning" placeholder="URL" value="${altImg}" onchange="updateAssetUrl('${i}-b', this.value)">
                            <div class="grid grid-cols-2 gap-2">
                                <button class="btn btn-xs btn-secondary font-mono text-[9px]" onclick="generateAsset('${i}-b')">GEN</button>
                                <button class="btn btn-xs btn-outline font-mono text-[9px]" onclick="saveAssetToGit('${i}-b')">R2</button>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `</div></div>`;
            outputArea.innerHTML = html;
        }

        function updateAssetUrl(slotId, url) {
            if (slotId === 'hero') {
                if (!accumulatedData.metadata) accumulatedData.metadata = {};
                accumulatedData.metadata.heroImage = url;
                const prev = document.getElementById('asset-hero-preview');
                if (prev) prev.innerHTML = url ? `<img src="${url}" class="max-h-[160px] object-contain shadow-2xl">` : '<div class="text-[10px] opacity-20 font-mono">NO IMAGE DATA</div>';
            } else if (typeof slotId === 'string' && slotId.includes('-')) {
                const [slideIdx, variant] = slotId.split('-');
                const idx = parseInt(slideIdx);

                if (!accumulatedData.slides[idx]) accumulatedData.slides[idx] = {};
                if (!accumulatedData.slides[idx].tabs) accumulatedData.slides[idx].tabs = { primary: {}, intel: {} };

                if (variant === 'a') {
                    accumulatedData.slides[idx].tabs.primary.image = url;
                    accumulatedData.slides[idx].image = url;
                } else {
                    accumulatedData.slides[idx].tabs.intel.image = url;
                }

                const prev = document.getElementById(`asset-${slotId}-preview`);
                if (prev) prev.innerHTML = url ? `<img src="${url}" class="max-h-full object-contain">` : '<span class="text-[10px] opacity-20 font-mono">Offline</span>';
            }
            log(`Asset URL updated for slot ${slotId}`, 'success');
        }

        async function generateAsset(slotId) {
            const promptEl = document.getElementById(slotId === 'hero' ? 'asset-hero-prompt' : `asset-${slotId}-prompt`);
            const urlEl = document.getElementById(slotId === 'hero' ? 'asset-hero-url' : `asset-${slotId}-url`);
            const previewEl = document.getElementById(slotId === 'hero' ? 'asset-hero-preview' : `asset-${slotId}-preview`);

            const prompt = promptEl?.value;
            if (!prompt) {
                alert('Enter a synthesis directive first!');
                return;
            }

            // Get OpenRouter key or Vercel Proxy
            let orKey = localStorage.getItem('TM_OPENROUTER_KEY');
            if (!orKey) {
                orKey = window.prompt("Enter OpenRouter API Key for Image Synthesis:");
                if (!orKey) return;
                localStorage.setItem('TM_OPENROUTER_KEY', orKey.trim());
            }

            try {
                previewEl.innerHTML = '<span class="loading loading-spinner text-primary"></span>';
                log(`Synthesis Initiated [${slotId}]...`, 'info');

                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${orKey}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        "model": "black-forest-labs/flux.2-pro",
                        "messages": [{ "role": "user", "content": prompt }]
                    })
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error.message);

                const message = data.choices[0].message;
                let imageUrl = null;

                if (message.images && message.images.length > 0) {
                    imageUrl = message.images[0].image_url?.url || message.images[0];
                }

                if (!imageUrl) {
                    const urlMatch = (message.content || "").match(/https?:\/\/[^\s\)]+/g);
                    if (urlMatch) imageUrl = urlMatch[0];
                }

                if (!imageUrl) throw new Error("Synthesis failed to yield visual data.");

                urlEl.value = imageUrl;
                updateAssetUrl(slotId, imageUrl);
                log(`Synthesis Successful [${slotId}]`, 'success');

            } catch (e) {
                log(`Synthesis Error [${slotId}]: ${e.message}`, 'error');
                previewEl.innerHTML = `<span class="text-[10px] text-error font-mono leading-none text-center">FAILURE:<br>${e.message.substring(0, 30)}...</span>`;
            }
        }

        async function generateAllAssets() {
            if (!confirm("Synthesize ALL assets? This consumes significant credits.")) return;
            const slots = ['hero'];
            for (let i = 0; i < (accumulatedData.slides?.length || 0); i++) {
                slots.push(`${i}-a`, `${i}-b`);
            }

            for (const slotId of slots) {
                const promptEl = document.getElementById(slotId === 'hero' ? 'asset-hero-prompt' : `asset-${slotId}-prompt`);
                if (promptEl?.value?.trim()) {
                    await generateAsset(slotId);
                    await new Promise(r => setTimeout(r, 1000)); // Rate limiting
                }
            }
        }

        async function saveAssetToGit(slotId) {
            const urlEl = document.getElementById(slotId === 'hero' ? 'asset-hero-url' : `asset-${slotId}-url`);
            const previewEl = document.getElementById(slotId === 'hero' ? 'asset-hero-preview' : `asset-${slotId}-preview`);
            const url = urlEl?.value;

            if (!url) return alert('No asset URL found.');

            const R2_WORKER_URL = 'https://proud-tooth-42cf.icumusicvideo.workers.dev';
            const originalContent = previewEl.innerHTML;

            try {
                log(`R2 Uplink [${slotId}]: Processing...`, 'info');
                previewEl.innerHTML = '<span class="loading loading-spinner text-accent"></span>';

                // Convert to JPG via canvas (for optimization and consistency)
                const img = new Image();
                img.crossOrigin = "anonymous";
                await new Promise((res, rej) => {
                    img.onload = res;
                    img.onerror = rej;
                    img.src = url;
                });

                const canvas = document.createElement('canvas');
                canvas.width = img.width; canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#FFF'; ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
                const jpgData = canvas.toDataURL('image/jpeg', 0.8);

                const res = await fetch(`${R2_WORKER_URL}?filename=${encodeURIComponent(`TM_${slotId}_${Date.now()}.jpg`)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: jpgData })
                });

                const data = await res.json();
                if (!data.success) throw new Error(data.error);

                urlEl.value = data.url;
                updateAssetUrl(slotId, data.url);
                log(`R2 Archive Complete [${slotId}]`, 'success');

            } catch (e) {
                log(`R2 Error [${slotId}]: ${e.message}`, 'error');
                previewEl.innerHTML = originalContent;
                alert(`Archive Failed: ${e.message}`);
            }
        }

        async function saveAllAssetsToR2() {
            const slots = [];
            const heroUrl = document.getElementById('asset-hero-url')?.value;
            if (heroUrl) slots.push('hero');

            for (let i = 0; i < (accumulatedData.slides?.length || 0); i++) {
                if (document.getElementById(`asset-${i}-a-url`)?.value) slots.push(`${i}-a`);
                if (document.getElementById(`asset-${i}-b-url`)?.value) slots.push(`${i}-b`);
            }

            if (!confirm(`Archive ${slots.length} assets to central R2 storage?`)) return;

            for (const slotId of slots) {
                await saveAssetToGit(slotId);
                await new Promise(r => setTimeout(r, 500));
            }
            alert("Batch Archive Sequence Complete.");
        }

        // --- HOSPITAL (SURGICAL THEATER) LOGIC ---
        let currentEditingSlideIndex = -1;
        let activeTabKey = 'primary';
        let quill = null;
        let turndownService = (typeof TurndownService !== 'undefined') ? new TurndownService() : null;

        function openHospital() {
            const data = accumulatedData.slides || [];
            if (data.length === 0) {
                accumulatedData.slides = [{ title: "INITIAL BRIEFING", tabs: { primary: { label: "Main", body: "Mission parameters..." } }, visual: "Satellite view...", options: ["Accept", "Decline"] }];
            }
            document.getElementById('hospital_modal').showModal();
            loadSlideEditor(0);
        }

        function renderHospitalSidebar() {
            const list = document.getElementById('h-slide-list');
            if (!list) return;
            let html = '';
            (accumulatedData.slides || []).forEach((s, i) => {
                const active = i === currentEditingSlideIndex ? 'btn-active btn-secondary' : 'btn-ghost';
                html += `<button class="btn btn-sm ${active} justify-start font-normal px-2 h-auto py-2" onclick="loadSlideEditor(${i})">
                    <span class="opacity-50 font-mono text-[10px] mr-2 w-4 self-start mt-0.5">${i + 1}.</span>
                    <span class="truncate text-xs text-left leading-tight whitespace-normal">${s.title || 'Untitled Node'}</span>
                </button>`;
            });
            html += `<button class="btn btn-sm btn-outline btn-xs border-dashed opacity-50 hover:opacity-100 mt-4" onclick="addHospitalNode()">+ Add Node</button>`;
            list.innerHTML = html;
        }

        function loadSlideEditor(index) {
            currentEditingSlideIndex = index;
            const slide = accumulatedData.slides[index];
            if (!slide) return;

            // Ensure tabs structure
            if (!slide.tabs) {
                slide.tabs = { primary: { label: "Main", body: slide.brief || slide.content || "" } };
            }
            if (!slide.tabs[activeTabKey]) {
                activeTabKey = Object.keys(slide.tabs)[0] || 'primary';
            }

            const tabData = slide.tabs[activeTabKey] || { label: "Main", body: "" };

            // UI Fields
            document.getElementById('h-title').value = slide.title || slide.shortTitle || '';
            document.getElementById('h-media-url').value = tabData.image || slide.image || '';
            document.getElementById('h-visual-prompt').value = slide.visual || slide.visualPrompt || '';
            document.getElementById('h-choice-a').value = slide.options?.[0] || '';
            document.getElementById('h-choice-b').value = slide.options?.[1] || '';
            document.getElementById('h-path').innerText = `SLIDE_${index + 1} -> ${activeTabKey.toUpperCase()}`;

            updateHospitalPreview(document.getElementById('h-media-url').value);
            renderTabNav(slide);
            initQuill(tabData.body || tabData.content || "");
            renderHospitalSidebar();
        }

        function renderTabNav(slide) {
            const nav = document.getElementById('h-tabs-nav');
            if (!nav) return;
            let html = '';
            Object.keys(slide.tabs).forEach(key => {
                const active = key === activeTabKey ? 'btn-secondary text-white' : 'btn-ghost opacity-60';
                html += `<button class="btn btn-xs ${active} px-3" onclick="switchHospitalTab('${key}')">${(slide.tabs[key].label || key).toUpperCase()}</button>`;
            });
            html += `<button class="btn btn-xs btn-ghost text-secondary" onclick="addHospitalTab()">+</button>`;
            nav.innerHTML = html;
        }

        function switchHospitalTab(key) {
            saveHospitalChanges(); // Save current before switching
            activeTabKey = key;
            loadSlideEditor(currentEditingSlideIndex);
        }

        function addHospitalTab() {
            const slide = accumulatedData.slides[currentEditingSlideIndex];
            const name = prompt("Enter tab label (e.g. Intel, Map, Bio):");
            if (!name) return;
            const key = name.toLowerCase().replace(/\s/g, '_');
            slide.tabs[key] = { label: name, body: "" };
            switchHospitalTab(key);
        }

        function initQuill(content) {
            const container = document.getElementById('quill-editor');
            if (!container) return;
            container.innerHTML = '';
            const editorDiv = document.createElement('div');
            container.appendChild(editorDiv);

            quill = new Quill(editorDiv, {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, false] }],
                        ['bold', 'italic', 'underline'],
                        ['link', 'blockquote', 'code-block'],
                        [{ 'list': 'ordered' }, { 'list': 'bullet' }]
                    ]
                }
            });

            quill.root.innerHTML = (typeof marked !== 'undefined') ? marked.parse(content || "") : content;

            // Sync on change (Debounced slightly for performance)
            quill.on('text-change', () => {
                const html = quill.root.innerHTML;
                if (turndownService && accumulatedData.slides[currentEditingSlideIndex]) {
                    const md = turndownService.turndown(html);
                    accumulatedData.slides[currentEditingSlideIndex].tabs[activeTabKey].body = md;
                }
            });
        }

        function updateHospitalPreview(url) {
            const preview = document.getElementById('h-visual-preview');
            if (!preview) return;
            if (!url) {
                preview.innerHTML = '<span class="text-xs opacity-20 font-mono">NO SIGNAL</span>';
                return;
            }

            const ytMatch = url.match(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
            const isPDF = url.toLowerCase().endsWith('.pdf');

            if (ytMatch) {
                preview.innerHTML = `<iframe class="w-full h-full" src="https://www.youtube.com/embed/${ytMatch[1]}" frameborder="0" allowfullscreen></iframe>`;
            } else if (isPDF) {
                preview.innerHTML = `<embed src="${url}" type="application/pdf" width="100%" height="100%">`;
            } else {
                preview.innerHTML = `<img src="${url}" class="max-w-full max-h-full object-contain shadow-2xl" onerror="this.src='https://placehold.co/600x400/000/0af?text=SIGNAL+LOST'">`;
            }
        }

        function saveHospitalChanges() {
            if (currentEditingSlideIndex === -1 || !quill) return;

            const slide = accumulatedData.slides[currentEditingSlideIndex];
            const tabData = slide.tabs[activeTabKey];

            slide.title = document.getElementById('h-title').value;
            slide.visual = document.getElementById('h-visual-prompt').value;
            slide.options = [
                document.getElementById('h-choice-a').value,
                document.getElementById('h-choice-b').value
            ];

            tabData.image = document.getElementById('h-media-url').value;

            if (turndownService) {
                tabData.body = turndownService.turndown(quill.root.innerHTML);
            }

            log(`Stabilized Node ${currentEditingSlideIndex + 1}: ${slide.title}`, 'success');
            renderHospitalSidebar();
        }

        function addHospitalNode() {
            saveHospitalChanges();
            accumulatedData.slides.push({
                title: "NEW NODE",
                tabs: { primary: { label: "Main", body: "" } },
                visual: "",
                options: ["", ""]
            });
            renderHospitalSidebar();
            loadSlideEditor(accumulatedData.slides.length - 1);
        }

        function closeHospital() {
            document.getElementById('hospital_modal').close();
        }

        async function deployMission() {
            if (!confirm("CONFIRM DEPLOYMENT? This will compile the mission dossier.")) return;

            // Final Metadata Sync
            updateMissionMetadata();

            // Sanitize (Strip base64)
            const cleanedData = sanitizeForBirth(accumulatedData);

            // Generate minimal JSON structure
            const missionId = cleanedData.metadata?.id || `MISSION_${Date.now().toString().slice(-6)}`;

            // Re-map slides to ensure consistent structure
            const slides = (cleanedData.slides || []).map(s => {
                // Ensure tabs structure
                if (!s.tabs) s.tabs = { primary: { label: "Primary", content: s.content || s.brief || "" }, intel: { label: "Intel", content: "" } };
                if (s.image && !s.tabs.primary.image) s.tabs.primary.image = s.image;
                return s;
            });

            const finalData = {
                metadata: {
                    ...cleanedData.metadata,
                    id: missionId,
                    author: googleUser?.email || "GUEST",
                    created: new Date().toISOString()
                },
                history: forgeHistory,
                slides: slides,
                intelligenceGlossary: cleanedData.intelligenceGlossary || []
            };

            // Download Blob
            const blob = new Blob([JSON.stringify(finalData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${missionId}.blob`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            log(`Mission Deployed: ${missionId}`, 'success');
            addForgeChat('ai', `**MISSION DEPLOYED.**\nDossier ID: \`${missionId}\`\nDownload initiated.`);
        }

        // --- IDEA SAVE/LOAD SYSTEM ---
        async function saveIdea() {
            const teacherId = googleUser?.email || 'GUEST';

            // Prompt for idea name
            const defaultName = accumulatedData?.metadata?.title || `Idea_${Date.now()}`;
            const ideaName = window.prompt("Name this idea (for later reference):", defaultName);
            if (!ideaName) return;

            const ideaId = `IDEA_${Date.now()}`;

            // Capture full forge state
            const ideaData = {
                name: ideaName,
                savedAt: new Date().toISOString(),
                forgeHistory: forgeHistory,
                currentPhaseIndex: currentPhaseIndex,
                accumulatedData: accumulatedData,
                curriculum: {
                    country: document.getElementById('f-country')?.value || '',
                    region: document.getElementById('f-region')?.value || '',
                    course: document.getElementById('f-course')?.value || '',
                    selectedOutcomes: Array.from(document.querySelectorAll('#f-outcomes input:checked')).map(c => c.value)
                },
                settings: {
                    model: document.getElementById('f-model')?.value || 'google/gemini-2.0-flash-exp:free',
                    complexity: 'Medium'
                }
            };

            try {
                await SupabaseBridge.saveIdea(ideaId, teacherId, ideaData);
                log(`IDEA SAVED: "${ideaName}" [${ideaId}]`, 'success');
                addForgeChat('ai', `ðŸ’¾ **Idea Saved!** You can close this session and resume later via "LOAD IDEA".`);
            } catch (e) {
                log(`IDEA SAVE FAILED: ${e.message}`, 'error');
                alert(`Failed to save idea: ${e.message}`);
            }
        }

        async function openIdeaLoader() {
            const teacherId = googleUser?.email || 'GUEST';

            try {
                const ideas = await SupabaseBridge.fetchIdeas(teacherId);

                if (!ideas || ideas.length === 0) {
                    alert("No saved ideas found. Start creating and use SAVE IDEA to preserve your progress.");
                    return;
                }

                // Build selection list
                let msg = "SAVED IDEAS:\n\n";
                ideas.forEach((idea, i) => {
                    const date = new Date(idea.updated_at || idea.updated).toLocaleDateString();
                    msg += `${i + 1}. ${idea.name} (${date})\n`;
                });
                msg += "\nEnter the number to load, or 0 to cancel:";

                const selection = window.prompt(msg);
                if (!selection || selection === '0') return;

                const idx = parseInt(selection) - 1;
                if (idx < 0 || idx >= ideas.length) {
                    alert("Invalid selection.");
                    return;
                }

                await loadIdea(ideas[idx].id, teacherId);
            } catch (e) {
                log(`IDEA LOAD FAILED: ${e.message}`, 'error');
                alert(`Failed to load ideas: ${e.message}`);
            }
        }

        async function loadIdea(ideaId, teacherId) {
            try {
                const ideaData = await SupabaseBridge.loadIdea(ideaId, teacherId);

                if (!ideaData) {
                    alert("Idea data not found.");
                    return;
                }

                // Restore forge state
                forgeHistory = ideaData.forgeHistory || [];
                currentPhaseIndex = ideaData.currentPhaseIndex || 0;
                accumulatedData = ideaData.accumulatedData || {};

                // Restore curriculum selections
                if (ideaData.curriculum) {
                    const c = ideaData.curriculum;
                    if (c.country && document.getElementById('f-country')) {
                        document.getElementById('f-country').value = c.country;
                        updateForgeRegions();
                        setTimeout(() => {
                            if (c.region && document.getElementById('f-region')) {
                                document.getElementById('f-region').value = c.region;
                                updateForgeCourses();
                                setTimeout(() => {
                                    if (c.course && document.getElementById('f-course')) {
                                        document.getElementById('f-course').value = c.course;
                                        updateForgeOutcomes();
                                    }
                                }, 100);
                            }
                        }, 100);
                    }
                }

                // Restore Model Selection
                if (ideaData.settings?.model && document.getElementById('f-model')) {
                    document.getElementById('f-model').value = ideaData.settings.model;
                }

                // Refresh UI
                renderPipelineStepper();
                updateForgeUI();

                // Refresh Chat
                const chat = document.getElementById('forge-chat');
                chat.innerHTML = '';
                forgeHistory.forEach(m => addForgeChat(m.role === 'user' ? 'user' : 'ai', m.content));

                log(`LOADED IDEA: ${ideaId}`, 'success');
                addForgeChat('ai', `ðŸ”„ **Session Restored.** Current Phase: ${getCurrentPhase().label.toUpperCase()}`);

            } catch (e) {
                log(`LOAD ERROR: ${e.message}`, 'error');
                alert(`Failed to restore session: ${e.message}`);
            }
        }

        function renderBirthScreen(outputArea) {
            const missionId = accumulatedData?.metadata?.id || `MISSION_${Date.now().toString().slice(-6)}`;
            const missionTitle = accumulatedData?.metadata?.title || `MISSION_${new Date().toLocaleDateString()}`;

            outputArea.innerHTML = `
                <div class="p-6 h-full overflow-y-auto bg-base-300">
                    <div class="max-w-4xl mx-auto space-y-6">
                        <div class="card bg-base-100 shadow-2xl border border-primary/30">
                            <div class="card-body">
                                <h2 class="card-title text-2xl font-display tracking-widest text-primary flex items-center gap-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                                    </svg>
                                    MISSION FINAL ASSEMBLY
                                </h2>
                                <p class="text-xs opacity-60 font-mono italic">Validating encrypted dossier for tactical deployment.</p>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-6">
                                    <div class="space-y-6">
                                        <div class="space-y-4">
                                            <div class="form-control">
                                                <label class="label py-1"><span class="label-text text-[10px] font-bold opacity-50 uppercase">Mission Callsign (Title)</span></label>
                                                <input id="birth-mission-title" type="text" class="input input-bordered input-sm font-mono text-xs" value="${missionTitle}" onchange="updateMissionMetadata()">
                                            </div>
                                            <div class="form-control">
                                                <label class="label py-1"><span class="label-text text-[10px] font-bold opacity-50 uppercase">Strategic Identifier (ID)</span></label>
                                                <input id="birth-mission-id" type="text" class="input input-bordered input-sm font-mono text-xs" value="${missionId}" onchange="updateMissionMetadata()">
                                            </div>
                                        </div>
                                        
                                        <div class="p-4 bg-black/20 rounded border border-white/5">
                                            <h4 class="text-[10px] font-bold opacity-50 uppercase mb-3 tracking-widest">Integrity Report</h4>
                                            <div id="birth-validation" class="space-y-2 font-mono text-[11px]">
                                                <!-- JS Loaded -->
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="flex flex-col h-full">
                                        <label class="label py-1"><span class="label-text text-[10px] font-bold opacity-50 uppercase">Dossier Data Preview (JSON)</span></label>
                                        <div class="bg-black shadow-inner rounded p-4 font-mono text-[9px] flex-1 overflow-auto max-h-[350px] border border-white/5 scrollbar-thin">
                                            <pre id="birth-json-preview" class="text-success/80">${JSON.stringify(accumulatedData, null, 2)}</pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            updateValidationMark();
        }

        function updateValidationMark() {
            const validationEl = document.getElementById('birth-validation');
            if (!validationEl) return;

            const slides = accumulatedData?.slides || [];
            const metadata = accumulatedData?.metadata || {};

            let html = '';

            const check = (label, pass, info) => {
                const icon = pass ? 'âœ“' : 'âœ—';
                const color = pass ? 'text-success' : 'text-error';
                return `<div class="flex justify-between items-center ${color}">
                    <span>${icon} ${label}</span>
                    <span class="opacity-50 text-[9px]">${info}</span>
                </div>`;
            };

            html += check('MISSION TITLE', !!metadata.title, metadata.title ? 'VERIFIED' : 'MISSING');
            html += check('SLIDE CAPACITY', slides.length >= 10, `${slides.length}/10 NODES`);

            let imgCount = 0;
            slides.forEach(s => { if (s.image || s.tabs?.primary?.image) imgCount++; });
            html += check('VISUAL ASSETS', imgCount >= 10, `${imgCount}/10 LOADED`);

            const hasGlossary = Array.isArray(accumulatedData?.intelligenceGlossary) && accumulatedData.intelligenceGlossary.length > 0;
            html += check('INTEL GLOSSARY', hasGlossary, hasGlossary ? 'ACTIVE' : 'NONE');

            validationEl.innerHTML = html;
        }

        function updateMissionMetadata() {
            const title = document.getElementById('birth-mission-title')?.value?.trim();
            const id = document.getElementById('birth-mission-id')?.value?.trim();

            if (!accumulatedData.metadata) accumulatedData.metadata = {};
            if (title) accumulatedData.metadata.title = title;
            if (id) accumulatedData.metadata.id = id;

            // Update JSON preview if visible
            const preview = document.getElementById('birth-json-preview');
            if (preview) preview.textContent = JSON.stringify(accumulatedData, null, 2);

            updateValidationMark();
            log('Mission identifiers synchronized.', 'info');
        }


        // --- CLASS DIRECTORY LOGIC ---
        async function refreshClasses() {
            // Mock data if Supabase offline
            if (!SupabaseBridge.client) {
                renderClasses([
                    { id: 1, class_name: "Demo Class A", passcode: "DEMO1", student_count: 12, mission_ids: [] },
                    { id: 2, class_name: "AP History", passcode: "HIST9", student_count: 28, mission_ids: [] }
                ]);
                return;
            }

            try {
                const classes = await SupabaseBridge.fetchClasses(googleUser?.email || 'GUEST');
                renderClasses(classes);
            } catch (e) {
                log("Class Sync Failed: " + e.message, "error");
            }
        }

        function renderClasses(classes) {
            const tbody = document.getElementById('class-directory-list-body');
            if (!tbody) return;

            if (!classes.length) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center opacity-50 py-8">No active classes found. Create one to begin.</td></tr>`;
                return;
            }

            let html = '';
            classes.forEach(c => {
                html += `
                <tr class="hover transition-colors">
                    <td class="font-bold text-primary">${c.class_name}</td>
                    <td>
                        <div class="badge badge-lg badge-neutral font-mono tracking-widest text-accent">${c.passcode}</div>
                    </td>
                    <td>
                        <div class="flex items-center gap-2">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-50" viewBox="0 0 20 20" fill="currentColor"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" /></svg>
                             ${c.student_count || 0}
                        </div>
                    </td>
                    <td>
                        <div class="tooltip" data-tip="Assigned Missions">
                             <span class="badge badge-sm badge-ghost">${(c.mission_ids || []).length}</span>
                        </div>
                    </td>
                    <td>
                        <div class="join">
                            <button class="btn btn-xs btn-outline join-item" onclick="editClassUI('${c.id}')">Edit</button>
                            <button class="btn btn-xs btn-outline join-item" onclick="manageStudentsUI('${c.passcode}')">Roster</button>
                            <button class="btn btn-xs btn-error btn-outline join-item" onclick="deleteClassUI('${c.id}')">X</button>
                        </div>
                    </td>
                </tr>`;
            });
            tbody.innerHTML = html;
        }

        // --- LIBRARY LOGIC ---
        async function fetchMissions() {
            // Mock data
            const mockMissions = [
                { id: "M001", name: "Cuban Missile Crisis", description: "Naval blockade simulation.", thumb: "https://images.unsplash.com/photo-1599839575945-a9e5af0c3fa5?auto=format&fit=crop&q=80&w=200" },
                { id: "M002", name: "Mars Colony v1", description: " Resource management failure scenario.", thumb: "https://images.unsplash.com/photo-1614728853970-32a2f51d15d6?auto=format&fit=crop&q=80&w=200" }
            ];

            if (SupabaseBridge.client) {
                try {
                    const realMissions = await SupabaseBridge.fetchMissions(googleUser?.email || 'GUEST');
                    currentMissions = realMissions.length ? realMissions : mockMissions;
                } catch (e) { }
            } else {
                currentMissions = mockMissions;
            }

            renderLibrary(currentMissions);
        }

        function renderLibrary(missions) {
            const grid = document.getElementById('hub-grid');
            if (!grid) return;

            const isUserAdmin = (typeof googleUser !== 'undefined' && googleUser?.email === 'dwaugh@gmail.com');

            let html = '';
            missions.forEach(m => {
                const deleteBtn = `<button class="btn btn-xs btn-error btn-outline opacity-0 group-hover:opacity-100 transition-opacity" onclick="event.stopPropagation(); deleteMission('${m.id}')">Delete</button>`;

                html += `
                <div class="card bg-base-100 shadow-xl image-full group cursor-pointer hover:scale-[1.02] transition-transform" onclick="loadMission('${m.id}')">
                    <figure><img src="${m.thumb || 'https://images.unsplash.com/photo-1451187580459-43490279c0fa'}" alt="Mission" class="opacity-40 group-hover:opacity-60 transition-opacity w-full h-48 object-cover" /></figure>
                    <div class="card-body p-4 justify-between">
                        <div>
                            <div class="flex justify-between items-start">
                                <h2 class="card-title text-sm text-white tracking-wider mb-1 line-clamp-1">${m.name}</h2>
                                ${deleteBtn}
                            </div>
                            <p class="text-[10px] text-base-200/80 line-clamp-2">${m.description || "No description available."}</p>
                        </div>
                        <div class="card-actions justify-between items-center mt-2">
                            <div class="badge badge-xs badge-ghost font-mono opacity-50">${m.id}</div>
                            <div class="flex gap-2">
                                <button class="btn btn-xs btn-primary" onclick="event.stopPropagation(); loadMission('${m.id}')">Load</button>
                            </div>
                        </div>
                    </div>
                </div>`;
            });

            if (!missions.length) html = `<div class="col-span-1 md:col-span-3 text-center opacity-50 p-10 font-mono text-xs">NO MISSION DATA DETECTED IN ARCHIVE.</div>`;
            grid.innerHTML = html;
        }

        async function handleFile(file) {
            if (!file) return;
            log(`Parsing local dossier: ${file.name}...`);
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const raw = e.target.result.trim();
                    // Robust Isolate: Find first { and last } to strip potential markdown or noise
                    const start = raw.indexOf('{');
                    const end = raw.lastIndexOf('}');
                    if (start === -1 || end === -1) throw new Error("No JSON object found.");

                    const data = JSON.parse(raw.substring(start, end + 1));
                    accumulatedData = data;

                    // Populate forgeHistory if possible
                    if (data.history) forgeHistory = data.history;

                    log("Legacy Dossier Loaded. Forge state stabilized.", "success");
                    alert("Local Mission Loaded into Forge Memory.");

                    // Switch to an active phase tab to show data
                    switchMainTab('forge');
                    updateForgeUI();
                } catch (err) {
                    log(`Parse Error: ${err.message}`, "error");
                    alert("Invalid Dossier format: " + err.message);
                }
            };
            reader.readAsText(file);
        }

        async function deleteMission(id) {
            const currentTeacher = googleUser?.email || TEACHER_HANDLE || 'GUEST';
            if (!confirm(`PERMANENT DELETION: Are you sure you want to scrub mission [${id}] from the record?`)) return;

            log(`SCRUBBING MISSION [${id}]...`);

            if (window.SupabaseBridge && SupabaseBridge.client) {
                try {
                    await SupabaseBridge.deleteMission(id, currentTeacher);
                    log(`Mission scrubbed from cloud: ${id}`, "success");
                    fetchMissions();
                } catch (e) {
                    log(`Deletion Failed: ${e.message}`, "error");
                }
            } else {
                log("Supabase not configured. Cannot delete from cloud.", "error");
            }
        }

        // --- CURRICULUM CONTEXT ---
        async function fetchCurriculum() {
            console.log("fetchCurriculum: Initiating load...");
            try {
                log("Synchronizing Curriculum Hub...");

                // 1. Load static curriculum.json (fast, cached)
                console.log("fetchCurriculum: Fetching curriculum.json");
                const res = await fetch("curriculum.json?v=" + Date.now());
                if (res.ok) {
                    window.curriculumData = await res.json();
                    console.log("fetchCurriculum: Local data loaded.", Object.keys(window.curriculumData));
                    log("Local Curriculum Loaded.", "success");
                } else {
                    console.warn("fetchCurriculum: curriculum.json fetch failed", res.status);
                    window.curriculumData = window.curriculumData || {};
                }

                // 2. Fetch from Supabase (extended library)
                if (window.SupabaseBridge && SupabaseBridge.client) {
                    try {
                        const outcomes = await SupabaseBridge.fetchAllOutcomes();
                        outcomes.forEach(o => {
                            if (!window.curriculumData[o.country]) window.curriculumData[o.country] = {};
                            if (!window.curriculumData[o.country][o.region]) window.curriculumData[o.country][o.region] = {};
                            if (!window.curriculumData[o.country][o.region][o.course]) window.curriculumData[o.country][o.region][o.course] = [];

                            let target = window.curriculumData[o.country][o.region][o.course];
                            if (!Array.isArray(target)) {
                                window.curriculumData[o.country][o.region][o.course] = [];
                                target = window.curriculumData[o.country][o.region][o.course];
                            }
                            if (!target.includes(o.description)) target.push(o.description);
                        });
                        log(`Cloud Curriculum Synced: ${outcomes.length} outcomes.`, "success");
                    } catch (e) {
                        log(`Cloud Sync Warning: ${e.message}`, "warning");
                    }
                }

                // 3. Merge Local "Custom Lab" outcomes (Legacy Port)
                const custom = JSON.parse(localStorage.getItem('blob_custom_curriculum')) || {};
                console.log("fetchCurriculum: Blending custom labs...", Object.keys(custom));
                Object.keys(custom).forEach(country => {
                    if (!window.curriculumData[country]) window.curriculumData[country] = {};
                    Object.keys(custom[country]).forEach(region => {
                        if (!window.curriculumData[country][region]) window.curriculumData[country][region] = {};
                        Object.keys(custom[country][region]).forEach(course => {
                            window.curriculumData[country][region][course] = custom[country][region][course];
                        });
                    });
                });

                log("Curriculum Hybridization Complete.");

                // Populate Country Select
                const sel = document.getElementById('f-country');
                if (sel) {
                    sel.innerHTML = `<option value="">-- SELECT COUNTRY --</option>`;
                    Object.keys(window.curriculumData).sort().forEach(c => {
                        sel.innerHTML += `<option value="${c}">${c}</option>`;
                    });
                }

                // Sticky Restoration
                window.isRestoringCurriculum = true;
                const savedCountry = localStorage.getItem('TM_FORGE_COUNTRY');
                if (savedCountry && window.curriculumData[savedCountry]) {
                    if (sel) sel.value = savedCountry;
                    updateForgeRegions();

                    const savedRegion = localStorage.getItem('TM_FORGE_REGION');
                    const rSel = document.getElementById('f-region');
                    if (savedRegion && window.curriculumData[savedCountry][savedRegion]) {
                        rSel.value = savedRegion;
                        updateForgeCourses();

                        const savedCourse = localStorage.getItem('TM_FORGE_COURSE');
                        const cSel = document.getElementById('f-course');
                        if (savedCourse && window.curriculumData[savedCountry][savedRegion][savedCourse]) {
                            cSel.value = savedCourse;
                            updateForgeOutcomes();
                        }
                    }
                }
                window.isRestoringCurriculum = false;

            } catch (e) {
                log("Curriculum Hub Failure: " + e.message, "error");
            }
        }

        function updateForgeRegions() {
            const country = document.getElementById('f-country').value;
            const rSel = document.getElementById('f-region');
            const cSel = document.getElementById('f-course');
            const outDiv = document.getElementById('f-outcomes');

            if (!window.isRestoringCurriculum) {
                localStorage.setItem('TM_FORGE_COUNTRY', country);
                localStorage.removeItem('TM_FORGE_REGION');
                localStorage.removeItem('TM_FORGE_COURSE');
            }

            rSel.innerHTML = `<option value="">-- SELECT REGION --</option>`;
            cSel.innerHTML = `<option value="">-- SELECT COURSE --</option>`;
            rSel.classList.add('hidden');
            cSel.classList.add('hidden');
            if (outDiv) outDiv.innerHTML = `<p class="text-center opacity-30 text-[0.6rem] py-4">SELECT COURSE TO LOAD OUTCOMES</p>`;

            if (!country || !window.curriculumData[country]) return;

            Object.keys(window.curriculumData[country]).sort().forEach(r => {
                rSel.innerHTML += `<option value="${r}">${r}</option>`;
            });
            rSel.classList.remove('hidden');
        }

        function updateForgeCourses() {
            const country = document.getElementById('f-country').value;
            const region = document.getElementById('f-region').value;
            const cSel = document.getElementById('f-course');

            if (!window.isRestoringCurriculum) {
                localStorage.setItem('TM_FORGE_REGION', region);
                localStorage.removeItem('TM_FORGE_COURSE');
            }

            cSel.innerHTML = `<option value="">-- SELECT COURSE --</option>`;
            cSel.classList.add('hidden');

            if (!region || !window.curriculumData[country][region]) return;

            Object.keys(window.curriculumData[country][region]).sort().forEach(c => {
                cSel.innerHTML += `<option value="${c}">${c}</option>`;
            });
            cSel.classList.remove('hidden');
        }

        function updateForgeOutcomes() {
            const country = document.getElementById('f-country').value;
            const region = document.getElementById('f-region').value;
            const course = document.getElementById('f-course').value;
            const outDiv = document.getElementById('f-outcomes');

            if (!window.isRestoringCurriculum) {
                localStorage.setItem('TM_FORGE_COURSE', course);
            }

            if (!course || !window.curriculumData[country][region][course]) {
                if (outDiv) outDiv.innerHTML = `<p class="text-center opacity-30 text-[0.6rem] py-4">SELECT COURSE TO LOAD OUTCOMES</p>`;
                return;
            }

            const outcomes = window.curriculumData[country][region][course];
            let html = '';
            outcomes.forEach((o, i) => {
                html += `
                <label class="flex gap-2 items-start p-2 hover:bg-base-200 rounded cursor-pointer transition-colors group">
                    <input type="checkbox" value="${o}" class="checkbox checkbox-primary checkbox-xs mt-0.5 outcome-check">
                    <span class="text-[0.7rem] leading-tight opacity-70 group-hover:opacity-100">${o}</span>
                </label>`;
            });
            if (outDiv) outDiv.innerHTML = html;
            log(`Loaded ${outcomes.length} outcomes for ${course}.`, "success");
        }

        // --- CUSTOM COURSE LOGIC ---
        function toggleCustomAdd() {
            const zone = document.getElementById('custom-add-zone');
            zone.classList.toggle('hidden');
        }

        async function saveCustomCourse() {
            const country = document.getElementById('custom-country').value.trim() || "CUSTOM_LAB";
            const region = document.getElementById('custom-region').value.trim() || "LOCAL";
            const name = document.getElementById('custom-course-name').value.trim();
            const raw = document.getElementById('custom-outcomes-raw').value;

            if (!name || !raw) return alert("MISSING PARAMETERS: Course Name and Outcomes are required.");

            const outcomes = raw.split("\n").map(o => o.trim()).filter(o => o.length > 0);

            // Save to LocalStorage
            const custom = JSON.parse(localStorage.getItem('blob_custom_curriculum')) || {};
            if (!custom[country]) custom[country] = {};
            if (!custom[country][region]) custom[country][region] = {};
            custom[country][region][name] = outcomes;
            localStorage.setItem('blob_custom_curriculum', JSON.stringify(custom));

            // Sync to Supabase
            if (SupabaseBridge.client) {
                try {
                    for (const outcome of outcomes) {
                        await SupabaseBridge.saveCustomOutcome(country, region, name, outcome);
                    }
                    log(`Custom Course [${name}] synced to Supabase.`, "success");
                } catch (e) {
                    log(`Sync Error: ${e.message}`, "error");
                }
            }

            alert("Course Saved to Lab. Refreshing curriculum...");
            fetchCurriculum();
        }

        // --- UI HELPERS ---
        function openSettings() {
            console.log("openSettings: Interaction Hook Fired.");
            try {
                const modal = document.getElementById('settings_modal');
                if (!modal) {
                    console.error("openSettings: Modal element 'settings_modal' missing from DOM.");
                    log("CRITICAL: settings_modal element missing.", "error");
                    return;
                }

                const ids = {
                    'cfg-vercel-proxy': 'TM_VERCEL_PROXY',
                    'cfg-gcp-key': 'TM_GCP_KEY',
                    'cfg-gcp-project': 'TM_GCP_PROJECT',
                    'cfg-gcp-location': 'TM_GCP_LOCATION',
                    'cfg-gcp-model': 'TM_GCP_MODEL',
                    'cfg-gcp-client-id': 'TM_GCP_CLIENT_ID',
                    'cfg-teacher-id': 'TM_TEACHER_HANDLE'
                };

                for (let [id, storageKey] of Object.entries(ids)) {
                    const el = document.getElementById(id);
                    if (el) {
                        let val = localStorage.getItem(storageKey) || '';
                        // Fallbacks for certain fields to match V2 defaults
                        if (!val && storageKey === 'TM_GCP_LOCATION') val = "us-central1";
                        if (!val && storageKey === 'TM_GCP_MODEL') val = "gemini-1.5-flash";
                        if (!val && storageKey === 'TM_GCP_CLIENT_ID') val = "985904065235-u0115ektel546fs42mar5rch46utkki6.apps.googleusercontent.com";

                        el.value = val;
                    }
                    else console.warn(`openSettings: Input field '${id}' missing.`);
                }

                modal.showModal();
                log("Opening System Configuration...");
            } catch (e) {
                console.error("openSettings: Execution Error", e);
                log("Settings Error: " + e.message, "error");
            }
        }

        function saveSettings() {
            try {
                const mappings = {
                    'cfg-vercel-proxy': 'TM_VERCEL_PROXY',
                    'cfg-gcp-key': 'TM_GCP_KEY',
                    'cfg-gcp-project': 'TM_GCP_PROJECT',
                    'cfg-gcp-location': 'TM_GCP_LOCATION',
                    'cfg-gcp-model': 'TM_GCP_MODEL',
                    'cfg-gcp-client-id': 'TM_GCP_CLIENT_ID',
                    'cfg-teacher-id': 'TM_TEACHER_HANDLE'
                };

                console.log("saveSettings: Starting save process...");
                for (let [id, storageKey] of Object.entries(mappings)) {
                    const el = document.getElementById(id);
                    if (el) {
                        let val = el.value.trim();
                        if (storageKey === 'TM_TEACHER_HANDLE') val = val.toUpperCase();
                        console.log(`saveSettings: Saving ${storageKey} = "${val.substring(0, 10)}..."`);
                        localStorage.setItem(storageKey, val);
                    } else {
                        console.warn(`saveSettings: Element '${id}' not found!`);
                    }
                }

                // Verify key was saved
                const savedKey = localStorage.getItem('TM_GCP_KEY');
                console.log("saveSettings: Verification - TM_GCP_KEY =", savedKey ? `${savedKey.substring(0, 8)}...` : "EMPTY");
                log(`Settings Saved. GCP Key: ${savedKey ? 'Stored' : 'MISSING'}`, savedKey ? "success" : "error");

                alert("Settings Saved. Refreshing to apply cloud credentials.");
                location.reload();
            } catch (e) {
                console.error("saveSettings Error:", e);
                alert("Failed to save settings: " + e.message);
            }
        }

        async function loadMission(id) {
            const mission = currentMissions.find(m => m.id === id);
            if (!mission) return log(`Mission ${id} not found locally.`, 'error');

            if (confirm(`Load mission "${mission.name}" into Forge? Current progress will be overwritten.`)) {
                // Determine phase based on completeness (Mock logic)
                accumulatedData = { metadata: mission, slides: [] };
                forgeHistory = [];
                currentPhaseIndex = 1; // Jump to Narrative as example
                updateForgeUI();
                switchMainTab('forge');
                addForgeChat('ai', `**MISSION LOADED: ${mission.name}**\nResuming architecture sequence at Phase: ${getCurrentPhase().label}.`);
            }
        }

        function resetForge() {
            if (!confirm("RESET ALL PROGRESS? This will clear the current forge session.")) return;
            forgeHistory = [];
            currentPhaseIndex = 0;
            accumulatedData = {
                metadata: {},
                slides: [],
                intelligenceGlossary: [],
                aiPromptsExtracted: false
            };
            localStorage.removeItem('TM_FORGE_HISTORY');
            localStorage.removeItem('TM_FORGE_DATA');

            const chat = document.getElementById('forge-chat');
            if (chat) {
                chat.innerHTML = `
                    <div class="chat chat-start">
                        <div class="chat-image avatar placeholder">
                            <div class="w-10 rounded-full bg-neutral text-neutral-content">
                                <span>AI</span>
                            </div>
                        </div>
                        <div class="chat-bubble chat-bubble-primary font-mono text-sm leading-relaxed">
                            <strong>SESSION RESET.</strong><br>
                            Forge systems purged. Ready for new curriculum context.
                        </div>
                    </div>`;
            }

            renderPipelineStepper();
            updateForgeUI();
            log("Forge session reset.", "warning");
        }

        async function editClassUI(id) {
            const newName = prompt("Enter new Class Name:");
            if (newName && window.SupabaseBridge && SupabaseBridge.client) {
                try {
                    await SupabaseBridge.updateClass(id, { class_name: newName });
                    log(`Class renamed to ${newName}`, 'success');
                    refreshClasses();
                } catch (e) { log(`Edit Failed: ${e.message}`, 'error'); }
            }
        }

        async function deleteClassUI(id) {
            if (!confirm("Delete this class? This will disconnect student connections.")) return;
            if (window.SupabaseBridge && SupabaseBridge.client) {
                try {
                    await SupabaseBridge.deleteClass(id);
                    log(`Class scrubbed from record.`, 'warning');
                    refreshClasses();
                } catch (e) { log(`Delete Failed: ${e.message}`, 'error'); }
            }
        }

        function manageStudentsUI(passcode) {
            alert(`Student Management for [${passcode}] is under construction in V3.\nPlease use the Legacy Dashboard for roster edits.`);
        }

        // --- PAGE INITIALIZATION ---
        window.onload = () => {
            // Initialize Supabase Bridge
            if (typeof SupabaseBridge !== 'undefined' && SB_URL && SB_KEY) {
                const connected = SupabaseBridge.init(SB_URL, SB_KEY);
                if (connected) {
                    const badge = document.getElementById('status-badge-sb');
                    if (badge) {
                        badge.innerHTML = `<div class="w-1.5 h-1.5 rounded-full bg-success"></div> SB_ONLINE`;
                        badge.classList.remove('badge-outline');
                        badge.classList.add('badge-success', 'text-white');
                    }
                    log("Supabase Uplink Established.", "success");
                }
            }

            initGoogleAuth();
            updateForgeUI();
            log("Command Center v3.0 Initialized.");
            refreshClasses();
            fetchMissions();
            fetchCurriculum();
        };
    </script>



</body>

</html>