<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>SITUATION ROOM // COMMAND CENTER</title>
    <!-- Tailwind CSS + DaisyUI via CDN -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Oswald:wght@700&display=swap"
        rel="stylesheet">
    <link rel="icon" type="image/png" href="images/logic_gear_logo.png">

    <!-- SYSTEM SCRIPTS -->
    <script src="config.js"></script>
    <script>
        // --- BOOTSTRAP CONFIGURATION (Global Infrastructure) ---
        const SB_URL = "https://zwujpkuguevnkcqrkhas.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp3dWpwa3VndWV2bmtjcXJraGFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczODA0NDQsImV4cCI6MjA4Mjk1NjQ0NH0.H9tVz_expVsE7VLLLLEsnTMVsm5PQ09r7KlLe85MirA";
        const TEACHER_HANDLE = localStorage.getItem('TM_TEACHER_HANDLE') || (typeof CONFIG !== 'undefined' ? CONFIG.TEACHER_ID : 'GUEST');
        let GOOGLE_CLIENT_ID = localStorage.getItem('TM_GCP_CLIENT_ID') || "985904065235-u0115ektel546fs42mar5rch46utkki6.apps.googleusercontent.com";
        const HARDWIRED_PROXY = "https://nextjs-basic-lemon-one.vercel.app/api/chat";

        // --- GLOBAL STATE (Restored for V3 Brains) ---
        let currentMissions = [];
        let currentClasses = [];
        let allProgress = [];
        let googleUser = null;
    </script>
    <script src="critical_crypto.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Quill Rich Text Editor (Legacy Port) -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script src="https://unpkg.com/turndown/dist/turndown.js"></script>
    <script src="supabase_bridge.js"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .font-display {
            font-family: 'Oswald', sans-serif;
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Legacy Scrollbar Patch */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0f0f0f;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Smooth Tabs Transition */
        .tab-content {
            transition: all 0.2s ease-in-out;
        }

        /* Dashboard Background Enhancement */
        #main-scroll-area {
            background:
                radial-gradient(ellipse at top, rgba(56, 189, 248, 0.03) 0%, transparent 50%),
                radial-gradient(ellipse at bottom right, rgba(168, 85, 247, 0.03) 0%, transparent 50%),
                linear-gradient(180deg, #0d0d0d 0%, #0a0a0a 100%);
        }

        /* Subtle grid overlay */
        #main-scroll-area::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image:
                linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
            z-index: 0;
        }

        #main-scroll-area>* {
            position: relative;
            z-index: 1;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
    </style>
</head>

<body class="min-h-screen bg-base-300 text-base-content overflow-hidden flex flex-col">

    <!-- TOP NAVBAR -->
    <div class="navbar bg-base-100 border-b border-base-content/10 px-4 h-16 flex-none z-50 shadow-md">
        <div class="flex-1 gap-4 flex items-center">
            <div class="flex items-center gap-3 mr-4">
                <img src="images/logic_gear_logo.png" class="h-8 w-8 drop-shadow-[0_0_5px_rgba(0,255,204,0.5)]">
                <div>
                    <h1 class="text-xl font-display tracking-widest text-primary leading-none">SITUATION ROOM</h1>
                    <button
                        class="btn btn-xs btn-ghost text-[0.6rem] font-mono opacity-50 tracking-widest hover:opacity-100 hidden"
                        onclick="openSettings()">COMMAND CENTER v3.0 // CONFIG</button>
                    <!-- HIDDEN CONSOLE REFERENCE FOR JS -->
                    <div id="log-parent" style="display:none;">
                        <div id="sm-console"></div>
                    </div>
                </div>
            </div>

            <!-- TAB NAVIGATION (MOVED FROM SIDEBAR) -->
            <div class="flex items-center gap-1 join">
                <button class="btn btn-sm btn-ghost font-bold join-item" onclick="switchMainTab('dashboard')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                    </svg>
                    DASHBOARD
                </button>
                <button class="btn btn-sm btn-ghost font-bold join-item" onclick="switchMainTab('Builder')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                    </svg>
                    BUILDER
                </button>
                <button class="btn btn-sm btn-ghost font-bold join-item" onclick="switchMainTab('classes')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                    CLASSES
                </button>
                <button class="btn btn-sm btn-ghost font-bold join-item" onclick="switchMainTab('library')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z" />
                    </svg>
                    LIBRARY
                </button>
            </div>

            <div class="flex-1"></div> <!-- Spacer -->

            <!-- GLOBAL STATUS BADGES -->
            <div class="flex gap-2">
                <div id="status-badge-sb" class="badge badge-outline badge-xs gap-1 font-mono">
                    <div class="w-1.5 h-1.5 rounded-full bg-error"></div> SB_OFFLINE
                </div>
                <div id="status-badge-auth" class="badge badge-outline badge-xs gap-1 font-mono opacity-50">
                    GUEST
                </div>
            </div>
        </div>

        <div class="flex-none gap-2">

            <div class="dropdown dropdown-end">
                <div tabindex="0" role="button" class="btn btn-ghost btn-circle avatar placeholder">
                    <div class="bg-neutral text-neutral-content rounded-full w-8">
                        <span id="user-avatar-initials">G</span>
                    </div>
                </div>
                <ul tabindex="0"
                    class="menu menu-sm dropdown-content mt-3 z-[1] p-2 shadow bg-base-100 rounded-box w-52">
                    <li><a onclick="openAuthModal()">Google Sign-In</a></li>
                    <li><a onclick="googleLogout()" class="text-error">Log Out</a></li>
                    <li><a onclick="toggleAboutModal()">About System</a></li>
                    <li><a onclick="document.documentElement.setAttribute('data-theme', 'light')">Light Mode</a></li>
                    <li><a onclick="document.documentElement.setAttribute('data-theme', 'dark')">Dark Mode</a></li>
                    <!-- Hidden Admin Access -->
                    <li><a onclick="openSettings()" class="text-xs opacity-20 hover:opacity-100">System Admin</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- MAIN APP SHELL -->
    <div class="flex-1 flex overflow-hidden">

        <!-- SIDEBAR NAVIGATION -->


        <!-- MAIN CONTENT AREA -->
        <div class="flex-1 bg-base-300 p-6 overflow-y-auto relative" id="main-scroll-area">

            <!-- VIEW: DASHBOARD (Command Center) -->
            <div id="view-dashboard" class="space-y-6 max-w-5xl mx-auto tab-view">

                <!-- 2x2 Command Center Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">

                    <!-- MISSION LIBRARY -->
                    <div class="card bg-gradient-to-br from-teal-900/80 via-cyan-900/60 to-slate-900 shadow-2xl h-48 group cursor-pointer transition-all hover:scale-[1.02] hover:shadow-accent/30 hover:shadow-2xl overflow-hidden relative"
                        onclick="switchMainTab('library')">
                        <div
                            class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1507842217343-583bb7270b66?w=800&auto=format&fit=crop')] bg-cover bg-center opacity-15 group-hover:opacity-25 transition-opacity">
                        </div>
                        <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent">
                        </div>
                        <div class="absolute -bottom-10 -left-10 w-32 h-32 bg-accent/20 rounded-full blur-3xl"></div>
                        <div class="card-body justify-between relative z-10">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-12 h-12 rounded-xl bg-accent/20 backdrop-blur-sm flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-accent" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                                    </svg>
                                </div>
                                <div>
                                    <h2
                                        class="card-title text-xl font-display tracking-wider text-accent drop-shadow-lg">
                                        MISSION LIBRARY</h2>
                                    <p class="text-xs text-white/60">Manage your simulation blobs</p>
                                </div>
                            </div>
                            <div class="flex justify-between items-end">
                                <div>
                                    <span class="text-3xl font-bold text-accent" id="dash-stat-missions">--</span>
                                    <span class="text-xs text-white/50 ml-1">Missions</span>
                                </div>
                                <button class="btn btn-sm bg-accent text-black hover:bg-accent/80 shadow-lg">Open
                                    Library →</button>
                            </div>
                        </div>
                    </div>

                    <!-- CLASS DIRECTORY -->
                    <div class="card bg-gradient-to-br from-pink-900/80 via-fuchsia-900/60 to-slate-900 shadow-2xl h-48 group cursor-pointer transition-all hover:scale-[1.02] hover:shadow-secondary/30 hover:shadow-2xl overflow-hidden relative"
                        onclick="switchMainTab('classes')">
                        <div
                            class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1523050854058-8df90110c9f1?w=800&auto=format&fit=crop')] bg-cover bg-center opacity-15 group-hover:opacity-25 transition-opacity">
                        </div>
                        <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent">
                        </div>
                        <div class="absolute -top-10 -right-10 w-32 h-32 bg-secondary/20 rounded-full blur-3xl"></div>
                        <div class="card-body justify-between relative z-10">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-12 h-12 rounded-xl bg-secondary/20 backdrop-blur-sm flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-secondary" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                                    </svg>
                                </div>
                                <div>
                                    <h2
                                        class="card-title text-xl font-display tracking-wider text-secondary drop-shadow-lg">
                                        CLASS DIRECTORY</h2>
                                    <p class="text-xs text-white/60">Manage student cohorts</p>
                                </div>
                            </div>
                            <div class="flex justify-between items-end">
                                <div>
                                    <span class="text-3xl font-bold text-secondary" id="dash-stat-classes">--</span>
                                    <span class="text-xs text-white/50 ml-1">Classes</span>
                                    <span class="text-lg font-bold text-secondary/60 ml-3"
                                        id="dash-stat-students">--</span>
                                    <span class="text-xs text-white/50 ml-1">Students</span>
                                </div>
                                <button class="btn btn-sm bg-secondary text-black hover:bg-secondary/80 shadow-lg">Open
                                    Classes →</button>
                            </div>
                        </div>
                    </div>

                    <!-- MISSION BUILDER (Hero Card) -->
                    <div class="card bg-gradient-to-br from-primary/90 via-indigo-600 to-purple-800 shadow-2xl h-48 group cursor-pointer transition-all hover:scale-[1.02] hover:shadow-primary/30 hover:shadow-2xl overflow-hidden relative"
                        onclick="switchMainTab('Builder')">
                        <!-- Decorative background -->
                        <div
                            class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1451187580459-43490279c0fa?w=800&auto=format&fit=crop')] bg-cover bg-center opacity-20 group-hover:opacity-30 transition-opacity">
                        </div>
                        <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent">
                        </div>
                        <div
                            class="absolute -top-20 -right-20 w-48 h-48 bg-white/10 rounded-full blur-3xl group-hover:bg-white/20 transition-colors">
                        </div>

                        <div class="card-body justify-between relative z-10">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-12 h-12 rounded-xl bg-white/20 backdrop-blur-sm flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                                    </svg>
                                </div>
                                <div>
                                    <h2
                                        class="card-title text-xl font-display tracking-wider text-white drop-shadow-lg">
                                        MISSION BUILDER</h2>
                                    <p class="text-white/70 text-xs">AI-Powered Curriculum Design</p>
                                </div>
                            </div>
                            <div class="flex justify-between items-end">
                                <p class="text-white/80 text-sm max-w-[60%]">Create engaging, interactive lessons with
                                    your AI curriculum partner.</p>
                                <button class="btn btn-sm bg-white text-primary hover:bg-white/90 shadow-lg">+ Start
                                    Creating</button>
                            </div>
                        </div>
                    </div>

                    <!-- CLASSROOM DISPLAY -->
                    <div class="card bg-gradient-to-br from-sky-900/80 via-blue-900/60 to-slate-900 shadow-2xl h-48 group cursor-pointer transition-all hover:scale-[1.02] hover:shadow-info/30 hover:shadow-2xl overflow-hidden relative"
                        onclick="toggleProjector()">
                        <div
                            class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1517694712202-14dd9538aa97?w=800&auto=format&fit=crop')] bg-cover bg-center opacity-15 group-hover:opacity-25 transition-opacity">
                        </div>
                        <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent">
                        </div>
                        <div class="absolute -bottom-10 -right-10 w-32 h-32 bg-info/20 rounded-full blur-3xl"></div>
                        <div class="card-body justify-between relative z-10">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-12 h-12 rounded-xl bg-info/20 backdrop-blur-sm flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-info" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                    </svg>
                                </div>
                                <div>
                                    <h2 class="card-title text-xl font-display tracking-wider text-info drop-shadow-lg">
                                        CLASSROOM DISPLAY</h2>
                                    <p class="text-xs text-white/60">Projector / Live View</p>
                                </div>
                            </div>
                            <div class="flex justify-between items-end">
                                <p class="text-sm text-white/70 max-w-[60%]">Present missions to your students in
                                    real-time on the big screen.</p>
                                <button class="btn btn-sm bg-info text-black hover:bg-info/80 shadow-lg">Launch
                                    Projector →</button>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Footer Status Bar -->
                <div
                    class="flex flex-wrap justify-between items-center gap-4 p-4 bg-base-200/50 rounded-box border border-base-content/5 mt-4">
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2">
                            <span class="text-xs opacity-50 font-display tracking-wide">TEACHER CODE:</span>
                            <span class="font-mono font-bold text-info" id="dash-stat-teacher-code">AUTH REQUIRED</span>
                            <button class="btn btn-xs btn-ghost opacity-50 hover:opacity-100"
                                onclick="copyTeacherCode()" title="Copy Code">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                </svg>
                            </button>
                        </div>
                        <span class="text-xs opacity-30" id="dash-stat-teacher-desc"></span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-success animate-pulse"></div>
                        <span class="text-xs font-mono text-success">CLOUD SYNC ACTIVE</span>
                    </div>
                </div>

            </div>

            <!-- VIEW: Builder (Placeholder for Logic Transplant) -->
            <div id="view-Builder" class="hidden tab-view min-h-full flex flex-col">
                <!-- Builder Header -->
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-display tracking-widest text-primary flex items-center gap-2">
                            MISSION BUILDER
                            <div class="badge badge-warning badge-sm font-mono align-top animate-pulse">AI ALPHA</div>
                        </h2>
                        <p class="text-sm opacity-60">Modular Mission Construction Pipeline</p>
                    </div>
                    <!-- Pipeline Stepper Container (matches Logic ID) -->
                    <div id="pipeline-stepper" class="steps">
                        <!-- Injected by JS -->
                    </div>
                </div>

                <!-- Builder Main Area -->
                <div
                    class="bg-base-100 rounded-xl shadow-xl border border-base-content/10 overflow-hidden relative flex flex-col lg:flex-row h-auto lg:h-[max(600px,calc(100vh-250px))]">

                    <!-- Builder Panel (Inputs) -->
                    <div id="Builder-panel"
                        class="w-full lg:w-96 lg:min-w-[384px] border-b lg:border-b-0 lg:border-r border-base-content/10 p-6 flex flex-col gap-4 overflow-y-auto overflow-x-hidden bg-base-200/50 h-[500px] lg:h-full custom-scrollbar">
                        <div class="flex justify-between items-end">
                            <span class="text-xs font-bold tracking-widest text-primary">CURRENT PHASE</span>
                            <div class="flex gap-1">
                                <button class="btn btn-ghost btn-xs px-1" onclick="resetBuilder()">RESET</button>
                                <button class="btn btn-ghost btn-xs px-1" onclick="saveIdea()">SAVE</button>
                                <button class="btn btn-ghost btn-xs px-1" onclick="openIdeaLoader()">LOAD</button>
                            </div>
                            <button class="btn btn-secondary btn-outline btn-xs gap-1" onclick="openHospital()">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path
                                        d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                                    <path fill-rule="evenodd"
                                        d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"
                                        clip-rule="evenodd" />
                                </svg>
                                WORKSHOP
                            </button>
                        </div>
                        <h2 id="Builder-title"
                            class="text-xl md:text-2xl lg:text-3xl font-display uppercase leading-tight">INITIALIZING...
                        </h2>
                        <p id="Builder-desc" class="text-sm opacity-70 mb-4">Establishing secure connection to neural
                            core...</p>

                        <!-- Dynamic Input Zones -->
                        <div id="curriculum-zone" class="card bg-base-100 border border-base-300 p-4 shadow-sm text-sm">
                            <div class="flex justify-between mb-2">
                                <span class="font-bold text-xs uppercase opacity-50">Learning Outcomes</span>
                            </div>
                            <!-- Selects (IDs match old logic) -->
                            <select id="f-country" class="select select-bordered select-xs w-full mb-2"
                                onchange="updateBuilderRegions()">
                                <option value="">Select Country...</option>
                            </select>
                            <select id="f-region" class="select select-bordered select-xs w-full mb-2 hidden"
                                onchange="updateBuilderCourses()"></select>
                            <select id="f-course" class="select select-bordered select-xs w-full mb-2 hidden"
                                onchange="updateBuilderOutcomes()"></select>

                            <input type="hidden" id="f-model" value="xiaomi/mimo-v2-flash:free">

                            <div class="divider text-[0.6rem] opacity-30 my-1 flex items-center justify-between">
                                <span>TARGET OUTCOMES</span>
                                <button class="btn btn-ghost btn-xs text-[9px] opacity-60 hover:opacity-100"
                                    onclick="toggleAllOutcomes()">SELECT ALL</button>
                            </div>
                            <div id="f-outcomes" class="max-h-40 overflow-y-auto space-y-1 pr-2 custom-scrollbar">
                                <p class="text-center opacity-30 text-[0.6rem] py-4">SELECT COURSE TO LOAD OUTCOMES</p>
                            </div>

                            <!-- Custom Add Lab (Legacy Port) -->
                            <div id="custom-add-zone" class="mt-4 pt-4 border-t border-base-content/10 hidden">
                                <div class="space-y-2">
                                    <input id="custom-country" type="text" placeholder="COUNTRY (e.g. Canada)"
                                        class="input input-bordered input-xs w-full">
                                    <input id="custom-region" type="text" placeholder="REGION (e.g. Ontario)"
                                        class="input input-bordered input-xs w-full">
                                    <input id="custom-course-name" type="text" placeholder="COURSE NAME"
                                        class="input input-bordered input-xs w-full">
                                    <textarea id="custom-outcomes-raw" placeholder="OUTCOMES (ONE PER LINE)"
                                        class="textarea textarea-bordered textarea-xs w-full h-20"></textarea>
                                    <button class="btn btn-xs btn-primary w-full" onclick="saveCustomCourse()">SAVE TO
                                        LOCAL LAB</button>
                                </div>
                            </div>
                            <div class="text-center mt-2">
                                <button id="custom-toggle-btn" onclick="toggleCustomAdd()"
                                    class="btn btn-link btn-xs no-underline opacity-50 hover:opacity-100">+ ADD CUSTOM
                                    COURSE</button>
                            </div>
                        </div>

                        <div class="form-control flex-1">
                            <textarea id="f-input"
                                class="textarea textarea-bordered h-full font-mono text-sm leading-relaxed"
                                placeholder="Enter command context..."></textarea>
                        </div>

                        <div class="flex flex-wrap gap-2 mt-auto">
                            <button class="btn btn-neutral btn-sm flex-1" onclick="BuilderBack()">Back</button>
                            <button id="f-submit" class="btn btn-primary btn-sm flex-1"
                                onclick="processBuilder()">Submit
                                Command</button>
                            <button id="f-next-phase" class="btn btn-success btn-sm flex-1 gap-1"
                                onclick="advancePhase()">
                                Authorize Next →
                            </button>
                        </div>
                    </div>

                    <!-- Builder Output (Chat) -->
                    <div id="Builder-output" class="flex-1 bg-base-100 relative flex flex-col">
                        <div id="Builder-chat" class="flex-1 p-6 overflow-y-auto space-y-4">
                            <div class="chat chat-start">
                                <div class="chat-image avatar placeholder">
                                    <div class="w-10 rounded-full bg-neutral text-neutral-content">
                                        <span>AI</span>
                                    </div>
                                </div>
                                <div class="chat-bubble chat-bubble-primary font-mono text-sm">
                                    <strong>Hello, Teacher!</strong><br>
                                    I'm here to help you create an engaging lesson. Start by selecting your curriculum
                                    context, then tell me about the topic you'd like to explore.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Builder Loading Overlay -->
                    <div id="Builder-loader"
                        class="absolute inset-0 bg-black/70 flex-col items-center justify-center z-50 hidden"
                        style="display:none;">
                        <span class="loading loading-spinner loading-lg text-primary mb-4"></span>
                        <span id="Builder-loader-text"
                            class="text-primary font-display text-sm tracking-widest animate-pulse">PROCESSING...</span>
                    </div>

                </div>
            </div>

            <!-- VIEW: CLASS DIRECTORY -->
            <div id="view-classes" class="hidden tab-view max-w-7xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-display tracking-widest text-secondary">CLASS DIRECTORY</h2>
                        <p class="text-sm opacity-60" id="class-count-header">Manage student cohorts and assigned
                            missions.</p>
                    </div>
                    <button class="btn btn-secondary gap-2" onclick="registerClass()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        New Class
                    </button>
                </div>

                <div class="card bg-base-100 shadow-xl border border-base-content/10">
                    <div class="overflow-x-auto">
                        <table class="table table-zebra w-full" id="class-table-v3">
                            <thead>
                                <tr class="bg-base-200 uppercase text-xs font-bold tracking-wider opacity-70">
                                    <th>Class Name</th>
                                    <th>Access Code</th>
                                    <th>Students</th>
                                    <th>Missions</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="class-directory-list-body">
                                <!-- JS Injects Rows Here -->
                                <tr>
                                    <td colspan="5" class="text-center py-8 opacity-50">Loading class registry...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW: LIBRARY -->
            <div id="view-library" class="hidden tab-view max-w-7xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-display tracking-widest text-accent">MISSION LIBRARY</h2>
                        <p class="text-sm opacity-60">Archive of all generated and deployed simulations.</p>
                    </div>
                    <div class="flex gap-2">
                        <button class="btn btn-outline btn-sm" onclick="fetchMissions()">Refresh</button>
                        <button class="btn btn-secondary btn-sm gap-2" onclick="toggleCommunityHub()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                            </svg>
                            COMMUNITY HUB
                        </button>
                        <button class="btn btn-accent btn-sm gap-2"
                            onclick="document.getElementById('file-input').click()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                            </svg>
                            Upload .BLOB
                        </button>
                        <input type="file" id="file-input" accept=".blob" class="hidden"
                            onchange="handleFile(this.files[0])">
                    </div>
                </div>

                <div id="hub-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- JS Injects Mission Cards Here -->
                </div>
            </div>

        </div>
    </div>

    <!-- Hidden Modals (DaisyUI Format) -->

    <!-- COMMUNITY HUB MODAL -->
    <dialog id="community_hub_modal" class="modal">
        <div class="modal-box bg-base-100 border border-secondary/30 max-w-5xl w-11/12">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="font-bold text-xl font-display text-secondary tracking-widest">COMMUNITY ARCHIVE HUB</h3>
                    <p class="text-xs opacity-50 font-mono">Approved missions available to all teachers</p>
                </div>
                <div class="flex gap-2">
                    <button class="btn btn-sm btn-outline btn-secondary"
                        onclick="fetchCommunityLibrary()">REFRESH</button>
                    <form method="dialog"><button class="btn btn-sm btn-ghost">CLOSE</button></form>
                </div>
            </div>
            <div id="community-hub-grid"
                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[60vh] overflow-y-auto">
                <div class="col-span-full text-center opacity-30 py-20">Loading Community Catalog...</div>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <!-- SETTINGS MODAL -->
    <dialog id="settings_modal" class="modal">
        <div class="modal-box bg-base-100 border border-base-content/10">
            <div class="space-y-4">
                <div class="form-control">
                    <label class="label"><span
                            class="label-text text-xs font-bold opacity-70 text-success uppercase tracking-widest">Global
                            AI Proxy (Hardwired)</span></label>
                    <div
                        class="bg-black/20 p-2 rounded border border-white/5 font-mono text-[10px] opacity-60 truncate">
                        https://nextjs-basic-lemon-one.vercel.app/api/chat
                    </div>
                </div>

                <div class="divider text-xs opacity-50">CLARK DIRECT (BACKUP)</div>

                <div class="form-control">
                    <label class="label"><span class="label-text text-xs font-bold opacity-70">GOOGLE CLOUD API KEY
                            (Gemini)</span></label>
                    <input type="password" id="cfg-gcp-key"
                        class="input input-bordered input-sm font-mono tracking-widest text-xs" placeholder="AIZA...">
                </div>

                <div class="form-control">
                    <label class="label"><span class="label-text text-xs font-bold opacity-70">GCP PROJECT
                            ID</span></label>
                    <input type="text" id="cfg-gcp-project" class="input input-bordered input-sm font-mono text-xs"
                        placeholder="my-project-123">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div class="form-control">
                        <label class="label"><span
                                class="label-text text-xs font-bold opacity-70">LOCATION</span></label>
                        <input type="text" id="cfg-gcp-location" class="input input-bordered input-sm font-mono text-xs"
                            placeholder="us-central1">
                    </div>
                    <div class="form-control">
                        <label class="label"><span class="label-text text-xs font-bold opacity-70">MODEL</span></label>
                        <input type="text" id="cfg-gcp-model" class="input input-bordered input-sm font-mono text-xs"
                            placeholder="gemini-1.5-flash">
                    </div>
                </div>

                <div class="divider text-xs opacity-50">IDENTITY & DATABASE</div>

                <div class="form-control">
                    <label class="label"><span class="label-text text-xs font-bold opacity-70">TEACHER HANDLE (Optional
                            Alias)</span></label>
                    <input type="text" id="cfg-teacher-handle"
                        class="input input-bordered input-sm font-mono tracking-widest text-xs"
                        placeholder="Use Email (Default)">
                    <label class="label">
                        <span class="label-text-alt text-warning text-[10px] leading-tight">
                            <strong class="text-xs">⚠️ PRIVACY MODE:</strong> Setting this creates a separate
                            "Universe".
                            Missions saved under your email will be hidden until you clear this field.
                            Students must use this exact handle to join.
                        </span>
                    </label>
                </div>


                <div class="form-control">
                    <label class="label"><span class="label-text text-xs font-bold opacity-70">TEACHER HANDLE
                            (ID)</span></label>
                    <input type="text" id="cfg-teacher-id"
                        class="input input-bordered input-sm font-mono text-xs uppercase" placeholder="SMITH_01">
                </div>

                <div class="divider text-xs opacity-50 uppercase">Builder Settings</div>
                <div class="form-control">
                    <label class="label"><span class="label-text text-xs font-bold opacity-70">AI MODEL
                            (BUILDER)</span></label>
                    <select id="cfg-builder-model" class="select select-bordered select-sm font-mono text-xs">
                        <option value="xiaomi/mimo-v2-flash:free" selected>Xiaomi MiMo V2 (China)</option>
                        <option value="google/gemini-2.0-flash-exp:free">Gemini 2.0 Flash (Exp)</option>
                        <option value="mistralai/devstral-2512:free">Mistral 2512 (France)</option>
                        <option value="nvidia/nemotron-nano-9b-v2:free">Nemotron Nano (US)</option>
                        <option value="meta-llama/llama-3.2-3b-instruct:free">Llama 3.2 3B (US)</option>
                        <option value="openai/gpt-4o">GPT-4o (Standard)</option>
                        <option value="anthropic/claude-3-5-sonnet">Claude 3.5 Sonnet</option>
                    </select>
                </div>

                <div class="divider text-xs opacity-50 uppercase">Global Data Link</div>
                <div class="form-control">
                    <label class="label"><span class="label-text text-xs font-bold opacity-70">SUPABASE
                            UPLINK</span></label>
                    <div class="bg-black/20 p-2 rounded border border-white/5 font-mono text-[10px] opacity-60">
                        https://zwujpkuguevnkcqrkhas...
                    </div>
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text text-xs font-bold opacity-70">GCP CLIENT ID
                            (Auth)</span></label>
                    <input type="text" id="cfg-gcp-client-id" class="input input-bordered input-sm font-mono text-xs"
                        placeholder="9859...apps.googleusercontent.com">
                </div>
            </div>

            <div class="modal-action">
                <button class="btn btn-ghost btn-sm"
                    onclick="document.getElementById('settings_modal').close()">Cancel</button>
                <button class="btn btn-primary btn-sm" onclick="saveSettings()">SAVE CONFIG</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <!-- AUTH MODAL -->
    <dialog id="auth_modal" class="modal modal-bottom sm:modal-middle">
        <div class="modal-box bg-base-100 border border-primary/20">
            <h3 class="font-bold text-lg font-display text-primary tracking-widest text-center mb-4">IDENTITY
                VERIFICATION</h3>
            <div id="google-signin-container" class="flex justify-center my-4"></div>
            <p class="py-4 text-center text-xs opacity-60">Secure Teacher Access Required</p>
        </div>
    </dialog>

    <!-- HOSPITAL MODAL (Node Editor) -->
    <!-- HOSPITAL MODAL (SURGICAL THEATER) -->
    <dialog id="hospital_modal" class="modal modal-bottom sm:modal-middle">
        <div
            class="modal-box w-11/12 max-w-7xl h-[90vh] bg-base-100 border border-secondary/20 p-0 flex flex-col overflow-hidden">
            <!-- Modal Header -->
            <div
                class="bg-base-200 px-6 py-4 border-b border-base-content/10 flex justify-between items-center shrink-0">
                <div>
                    <h3 class="font-bold text-lg font-display tracking-widest text-secondary flex items-center gap-2">
                        MISSION HOSPITAL <span class="badge badge-outline badge-xs font-mono opacity-50">SURGICAL
                            THEATER</span>
                    </h3>
                    <div id="h-path" class="text-[9px] font-mono opacity-40 uppercase tracking-widest mt-1">NODE:
                        SELECTION_REQUIRED</div>
                </div>
                <div class="flex gap-2">
                    <button class="btn btn-sm btn-ghost" onclick="closeHospital()">CANCEL</button>
                    <button class="btn btn-sm btn-outline btn-info font-bold" onclick="downloadBirthedBlob()">DOWNLOAD
                        .BLOB</button>
                    <button class="btn btn-sm btn-secondary font-bold" onclick="saveHospitalChanges()">SAVE
                        CHANGES</button>
                    <button class="btn btn-sm btn-accent font-bold" onclick="finalizeForge()">FINALIZE MISSION</button>
                </div>
            </div>

            <div class="flex-1 flex overflow-hidden">
                <!-- Node Navigator Sidebar -->
                <div class="w-64 bg-base-200/50 border-r border-base-content/10 flex flex-col overflow-hidden shrink-0">
                    <div
                        class="p-3 text-[10px] font-bold opacity-30 uppercase tracking-widest border-b border-base-content/5">
                        Surgical Nodes</div>
                    <div class="flex-1 overflow-y-auto p-2" id="h-node-list">
                        <!-- Injected Nodes -->
                    </div>
                </div>

                <!-- Main Theatre Area -->
                <div class="flex-1 flex overflow-hidden" id="h-theatre-main">
                    <!-- Left: Visual Monitor -->
                    <div class="w-80 border-r border-base-content/10 flex flex-col p-4 bg-black/10 shrink-0">
                        <div class="text-[10px] font-bold text-secondary tracking-widest uppercase opacity-50 mb-3">
                            Visual Sensor Feed</div>
                        <div id="h-visual-preview"
                            class="bg-black/60 rounded border border-white/5 aspect-video flex items-center justify-center overflow-hidden mb-4 shadow-inner">
                            <span class="text-xs opacity-20 font-mono">NO SIGNAL</span>
                        </div>
                        <div class="flex-1 overflow-y-auto space-y-4 pr-1 scrollbar-thin">
                            <div class="form-control" id="h-field-title-wrap">
                                <label class="label py-0"><span
                                        class="label-text-alt text-[9px] font-bold opacity-40 uppercase">Display
                                        Title</span></label>
                                <input type="text" id="h-title" class="input input-bordered input-xs font-display h-8"
                                    placeholder="Node Heading">
                            </div>
                            <div class="form-control" id="h-field-media-wrap">
                                <label class="label py-0"><span
                                        class="label-text-alt text-[9px] font-bold opacity-40 uppercase">Media Link
                                        (JPG/YT/PDF)</span></label>
                                <input type="text" id="h-media-url"
                                    class="input input-bordered input-xs font-mono text-[9px] h-8 text-success"
                                    onchange="updateHospitalPreview(this.value)">
                            </div>
                            <div class="form-control" id="h-field-choices-wrap">
                                <label class="label py-0"><span
                                        class="label-text-alt text-[9px] font-bold opacity-40 uppercase">Surgical
                                        Options</span></label>
                                <div class="grid grid-cols-2 gap-1">
                                    <input type="text" id="h-choice-a" class="input input-bordered input-xs text-[10px]"
                                        placeholder="Option Alpha">
                                    <input type="text" id="h-choice-b" class="input input-bordered input-xs text-[10px]"
                                        placeholder="Option Beta">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Operating Region -->
                    <div class="flex-1 flex flex-col overflow-hidden bg-base-100">
                        <!-- Interaction Tabs -->
                        <div
                            class="bg-base-300/80 p-1 flex justify-between items-center border-b border-base-content/10">
                            <div class="flex gap-1" id="h-tabs-nav">
                                <!-- Injected Tabs -->
                            </div>
                            <div class="text-[9px] font-mono opacity-30 mr-2 uppercase" id="h-node-type">Node Type:
                                Generic</div>
                        </div>

                        <!-- Content Theatre -->
                        <div class="flex-1 overflow-hidden flex flex-col relative">
                            <!-- Rich Text Editor -->
                            <div id="h-editor-wrap" class="flex-1 flex flex-col overflow-hidden">
                                <div id="quill-editor" class="flex-1"></div>
                            </div>
                            <!-- Metadata/Glossary Forms -->
                            <div id="h-form-wrap" class="absolute inset-0 bg-base-100 overflow-y-auto p-6 hidden">
                                <!-- Injected Forms -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
        </div>
        </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <!-- INTEL MODAL (Narrative Viewer) -->
    <dialog id="intel_modal" class="modal">
        <div class="modal-box bg-base-100 border border-primary/20 max-w-2xl">
            <h3 id="intel-modal-title"
                class="font-bold text-lg font-display text-primary tracking-widest mb-4 uppercase">SLIDE INTEL</h3>
            <div id="intel-modal-content"
                class="prose prose-sm font-mono text-sm leading-relaxed max-h-[60vh] overflow-y-auto bg-black/20 p-4 rounded border border-white/5">
                <!-- Injected content -->
            </div>
            <div class="modal-action">
                <form method="dialog">
                    <button class="btn btn-sm btn-ghost">CLOSE</button>
                </form>
            </div>
        </div>
    </dialog>

    <!-- MISSION ASSIGNMENT MODAL -->
    <dialog id="mission_assignment_modal" class="modal">
        <div class="modal-box bg-base-100 border border-base-content/10">
            <h3 class="font-bold text-lg font-display tracking-widest mb-2">DOSSIER ASSIGNMENT</h3>
            <p id="assignment-class-info" class="text-[0.6rem] font-mono opacity-50 mb-4"></p>

            <div id="assignment-list"
                class="max-h-64 overflow-y-auto space-y-1 mb-6 border border-base-content/10 p-2 rounded bg-base-200/30">
                <!-- Mission List Injected Here -->
            </div>

            <div class="modal-action">
                <button class="btn btn-sm btn-ghost"
                    onclick="document.getElementById('mission_assignment_modal').close()">Cancel</button>
                <button class="btn btn-sm btn-primary" onclick="saveMissionAssignment()">Update Assignments</button>
            </div>
        </div>
    </dialog>

    <script>
        // --- INTEL VIEWER LOGIC ---
        function openIntelModal(slideIdx) {
            const slide = accumulatedData.slides[slideIdx];
            if (!slide) return;

            const modal = document.getElementById('intel_modal');
            const title = document.getElementById('intel-modal-title');
            const content = document.getElementById('intel-modal-content');

            const slideTitle = slide.title || slide.shortTitle || `Slide ${slideIdx + 1}`;
            title.innerText = `INTEL: ${slideTitle.toUpperCase()}`;

            // Show content, prefer tabs.primary.content then brief/content
            const fullContent = slide.tabs?.primary?.content || slide.content || slide.brief || "*NO NARRATIVE DATA DETECTED*";
            content.innerHTML = (typeof marked !== 'undefined') ? marked.parse(fullContent) : fullContent;

            modal.showModal();
        }

        // --- UX GLUE CODE (V3) ---

        function switchMainTab(tabName) {
            // Hide all views
            document.querySelectorAll('.tab-view').forEach(el => el.classList.add('hidden'));

            // Show target
            document.getElementById(`view-${tabName}`).classList.remove('hidden');

            // Update Sidebar Active State
            document.querySelectorAll('.menu a').forEach(el => el.classList.remove('active'));
            // (Simplified: In prod, map tabName to index or specific ID)
        }

        function log(msg, type = 'info') {
            const c = document.getElementById('sm-console');
            const time = new Date().toLocaleTimeString();
            let color = 'text-base-content';
            if (type === 'error') color = 'text-error';
            if (type === 'success') color = 'text-success';
            if (type === 'warning') color = 'text-warning';

            c.innerHTML += `<div class="${color} hover:bg-base-content/5 px-1 rounded font-mono">> [${time}] ${msg}</div>`;
            c.scrollTop = c.scrollHeight;
        }

        function toggleSystemLog() {
            const parent = document.getElementById('log-parent');
            const console = document.getElementById('sm-console');
            const btn = document.getElementById('log-toggle-btn');
            const isShrunk = parent.classList.contains('flex-none');

            if (isShrunk) {
                parent.classList.remove('flex-none', 'h-10');
                parent.classList.add('flex-1');
                console.classList.remove('hidden');
                btn.innerText = 'SHRINK';
            } else {
                parent.classList.remove('flex-1');
                parent.classList.add('flex-none', 'h-10');
                console.classList.add('hidden');
                btn.innerText = 'EXPAND';
            }
        }

        // Overwrite legacy Alert logic with DaisyUI Toasts (if we had them implemented fully, for now just custom log)
        // window.alert = function(msg) { log(`ALERT: ${msg}`, 'warning'); }
    </script>

    <!-- CORE LOGIC TRANSPLANT -->
    <script>
        // --- GLOBAL STATE ---
        let accumulatedData = {
            metadata: {},
            slides: [],
            intelligenceGlossary: {},
            aiPromptsExtracted: false
        };

        // --- Builder PIPELINE CONFIG ---
        const Builder_PHASES = {
            'brainstorm': { id: 'brainstorm', title: "MISSION BRAINSTORM", label: "INTEL", desc: "Define core learning objectives and scenario parameters.", prompt: "Analyze the requested curriculum parameters. Suggest 3 distinct, high-stakes mission scenarios that fit the topic. Focus on 'Situation Room' style dilemmas." },
            'research': { id: 'research', title: "DEEP SEARCH INTEL", label: "RESEARCH", desc: "Gather real-world context and source material.", prompt: "Identify key historical or geopolitical events relevant to the chosen scenario. Suggest search queries." },
            'narrative': { id: 'narrative', title: "NARRATIVE ARCHITECTURE", label: "BRIEF", desc: "Structuring the mission beat-sheet.", prompt: "Develop the chosen scenario into a 10-slide beat sheet. SLIDE 1: Briefing, SLIDES 2-9: Incidents/Intel, SLIDE 10: Final Decision." },
            'scripting': { id: 'scripting', title: "MISSION SCRIPTING", label: "TEXT", desc: "Drafting the full slide content.", prompt: "Write the detailed content for each of the 10 slides. Include the 'Situation Report' text, the 'Intel Data' to be displayed, and the specific 'Action Options' for the students." },
            'assets': { id: 'assets', title: "VISUAL ASSETS", label: "VISUALS", desc: "Generating field imagery and evidence.", prompt: "Suggest image prompts for each slide. Focus on 'satellite view', 'CCTV footage', 'classified documents', and 'tactical maps'." },
            'deploy': { id: 'deploy', title: "FINAL ASSEMBLY", label: "DEPLOY", desc: "Compile and publish mission dossier.", prompt: "Finalize the JSON structure." }
        };

        const Builder_SYSTEM_CORE = `YOU ARE 'MOTHER', A SUPPORTIVE CURRICULUM DESIGN PARTNER.
Your goal is to help teachers build engaging, thought-provoking educational simulations ("Missions") for students.
Tone: Warm, helpful, encouraging - like a knowledgeable colleague.
Address the user as "Teacher" or by their role. Celebrate their ideas and offer constructive suggestions.

SAFETY & ETHICS PROTOCOLS (STRICT ENFORCEMENT):
1. REFUSAL RULES: Do NOT generate scenarios involving: Sexual violence, Holocaust realization, "Slavery" as a game mechanic, Canadian Residential Schools, or any scenario where students play as oppressors or victims of trauma.
2. ROLE RULES: Students MUST NOT play as Nazis, Soviet Leaders, Terrorists, or advocates for crimes against humanity. They must operate as ethical decision-makers (Commanders, Scientists, Diplomats).
3. CONTENT: Ensure all scenarios are age-appropriate and focused on critical thinking, not shock value.

Output: Clear, well-structured, practical.
Format: Use Markdown. Use **bold** for key terms and concepts.`;

        let BuilderPipeline = ['brainstorm', 'research', 'narrative', 'scripting', 'assets', 'deploy'];
        let currentPhaseIndex = 0;
        let BuilderHistory = [];

        // --- PROXY CONFIG ---
        // Placeholder for direct AI calls. Real implementation would likely use `callGoogleImageAPI` or similar structure from original file.
        // For V3 v1.0, we will assume the environment provides a 'callAI' or similar, or we replicate the fetch logic.

        function getCurrentPhase() {
            const phaseId = BuilderPipeline[currentPhaseIndex];
            return Builder_PHASES[phaseId];
        }

        // --- Builder RENDER LOGIC (DAISYUI V3) ---
        function renderPipelineStepper() {
            const container = document.getElementById('pipeline-stepper');
            if (!container) return;

            let html = '';
            BuilderPipeline.forEach((phaseId, index) => {
                const phase = Builder_PHASES[phaseId];
                // Status Logic: 'step-primary' for completed/current
                let statusClass = (index <= currentPhaseIndex) ? 'step-primary' : '';

                let badgeHtml = '';
                if (phaseId === 'narrative' && accumulatedData?.slides?.length > 0) {
                    badgeHtml = ` <div class="badge badge-accent badge-xs border-none font-bold">${accumulatedData.slides.length}</div>`;
                }

                // DaisyUI Step Item - Clickable for jumpToPhase
                html += `<li class="step ${statusClass} text-[0.6rem] font-bold tracking-wider cursor-pointer hover:text-primary transition-colors" data-content="${index + 1}" onclick="jumpToPhase(${index})">${phase.label}${badgeHtml}</li>`;
            });

            container.innerHTML = html;
        }

        function updateBuilderUI() {
            const phase = getCurrentPhase();

            // 1. Update Header Info
            const titleEl = document.getElementById('Builder-title');
            const descEl = document.getElementById('Builder-desc');
            const submitBtn = document.getElementById('f-submit');
            const inputEl = document.getElementById('f-input');

            if (titleEl) {
                titleEl.innerText = phase.title;
                if (phase.id === 'brainstorm') {
                    titleEl.classList.remove('text-xl', 'md:text-2xl', 'lg:text-3xl');
                    titleEl.classList.add('text-lg', 'md:text-xl', 'lg:text-2xl');
                } else {
                    titleEl.classList.remove('text-lg', 'md:text-xl', 'lg:text-2xl');
                    titleEl.classList.add('text-xl', 'md:text-2xl', 'lg:text-3xl');
                }
            }
            if (descEl) descEl.innerText = phase.desc;

            // Special Handling for Deep Search & Assets
            const outputArea = document.getElementById('Builder-output');
            if (phase.id === 'research' || phase.id === 'deepsearch') {
                renderDeepSearch(outputArea);
            } else if (phase.id === 'assets') {
                renderAssetsScreen(outputArea);
            } else if (phase.id === 'deploy') {
                renderBirthScreen(outputArea);
            } else {
                // Restore Chat View if not already there
                if (!document.getElementById('Builder-chat')) {
                    outputArea.innerHTML = `<div id="Builder-chat" class="flex-1 p-6 overflow-y-auto space-y-4"></div>`;
                    // Restore history
                    BuilderHistory.forEach(h => addBuilderChat(h.role, h.content));
                }
            }

            // 2. Button State
            if (submitBtn) {
                if (phase.id === 'deploy') {
                    submitBtn.innerText = "DEPLOY MISSION";
                    submitBtn.classList.add('btn-warning');
                    submitBtn.onclick = deployMission;
                } else {
                    submitBtn.innerText = "SUBMIT COMMAND";
                    submitBtn.classList.remove('btn-warning');
                    submitBtn.onclick = processBuilder;
                }
            }

            // 3. Input Placeholder
            if (inputEl) {
                inputEl.placeholder = `Enter orders for ${phase.label} phase...`;
            }

            // 4. Update Visual Stepper
            renderPipelineStepper();

            // 5. Scroll Chat
            const chat = document.getElementById('Builder-chat');
            if (chat) chat.scrollTop = chat.scrollHeight;

            log(`Builder UI Updated: Phase ${currentPhaseIndex + 1}/${BuilderPipeline.length} [${phase.label}]`);
        }

        function addBuilderChat(role, message, options = {}) {
            const chat = document.getElementById('Builder-chat');
            if (!chat) return;
            const isAI = role === 'ai' || role === 'assistant';
            const bubbleClass = isAI ? 'chat-bubble-primary' : 'chat-bubble-neutral';
            const alignClass = isAI ? 'chat-start' : 'chat-end';
            const avatarTxt = isAI ? 'AI' : 'OP';
            const avatarBg = isAI ? 'bg-primary text-primary-content' : 'bg-neutral text-neutral-content';

            // Parse Markdown (using marked.js if available, else text)
            const htmlContent = (typeof marked !== 'undefined') ? marked.parse(message) : message;

            let nextBtnHtml = '';
            if (options.showNextPhaseButton) {
                nextBtnHtml = `
                    <div class="mt-4 flex justify-end">
                        <button class="btn btn-xs btn-outline btn-success gap-1 border-white/20 hover:border-white/40" onclick="advancePhase()">
                            AUTHORIZE NEXT PHASE →
                        </button>
                    </div>
                `;
            }

            const html = `
            <div class="chat ${alignClass} animate-fade-in">
                <div class="chat-image avatar placeholder">
                    <div class="w-8 rounded-full ${avatarBg}">
                        <span class="text-xs">${avatarTxt}</span>
                    </div>
                </div>
                <div class="chat-bubble ${bubbleClass} text-sm font-mono leading-relaxed shadow-md">
                    ${htmlContent}
                    ${nextBtnHtml}
                </div>
                <div class="chat-footer opacity-50 text-[0.6rem] mt-1">
                    ${new Date().toLocaleTimeString()}
                </div>
            </div>`;
            chat.insertAdjacentHTML('beforeend', html);
            chat.scrollTop = chat.scrollHeight;
        }

        // --- DEEP SEARCH LOGIC (Restored) ---
        function renderDeepSearch(container) {
            container.innerHTML = `
                <div class="h-full flex flex-col p-6 bg-base-100 gap-6 overflow-y-auto">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 flex-1">
                        <!-- Setup Panel -->
                        <div class="card bg-base-200 shadow-md border border-base-content/10 flex flex-col">
                            <div class="card-body p-4 flex flex-col gap-4">
                                <h3 class="card-title text-xs font-bold text-secondary tracking-widest uppercase">Research Target</h3>
                                <p class="text-[10px] opacity-60">AI will generate a tailored prompt for Gemini Deep Research based on your brainstorm history.</p>
                                <div id="deepsearch-prompt" contenteditable="true" class="flex-1 bg-black/40 border border-white/5 p-4 rounded font-mono text-xs text-secondary-focus overflow-y-auto min-h-[200px] leading-relaxed outline-none">
                                    ${getBuilderContextForResearch()}
                                </div>
                                <div class="flex gap-2">
                                    <button class="btn btn-sm btn-secondary flex-1 font-bold" onclick="tailorDeepSearchPrompt()">TAILOR WITH AI</button>
                                    <button class="btn btn-sm btn-primary flex-1 font-bold" onclick="copyDeepSearchPrompt()">COPY PROMPT</button>
                                </div>
                            </div>
                        </div>

                        <!-- Harvest Panel -->
                        <div class="card bg-base-200 shadow-md border border-base-content/10 flex flex-col">
                            <div class="card-body p-4 flex flex-col gap-4">
                                <h3 class="card-title text-xs font-bold text-success tracking-widest uppercase">Research Harvest</h3>
                                <p class="text-[10px] opacity-60">Paste findings from your external research (Gemini, Perplexity) here. This anchors your story in reality.</p>
                                <textarea id="deepsearch-results" class="textarea textarea-bordered flex-1 bg-black/40 font-mono text-xs leading-relaxed" placeholder="Verifiable facts, stakeholders, dates, primary sources...">${accumulatedData.deepSearchResults || ''}</textarea>
                                <button class="btn btn-sm btn-success btn-outline w-full font-bold" onclick="saveDeepSearchResults()">ANCHOR TO NARRATIVE</button>
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        function getBuilderContextForResearch() {
            const country = document.getElementById('f-country')?.value || 'Unknown';
            const region = document.getElementById('f-region')?.value || '';
            const course = document.getElementById('f-course')?.value || '';
            const title = accumulatedData.metadata?.title || 'Educational Simulation';

            // Extract history
            const context = BuilderHistory.filter(m => m.role === 'assistant').slice(-2).map(m => m.content).join('\n\n');

            return `RESEARCH MISSION: "${title}"\nLOCALE: ${country} ${region}\nCOURSE: ${course}\n\nSCENARIO CONTEXT:\n${context || 'Awaiting further scenario development...'}\n\nPlease conduct deep research to provide factual foundations for this mission. I need verified facts, dates, stakeholder perspectives, and primary sources.`;
        }

        async function tailorDeepSearchPrompt() {
            const promptEl = document.getElementById('deepsearch-prompt');
            if (!promptEl) return;

            log('Optimizing research parameters...', 'info');
            const currentPrompt = promptEl.innerText;

            const systemInstruction = `You are a Research Architect. Rewrite this research prompt into a hyper-specific set of instructions for a Deep Research AI. 
            Mandate regional specificity, verified facts, primary documents, and stakeholder perspectives. Output ONLY the raw prompt.`;

            try {
                const responseText = await callAI(`SYSTEM: ${systemInstruction}\n\nCONTEXT:\n${currentPrompt}`);
                promptEl.innerText = responseText.trim();
                log('Research parameters optimized!', 'success');
            } catch (e) {
                log('Optimization Failed: ' + e.message, 'error');
            }
        }

        function copyDeepSearchPrompt() {
            const text = document.getElementById('deepsearch-prompt')?.innerText;
            if (!text) return;
            navigator.clipboard.writeText(text).then(() => {
                log('Research Prompt Copied to Clipboard', 'success');
                alert('Copied! Paste this into Gemini Deep Research or Perplexity.');
            });
        }

        function saveDeepSearchResults() {
            const results = document.getElementById('deepsearch-results')?.value.trim();
            if (!results) {
                if (!confirm("No research harvested. Anchor proceeding with simulated data only. Proceed?")) return;
            }
            accumulatedData.deepSearchResults = results;
            log('Mission anchored to research harvest.', 'success');
            addBuilderChat('ai', '✅ **Research Anchored.** I will now use these verified sources to construct the operational narrative.');
            saveDraft(); // Auto-save on deep search results change
        }

        async function executeDeepSearch() {
            // Deprecated in favor of Tailor/Harvest workflow
            log('Deep Search direct scan shifted to manual Harvest.', 'info');
        }

        function setBuilderLoading(show, txt = "PROCESSING...") {
            const loader = document.getElementById('Builder-loader');
            if (loader) {
                loader.style.display = show ? 'flex' : 'none';
                const textEl = document.getElementById('Builder-loader-text');
                if (textEl) textEl.innerText = txt;
            }
            // Also toggle the submit button state
            const submitBtn = document.getElementById('f-submit');
            if (submitBtn) submitBtn.disabled = show;
        }

        function jumpToPhase(idx) {
            if (idx < 0 || idx >= BuilderPipeline.length) return;
            if (idx > currentPhaseIndex && !confirm(`Skip ahead to ${Builder_PHASES[BuilderPipeline[idx]].label}? Some phases will be bypassed.`)) return;

            currentPhaseIndex = idx;
            updateBuilderUI();
            addBuilderChat("ai", `⚡ Jumped to **${getCurrentPhase().label}**. Context preserved.`);
            log(`Phase override: ${getCurrentPhase().label}`, 'warning');
            saveDraft(); // Auto-save on phase jump
        }

        async function generateImagePrompts() {
            const selectedModel = document.getElementById('f-model')?.value || 'google/gemini-2.0-flash-exp:free';

            let context = `You are helping generate image prompts for an educational simulation.

Based on the following mission context, generate exactly 19 image prompts for an AI image generator (like Flux or DALL-E).

FORMAT: Output a markdown table with these columns:
| # | Slide | Description | AI Image Prompt |

The prompts should be:
- Photorealistic or documentary style
- Educational and appropriate for classroom use  
- Specific and descriptive (30-50 words each)
- Historically/factually accurate where applicable

REQUIRED IMAGES (19 total):
1. Hero/Splash image (dramatic, sets the tone)
2-19. Two images per slide for 9 content slides (primary view + alternate perspective)

`;

            if (accumulatedData?.metadata?.title) {
                context += `Mission Title: ${accumulatedData.metadata.title}\n`;
            }

            const narrativeContent = BuilderHistory
                .filter(m => m.role === 'assistant')
                .map(m => m.content)
                .join('\n\n')
                .substring(0, 4000);

            if (narrativeContent) {
                context += `\nMission Narrative:\n${narrativeContent}\n`;
            }

            if (accumulatedData?.deepSearchResults) {
                context += `\nResearch Context:\n${accumulatedData.deepSearchResults.substring(0, 1000)}\n`;
            }

            context += `\nNow generate the 19 image prompts in the table format specified above.`;

            try {
                log('Generating 19 image prompts via AI...', 'info');
                setBuilderLoading(true, 'GENERATING ASSETS...');

                const reply = await callAI(context);

                BuilderHistory.push({ role: 'user', content: 'Generate 19 image prompts for the Media phase.' });
                BuilderHistory.push({ role: 'assistant', content: reply });
                saveDraft(); // Auto-save after AI response

                accumulatedData.aiPromptsExtracted = false;
                extractAIPromptsFromHistory();

                const outputArea = document.getElementById('Builder-output');
                if (outputArea) renderAssetsScreen(outputArea);

                log('Image prompts generated successfully!', 'success');

            } catch (e) {
                log(`Prompt generation failed: ${e.message}`, 'error');
            } finally {
                setBuilderLoading(false);
            }
        }

        function downloadBirthedBlob() {
            const title = accumulatedData?.metadata?.title || 'mission';
            const id = accumulatedData?.metadata?.id || 'MISSION_' + Date.now();

            if (!accumulatedData.metadata) accumulatedData.metadata = {};
            accumulatedData.metadata.exportedAt = new Date().toISOString();

            const sanitized = sanitizeForBirth(accumulatedData);

            const blob = new Blob([JSON.stringify(sanitized, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `${id}.blob`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            log(`Downloaded ${id}.blob`, 'success');
            addBuilderChat('ai', `💾 **Mission Dossier Exported!** File: \`${id}.blob\``);
        }

        async function birthMission() {
            const selectedModel = document.getElementById('f-model')?.value || 'google/gemini-2.0-flash-exp:free';

            if (!accumulatedData.metadata) accumulatedData.metadata = {};

            const titleInput = document.getElementById('birth-mission-title')?.value?.trim();
            const idInput = document.getElementById('birth-mission-id')?.value?.trim();
            if (titleInput) accumulatedData.metadata.title = titleInput;
            if (idInput) accumulatedData.metadata.id = idInput;

            if (!accumulatedData.metadata.title) {
                alert('Please enter a Mission Title');
                return;
            }
            if (!accumulatedData.metadata.id) {
                accumulatedData.metadata.id = 'MISSION_' + Date.now();
            }

            const context = `You are converting conversation history into a structured educational mission JSON.

Based on the following builder conversation history, extract and structure the mission data into the following JSON format:

{
  "metadata": {
    "id": "${accumulatedData.metadata.id}",
    "title": "${accumulatedData.metadata.title}",
    "version": "1.0",
    "heroImage": "${accumulatedData.metadata.heroImage || ''}"
  },
  "slides": [
    {
      "id": 1,
      "title": "Slide title from narrative",
      "shortTitle": "Short version",
      "content": "Main slide content prose (200-400 words)",
      "image": "",
      "tabs": {
        "primary": { "label": "Primary", "content": "Primary perspective" },
        "intel": { "label": "Intel", "content": "Intelligence/research data" }
      }
    }
    // ... 10 slides total
  ],
  "intelligenceGlossary": []
}

CONVERSATION HISTORY:
${BuilderHistory.map(m => `[${m.role.toUpperCase()}]: ${m.content}`).join('\n\n').substring(0, 8000)}

Generate the complete JSON structure. Output ONLY the raw JSON, no markdown fences or explanation.`;

            try {
                setBuilderLoading(true, 'BUILDING MISSION...');
                log('Calling AI to structure mission data...', 'info');

                const reply = await callAI(context);

                try {
                    let jsonStr = reply.trim();
                    if (jsonStr.startsWith('```json')) jsonStr = jsonStr.slice(7);
                    if (jsonStr.startsWith('```')) jsonStr = jsonStr.slice(3);
                    if (jsonStr.endsWith('```')) jsonStr = jsonStr.slice(0, -3);

                    const parsed = JSON.parse(jsonStr.trim());

                    if (parsed.metadata) {
                        accumulatedData.metadata = { ...accumulatedData.metadata, ...parsed.metadata };
                    }
                    if (parsed.slides && Array.isArray(parsed.slides)) {
                        parsed.slides.forEach((slide, i) => {
                            if (!accumulatedData.slides) accumulatedData.slides = [];
                            if (accumulatedData.slides[i]) {
                                accumulatedData.slides[i] = { ...accumulatedData.slides[i], ...slide };
                            } else {
                                accumulatedData.slides[i] = slide;
                            }
                        });
                    }
                    if (parsed.intelligenceGlossary) {
                        accumulatedData.intelligenceGlossary = parsed.intelligenceGlossary;
                    }

                    log('Mission data structured successfully!', 'success');
                    addBuilderChat('ai', '✅ **Mission data structured!** Review the validation report below.');
                    saveDraft(); // Auto-save after AI structures mission data

                } catch (parseErr) {
                    log('AI response was not valid JSON, storing raw response', 'warning');
                    accumulatedData.rawBirthResponse = reply;
                }

                const outputArea = document.getElementById('Builder-output');
                if (outputArea) renderBirthScreen(outputArea);

            } catch (e) {
                log(`Birth failed: ${e.message}`, 'error');
                alert(`Birth failed: ${e.message}`);
            } finally {
                setBuilderLoading(false);
            }
        }

        function resetBuilder() {
            if (!confirm("TERMINATE CURRENT BUILDER SESSION? All unsaved intelligence will be lost.")) return;
            currentPhaseIndex = 0;
            BuilderHistory = [];
            accumulatedData = { metadata: {}, slides: [] };

            // Clear Chat
            const chat = document.getElementById('Builder-chat');
            chat.innerHTML = `
                <div class="divider text-xs opacity-50">SESSION RESET</div>
                <div class="chat chat-start">
                    <div class="chat-bubble chat-bubble-primary font-mono text-sm">
                        Ready when you are, Teacher! Let's create something amazing for your students.
                    </div>
                </div>`;

            updateBuilderUI();
            log("Builder Session Reset.", "warning");
            localStorage.removeItem('TM_Builder_DRAFT'); // Clear draft on explicit reset
        }

        // --- AUTH & INIT ---
        function decodeJwtResponse(token) {
            try {
                var base64Url = token.split('.')[1];
                var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function (c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                console.error("JWT Decode Error:", e);
                return null;
            }
        }

        function handleCredentialResponse(response) {
            try {
                console.log("handleCredentialResponse: Packet received.", response);
                log("GSI_ENGINE: Received Credential Packet. Decoding...", "info");

                const responsePayload = decodeJwtResponse(response.credential);
                if (!responsePayload) throw new Error("Could not decode identity token.");

                googleUser = responsePayload;
                console.log("handleCredentialResponse: User Verified:", googleUser.email);

                // --- SECURITY: TEACHER ALLOWLIST ---
                const AUTHORIZED_TEACHERS = [
                    "dwaugh@gmail.com",
                    "david.waugh@gmail.com",
                    "mr.waugh@school.edu"
                ];
                const isAuthorized = AUTHORIZED_TEACHERS.includes(googleUser.email);

                // TEACHER HANDLE LOGIC
                const teacherId = getCurrentTeacherId();

                // Update Dashboard Stat
                const codeEl = document.getElementById('dash-stat-teacher-code');
                const descEl = document.getElementById('dash-stat-teacher-desc');
                if (codeEl) {
                    codeEl.innerText = teacherId;
                    codeEl.classList.remove('text-info'); // Reset colors
                    if (localStorage.getItem('TM_TEACHER_HANDLE')) {
                        codeEl.classList.add('text-warning');
                        descEl.innerHTML = `<span class="text-warning font-bold">⚠️ USING ALIAS HANDLE</span> (Privacy Mode)`;
                    } else {
                        codeEl.classList.add('text-success');
                        descEl.innerText = "Students use this email to join";
                    }
                }



                // Update UI Badges
                const authBadge = document.getElementById('status-badge-auth');
                if (authBadge) {
                    if (isAuthorized) {
                        authBadge.innerText = "AUTH_OK";
                        authBadge.classList.remove('opacity-50', 'badge-outline', 'badge-warning');
                        authBadge.classList.add('badge-success', 'text-white');
                    } else {
                        authBadge.innerText = "GUEST_OK";
                        authBadge.classList.remove('opacity-50', 'badge-outline', 'badge-success');
                        authBadge.classList.add('badge-warning', 'text-black');
                        log("READ-ONLY ACCESS: Identity Verified but not on Authorized List.", "warning");
                    }
                }

                const avatar = document.getElementById('user-avatar-initials');
                if (avatar) avatar.innerText = googleUser.given_name?.[0] || "U";

                log(`Identity Verified: ${googleUser.email}`, "success");

                // Close the auth modal
                const modal = document.getElementById('auth_modal');
                if (modal) modal.close();

                // Refresh data
                refreshClasses();
                fetchMissions();
                fetchCurriculum();

            } catch (e) {
                console.error("Auth Callback Error:", e);
                log(`Auth Failed: ${e.message}`, "error");
                alert("Identity verification failed. Check the console for details.");
            }
        }
        // Ensure global visibility for GSI
        window.handleCredentialResponse = handleCredentialResponse;

        let gAuthInitialized = false;
        function initGoogleAuth() {
            if (gAuthInitialized) {
                const container = document.getElementById("google-signin-container");
                if (container && container.innerHTML === "") {
                    google.accounts.id.renderButton(container, { theme: "outline", size: "large", width: 280 });
                }
                return;
            }

            log("GSI_ENGINE: Establishing Secure Identity Link...");
            try {
                if (typeof google !== 'undefined' && google.accounts) {
                    google.accounts.id.initialize({
                        client_id: GOOGLE_CLIENT_ID,
                        callback: window.handleCredentialResponse
                    });

                    const container = document.getElementById("google-signin-container");
                    if (container) {
                        google.accounts.id.renderButton(
                            container,
                            { theme: "outline", size: "large", width: 280 }
                        );
                    }
                    log("Google Auth Initialized.", "success");
                    gAuthInitialized = true;
                } else {
                    log("GSI Library not loaded yet.", "warning");
                }
            } catch (e) {
                console.error("GSI Init Error:", e);
                log(`GSI Error: ${e.message}`, "error");
            }
        }

        function openAuthModal() {
            const modal = document.getElementById('auth_modal');
            if (modal) {
                initGoogleAuth(); // Ensure button is rendered
                modal.showModal();
            }
        }

        function googleLogout() {
            log("LOGOUT: Terminating session...", "warning");
            googleUser = null;

            // Reset UI
            const authBadge = document.getElementById('status-badge-auth');
            if (authBadge) {
                authBadge.innerText = "GUEST";
                authBadge.classList.add('opacity-50', 'badge-outline');
                authBadge.classList.remove('badge-success', 'text-white');
            }

            const avatar = document.getElementById('user-avatar-initials');
            if (avatar) avatar.innerText = "G";

            // Re-render as guest
            refreshClasses();
            fetchMissions();

            log("Session Terminated. Operating in Guest Mode.", "info");
            openAuthModal(); // Prompt to sign back in
        }



        // --- FORGE NAVIGATION & INTELLIGENCE (Restored V3 Brains) ---
        function jumpToPhase(index) {
            if (index < 0 || index >= BuilderPipeline.length) return;

            log(`Navigating to ${Builder_PHASES[BuilderPipeline[index]].label} protocol...`, "info");
            currentPhaseIndex = index;

            // Clear current chat for the new phase context
            const chat = document.getElementById('Builder-chat');
            if (chat) chat.innerHTML = '';

            updateBuilderUI();
            addBuilderChat('ai', `**PHASE SHIFT**: Entering ${Builder_PHASES[BuilderPipeline[index]].title}. \n\n${Builder_PHASES[BuilderPipeline[index]].desc}`);
        }

        async function optimizeDeepSearch() {
            log("Optimizing Intelligence Queries...", "info");
            const brainstorm = BuilderHistory.find(h => h.role === 'ai')?.content || "";
            if (!brainstorm) {
                alert("Please brainstorm a mission first to generate research queries.");
                return;
            }

            const prompt = `Based on this mission brainstorm, generate 5 highly specific research queries for a deep-dive investigation. \n\nBRAINSTORM: ${brainstorm}\n\nFormat: Bullet points.`;

            try {
                const queries = await callAI(prompt);
                addBuilderChat('ai', `**DEEP SEARCH PROTOCOLS GENERATED**: \n\n${queries}`);
                log("Intelligence Queries Optimized.", "success");
            } catch (e) {
                log(`Research Opt Failed: ${e.message}`, "error");
            }
        }

        async function runAI(studentName, classCode, missionId) {
            log(`Analyzing Agent Performance: ${studentName}...`, "info");

            // 1. Find the student log
            const logEntry = allProgress.find(p => p.name === studentName && p.class === classCode);
            if (!logEntry) return;

            // 2. Construct Analysis Prompt
            const prompt = `Analyze this student's performance in Situation Room Mission [${missionId}]. \n\nSTUDENT: ${studentName}\nSTATUS: ${JSON.stringify(logEntry.missionData[missionId])}\n\nProvide a technical evaluation of their decisions and suggest a 'Counter-Intelligence' briefing for the teacher.`;

            try {
                const analysis = await callAI(prompt);
                alert(`STUDENT ANALYSIS [${studentName}]:\n\n${analysis}`);
                log("Intelligence Analysis Complete.", "success");
            } catch (e) {
                log(`Analysis Failed: ${e.message}`, "error");
            }
        }

        async function processBuilder() {
            const inputEl = document.getElementById('f-input');
            const input = inputEl.value.trim();
            const phase = getCurrentPhase();

            // 1. Check for basic navigation commands
            if (input.toLowerCase().match(/^(next|proceed|advance|continue)$/)) {
                advancePhase();
                inputEl.value = '';
                return;
            }

            // 2. Prepare UI
            addBuilderChat('user', input || "(Generating intel...)");
            inputEl.value = '';
            const loadingId = `msg-${Date.now()}`;
            // Add temp loading bubble
            const chat = document.getElementById('Builder-chat');
            chat.insertAdjacentHTML('beforeend', `<div id="${loadingId}" class="chat chat-start"><div class="chat-bubble chat-bubble-secondary animate-pulse text-xs">Thinking...</div></div>`);
            chat.scrollTop = chat.scrollHeight;

            try {
                console.log("processBuilder: Initiating AI Request...", { phase, inputLength: input.length });
                // 3. Construct Prompt Context
                let context = `${Builder_SYSTEM_CORE}\n\n`;

                // Curriculum Context
                const country = document.getElementById('f-country').value;
                const region = document.getElementById('f-region').value;
                const course = document.getElementById('f-course').value;
                const checks = document.querySelectorAll('.outcome-check:checked');
                let selectedOutcomes = Array.from(checks).map(c => c.value);

                // If no outcomes selected but course is chosen, include ALL outcomes
                if (selectedOutcomes.length === 0 && course && window.curriculumData?.[country]?.[region]?.[course]) {
                    selectedOutcomes = window.curriculumData[country][region][course];
                    log(`No outcomes selected - including all ${selectedOutcomes.length} for AI analysis.`, 'info');
                }

                if (country || region || course) {
                    context += `\n--- TEACHER CONTEXT ---\n`;
                    context += `LOCALE: ${country} | ${region}\n`;
                    context += `COURSE: ${course}\n`;
                    if (selectedOutcomes.length > 0) {
                        context += `TARGET OUTCOMES: ${selectedOutcomes.join(" | ")}\n`;
                        log(`Aligning with ${selectedOutcomes.length} outcomes.`, "info");
                    }
                }

                // Append History (Last 6 turns to save tokens)
                const recentHistory = BuilderHistory.slice(-6);
                if (recentHistory.length > 0) {
                    context += `\n--- PREVIOUS INTEL ---\n`;
                    recentHistory.forEach(h => context += `${h.role.toUpperCase()}: ${h.content}\n`);
                }

                // Research Context (Injection)
                if (accumulatedData.deepSearchResults) {
                    context += `\n--- VERIFIED RESEARCH HARVEST ---\n${accumulatedData.deepSearchResults}\n`;
                }

                context += `\nCURRENT OBJECTIVE: ${phase.title}\nINSTRUCTION: ${phase.prompt}\nUSER COMMAND: ${input}`;

                // 4. API Call
                console.log("processBuilder: Sending context to AI...");
                const responseText = await callAI(context);
                console.log("processBuilder: AI success.", responseText.substring(0, 50));

                // 5. Handle Success
                const loader = document.getElementById(loadingId);
                if (loader) loader.remove();

                const lowerResponse = responseText.toLowerCase();
                const shouldShowNext = lowerResponse.includes('authorize next') ||
                    lowerResponse.includes('proceed to next') ||
                    lowerResponse.includes('ready for visuals') ||
                    (phase.id === 'narrative' && lowerResponse.includes('slide 10:'));

                addBuilderChat('ai', responseText, { showNextPhaseButton: shouldShowNext });

                // Save to History
                BuilderHistory.push({ role: 'user', content: input });
                BuilderHistory.push({ role: 'assistant', content: responseText });
                saveDraft(); // Auto-save after AI response

                // Parse narrative if in applicable phase
                if (phase.id === 'narrative' || phase.id === 'scripting' || responseText.includes('SLIDE 1:')) {
                    parseNarrativeResponse(responseText);
                }

                log(`AI Directive Received [${phase.label}]`, "success");

            } catch (e) {
                console.error("processBuilder Failure:", e);
                const loader = document.getElementById(loadingId);
                if (loader) loader.remove();
                addBuilderChat('ai', `**CONNECTION LOST**: ${e.message}`);
                log(`Builder Error: ${e.message}`, "error");
            }
        }


        // --- NARRATIVE PARSER (Restored from old version) ---
        function parseNarrativeResponse(text) {
            if (!text) return;

            log('Parsing narrative response for structured components...', 'info');

            // 1. Extract Mission Title if present
            const titleMatch = text.match(/Mission Title:\s*(.*)/i);
            if (titleMatch && titleMatch[1]) {
                if (!accumulatedData.metadata) accumulatedData.metadata = {};
                accumulatedData.metadata.title = titleMatch[1].trim();
                log(`Extracted Mission Title: ${accumulatedData.metadata.title}`, 'success');
            }

            // 2. Split into Slide Blocks
            // Format usually starts with "SLIDE X:"
            const slides = [];
            const slideBlocks = text.split(/SLIDE\s+\d+:\s+/i).slice(1); // Skip the preamble

            slideBlocks.forEach((block, idx) => {
                const slide = {
                    id: idx + 1,
                    type: 'BRIEFING', // Default
                    title: '',
                    content: '',
                    interactionPrompt: '',
                    options: [],
                    outcomes: {},
                    tabs: { primary: { label: 'Primary', content: '' }, intel: { label: 'Intel', content: '' }, legal: { label: 'Legal', content: '' } }
                };

                // Extract Type and Title
                const titleLineMatch = block.match(/SLIDE TYPE:\s*(.*?)\s*\|\s*TITLE:\s*(.*)/i);
                if (titleLineMatch) {
                    slide.type = titleLineMatch[1].trim();
                    slide.title = titleLineMatch[2].trim();
                    slide.shortTitle = slide.title.substring(0, 20);
                }

                // Extract Content
                const contentMatch = block.match(/CONTENT:\s*([\s\S]*?)(?=INTERACTION PROMPT:|OPTIONS:|OUTCOMES:|INTEL:|$)/i);
                if (contentMatch) {
                    slide.content = contentMatch[1].trim();
                }

                // Extract Interaction Prompt
                const promptMatch = block.match(/INTERACTION PROMPT:\s*([\s\S]*?)(?=OPTIONS:|OUTCOMES:|INTEL:|$)/i);
                if (promptMatch) {
                    slide.interactionPrompt = promptMatch[1].trim();
                }

                // Extract Options
                const optionsMatch = block.match(/OPTIONS:\s*([\s\S]*?)(?=OUTCOMES:|INTEL:|$)/i);
                if (optionsMatch) {
                    const opts = optionsMatch[1].match(/\["(.*?)"\]/g);
                    if (opts) {
                        slide.options = opts.map(o => o.replace(/\["(.*)"\]/, '$1'));
                    }
                }

                // Extract Intel / Tabs
                const intelMatch = block.match(/INTEL:\s*\{([\s\S]*?)\}/i);
                if (intelMatch) {
                    const rawIntel = intelMatch[1];
                    // Very loose parsing for AI-generated "JSON-like" objects
                    const primary = rawIntel.match(/PRIMARY:\s*"(.*?)"/i);
                    const legal = rawIntel.match(/LEGAL:\s*"(.*?)"/i);
                    const intelSecondary = rawIntel.match(/INTEL:\s*"(.*?)"/i);

                    if (primary) slide.tabs.primary.content = primary[1];
                    if (legal) slide.tabs.legal.content = legal[1];
                    if (intelSecondary) slide.tabs.intel.content = intelSecondary[1];
                }

                slides.push(slide);
            });

            // --- ROBUSTNESS: If no slides extracted, try looser parsing ---
            if (slides.length === 0) {
                log('Strict parser found no slides. Attempting looser extraction...', 'warning');

                // Try to extract any numbered sections
                const looseBlocks = text.split(/(?:^|\n)(?:###|##)\s*(?:Slide\s*)?\d+/i);
                if (looseBlocks.length > 1) {
                    looseBlocks.slice(1).forEach((block, idx) => {
                        const slide = {
                            id: idx + 1,
                            type: 'BRIEFING',
                            title: `Slide ${idx + 1}`,
                            content: block.trim().substring(0, 500),
                            tabs: { primary: { label: 'Primary', content: '' }, intel: { label: 'Intel', content: '' } }
                        };
                        slides.push(slide);
                    });
                }
            }

            if (slides.length > 0) {
                accumulatedData.slides = slides;
                log(`Successfully extracted ${slides.length} slides from narrative.`, 'success');

                // Update phase badge
                updatePhaseBadge('narrative', `${slides.length} slides`);
            }

            // 3. Extract Glossary if present
            const glossaryMatch = text.match(/INTELLIGENCE GLOSSARY:\s*([\s\S]*)$/i);
            if (glossaryMatch) {
                const items = [];
                const lines = glossaryMatch[1].split('\n');
                lines.forEach(line => {
                    const m = line.match(/^(.*?):\s*(.*)/);
                    if (m) {
                        items.push({ term: m[1].trim(), definition: m[2].trim() });
                    }
                });
                if (items.length > 0) {
                    accumulatedData.intelligenceGlossary = items;
                    log(`Extracted ${items.length} glossary terms.`, 'success');
                }
            }
            saveDraft(); // Auto-save after parsing narrative
        }


        function sanitizeForBirth(data) {
            // Create a deep copy and strip base64 image data, keeping only R2 URLs
            const sanitized = JSON.parse(JSON.stringify(data));

            // Helper to check if a string is a base64 data URI
            const isBase64 = (str) => {
                return typeof str === 'string' && str.startsWith('data:image');
            };

            // Helper to filter image URLs (only keep R2/HTTP URLs, remove base64)
            const filterImageUrl = (url) => {
                if (!url) return '';
                if (isBase64(url)) return ''; // Strip base64
                return url; // Keep R2/HTTP URLs
            };

            // Sanitize metadata
            if (sanitized.metadata) {
                sanitized.metadata.heroImage = filterImageUrl(sanitized.metadata.heroImage);
            }

            // Sanitize slides
            if (Array.isArray(sanitized.slides)) {
                sanitized.slides.forEach(slide => {
                    // Filter slide-level images
                    slide.image = filterImageUrl(slide.image);
                    slide.mediaURL = filterImageUrl(slide.mediaURL);

                    // Filter tab images
                    if (slide.tabs) {
                        Object.keys(slide.tabs).forEach(tabKey => {
                            const tab = slide.tabs[tabKey];
                            if (tab && tab.image) {
                                tab.image = filterImageUrl(tab.image);
                            }
                        });
                    }
                });
            }

            return sanitized;
        }
        function updatePhaseBadge(phaseId, badgeText) {
            // Simplified: Re-render the stepper which now supports badges
            renderPipelineStepper();
        }
        // --- MISSION SURGERY HELPERS ---
        function setNested(obj, path, value) {
            const parts = path.split('.');
            let current = obj;
            for (let i = 0; i < parts.length - 1; i++) {
                if (!current[parts[i]]) current[parts[i]] = {};
                current = current[parts[i]];
            }
            current[parts[parts.length - 1]] = value;
        }

        function formatText(text) {
            if (!text) return "";
            return text
                .replace(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/g,
                    '<div class="video-container" style="position:relative; padding-bottom:56.25%; height:0; overflow:hidden; margin:10px 0;"><iframe style="position:absolute; top:0; left:0; width:100%; height:100%; border:0;" src="https://www.youtube.com/embed/$1" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>')
                .replace(/(https?:\/\/.*\.pdf)/gi,
                    '<div class="pdf-container" style="height:300px; margin:10px 0;"><embed src="$1" type="application/pdf" width="100%" height="100%"></div>')
                .replace(/(https?:\/\/.*\.(?:mp4|avi|mov|webm))/gi,
                    '<video controls style="width:100%; max-height:300px; background:#000; margin:10px 0;"><source src="$1">Video not supported.</video>')
                .replace(/\n/g, '<br>');
        }

        async function callAI(prompt) {
            // Priority 0: HARDWIRED Vercel Proxy
            const selectedModel = document.getElementById('f-model')?.value || 'xiaomi/mimo-v2-flash:free';

            console.log("callAI: Connecting via Vercel Proxy...", HARDWIRED_PROXY);
            console.log("callAI: Selected Model:", selectedModel);
            log(`AI Uplink: Proxy [${selectedModel}]`, "info");

            try {
                const res = await fetch(HARDWIRED_PROXY, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: prompt,
                        model: selectedModel
                    })
                });

                console.log("callAI: Response status:", res.status);

                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }

                const data = await res.json();
                console.log("callAI: Vercel Response (raw):", JSON.stringify(data).substring(0, 500));

                // OpenRouter/OpenAI format: { choices: [{ message: { content: "..." } }] }
                if (data.choices && data.choices[0]?.message?.content) {
                    const text = data.choices[0].message.content;
                    log("Proxy Intel Acquired.", "success");
                    return text;
                }

                // Direct message format: { message: "..." }
                if (data.message && typeof data.message === 'string') {
                    log("Proxy Intel Acquired (direct).", "success");
                    return data.message;
                }

                // Direct content format: { content: "..." }
                if (data.content && typeof data.content === 'string') {
                    log("Proxy Intel Acquired (content).", "success");
                    return data.content;
                }

                // Direct text format: { text: "..." }
                if (data.text && typeof data.text === 'string') {
                    log("Proxy Intel Acquired (text).", "success");
                    return data.text;
                }

                // If there's an error field, report it
                if (data.error) {
                    throw new Error(`Proxy error: ${JSON.stringify(data.error)}`);
                }

                console.error("callAI: Unrecognized response format:", data);
                throw new Error("Proxy response format invalid. Check console for details.");
            } catch (e) {
                console.error("callAI: Vercel Proxy Error:", e);
                log(`Proxy Error: ${e.message}. Falling back to GCP.`, "warning");
            }

            // Priority 1: Google Cloud Direct (via Config or LocalStorage)
            const gcpKey = localStorage.getItem('TM_GCP_KEY') || (typeof CONFIG !== 'undefined' ? CONFIG.GCP_KEY : '');

            console.log("callAI: Checking GCP Key...", gcpKey ? `Key found (${gcpKey.substring(0, 8)}...)` : "NO KEY");
            log(`AI Uplink: ${gcpKey ? 'GCP Key detected' : 'Proxy offline/missing - using backup'}`, gcpKey ? 'info' : 'warning');

            if (gcpKey) {
                // Gemini API Path
                const model = localStorage.getItem('TM_GCP_MODEL') || "gemini-1.5-flash";
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${gcpKey}`;
                console.log("callAI: Sending request to", model);
                log(`AI Request → ${model}...`);

                try {
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await res.json();
                    console.log("callAI: Raw API Response:", data);

                    if (data.candidates && data.candidates[0]) {
                        const text = data.candidates[0].content.parts[0].text;
                        console.log("callAI: SUCCESS - Response length:", text.length);
                        log(`AI Response: ${text.substring(0, 50)}...`, "success");
                        return text;
                    }

                    // Handle specific error cases
                    const errMsg = data.error?.message || JSON.stringify(data);
                    console.error("callAI: API Error:", errMsg);
                    log(`API Error: ${errMsg}`, "error");
                    throw new Error(errMsg);
                } catch (e) {
                    console.error("callAI: Fetch failed:", e);
                    log(`AI Error: ${e.message}. Falling back to Simulation.`, "warning");
                }
            }

            // Fallback: Smart Simulation (for UI testing or offline)
            console.log("callAI: Using SIMULATION mode");
            log("Simulation Mode Active - No Uplink Detected", "warning");
            await new Promise(r => setTimeout(r, 1000));
            const simResponses = [
                "**Simulation Mode Active.** \n\nI have analyzed your request. Based on standard curriculum parameters, I propose focusing on a scenario that emphasizes **Critical Decision Making** under pressure. \n\n*System Note: To generate specific content aligned with your custom input, please ensure the Neural Link (Proxy) is active.*",
                "**Narrative taking shape!** \nI'm drafting a slide sequence for your mission: \n1. **The Situation**: Students receive an urgent briefing. \n2. **Key Perspectives**: Multiple stakeholders present their views. \n3. **The Decision Point**: Students must weigh trade-offs and choose a path forward.",
                "**Visual concepts ready!** \nI've drafted some image prompts that should work well with this lesson. Would you like to review and adjust the visual style?"
            ];
            return simResponses[currentPhaseIndex % simResponses.length] || "Ready to help, Teacher. What would you like to explore?";
        }

        function advancePhase() {
            const currentPhase = getCurrentPhase();

            if (currentPhaseIndex >= BuilderPipeline.length - 1) {
                alert('You are already at the final phase (Deploy).');
                return;
            }

            // Special validation for narrative → assets transition
            if (currentPhase.id === 'narrative') {
                const slideCount = accumulatedData?.slides?.length || 0;
                if (slideCount < 10) {
                    const proceed = confirm(`Only ${slideCount}/10 slides detected. Proceeding to Assets may result in missing content. Continue anyway?`);
                    if (!proceed) return;
                }
            }

            // Special validation for assets → deploy transition
            if (currentPhase.id === 'assets') {
                let imgCount = 0;
                (accumulatedData.slides || []).forEach(s => {
                    if (s && (s.image || s.tabs?.primary?.image)) imgCount++;
                });
                if (imgCount < 5) {
                    const proceed = confirm(`Only ${imgCount} visual assets archived. Proceeding to Birth may result in incomplete data. Continue?`);
                    if (!proceed) return;
                }
            }

            // Create a small "system event" in chat
            const chat = document.getElementById('Builder-chat');
            if (chat) {
                chat.insertAdjacentHTML('beforeend', `
                    <div class="divider text-primary text-xs font-mono my-4">PHASE COMPLETE</div>
                `);
            }

            currentPhaseIndex++;
            updateBuilderUI();
            log(`Phase advanced to: ${getCurrentPhase().label}`, 'success');
            saveDraft(); // Auto-save on phase advance
        }

        function BuilderBack() {
            if (currentPhaseIndex > 0) {
                currentPhaseIndex--;
                updateBuilderUI();
                addBuilderChat("ai", `Reverting to ${getCurrentPhase().label}. Command parameters preserved.`);
                log(`Builder reverted to: ${getCurrentPhase().label}`, 'warning');
                saveDraft(); // Auto-save on BuilderBack
            }
        }

        // --- MEDIA SCREEN PROMPT EXTRACTION (Restored) ---
        function extractAIPromptsFromHistory() {
            // Look for AI response containing markdown table with prompts
            const assistantMsgs = BuilderHistory.filter(m => m.role === 'assistant');

            for (const msg of assistantMsgs.reverse()) { // Start from most recent
                const content = msg.content;

                // Try to find markdown table rows - support both 4-column and 6-column formats
                const tableRows4 = content.match(/\|[^|\n]+\|[^|\n]+\|[^|\n]+\|[^|\n]+\|/g);
                const tableRows6 = content.match(/\|[^|\n]+\|[^|\n]+\|[^|\n]+\|[^|\n]+\|[^|\n]+\|[^|\n]*\|/g);

                const tableRows = tableRows6 || tableRows4;
                const is6Column = !!tableRows6;

                if (tableRows && tableRows.length > 1) {
                    const prompts = [];

                    for (let i = 1; i < tableRows.length; i++) {
                        const row = tableRows[i];
                        const cells = row.split('|').map(c => c.trim()).filter(c => c);

                        // Skip table separator row
                        if (cells.length > 0 && cells.every(cell => /^[-:]+$/.test(cell))) {
                            continue;
                        }

                        if (cells.length >= 4) {
                            const aiPrompt = is6Column ? (cells[4] || '') : (cells[3] || '');
                            const itemName = cells[1] || '';

                            if (!aiPrompt || /^[-\s]+$/.test(aiPrompt)) continue;

                            prompts.push({
                                id: cells[0],
                                name: itemName,
                                prompt: aiPrompt
                            });
                        }
                    }

                    if (prompts.length > 0) {
                        if (!accumulatedData.metadata) accumulatedData.metadata = {};
                        if (!accumulatedData.slides) accumulatedData.slides = [];

                        // First prompt is typically Hero
                        if (prompts[0]) {
                            accumulatedData.metadata.heroPrompt = prompts[0].prompt;
                            prompts.shift();
                        }

                        // Distribute remaining prompts across slides (2 per slide)
                        for (let i = 0; i < prompts.length && i < 18; i++) {
                            const slideIdx = Math.floor(i / 2);
                            const isAlt = i % 2 === 1;

                            if (!accumulatedData.slides[slideIdx]) {
                                accumulatedData.slides[slideIdx] = { shortTitle: `Slide ${slideIdx + 1}` };
                            }

                            if (isAlt) {
                                accumulatedData.slides[slideIdx].altImagePrompt = prompts[i].prompt;
                            } else {
                                accumulatedData.slides[slideIdx].imagePrompt = prompts[i].prompt;
                            }
                        }

                        accumulatedData.aiPromptsExtracted = true;
                        log(`Extracted ${prompts.length + 1} AI prompts from Assets phase`, 'success');
                        saveDraft(); // Auto-save after extracting prompts
                        return;
                    }
                }
            }
            accumulatedData.aiPromptsExtracted = true;
        }

        function renderAssetsScreen(outputArea) {
            if (!accumulatedData.aiPromptsExtracted) {
                extractAIPromptsFromHistory();
            }

            const missionId = accumulatedData?.metadata?.id || 'unnamed';
            const heroPrompt = accumulatedData.metadata?.heroPrompt || '';
            const heroImage = accumulatedData.metadata?.heroImage || '';

            let html = `
                <div class="p-6 h-full overflow-y-auto bg-base-200">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                        <div>
                            <h2 class="text-xl font-display tracking-widest text-primary flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                19-ASSET STRATEGY MATRIX
                            </h2>
                            <p class="text-[10px] opacity-60 font-mono uppercase tracking-tighter">Mission ID: ${missionId} // 1 HERO + 18 EXHIBITS</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                             <button class="btn btn-xs btn-outline btn-primary font-mono text-[9px]" onclick="extractAIPromptsFromHistory(); renderAssetsScreen(document.getElementById('Builder-output'))">RESYNC PROMPTS</button>
                             <button class="btn btn-xs btn-secondary font-mono text-[9px]" onclick="generateAllAssets()">GENERATE ALL (19)</button>
                             <button class="btn btn-xs btn-accent font-mono text-[9px]" onclick="saveAllAssetsToR2()">SAVE ALL TO R2</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                        <!-- Hero Card (Full Width in Grid) -->
                        <div class="col-span-full mb-2">
                            <div class="card bg-base-100 shadow-xl border border-primary/40">
                                <div class="card-body p-3 flex-row gap-4 items-center">
                                    <div id="asset-hero-preview" class="w-24 h-24 bg-black/40 rounded border border-white/5 flex items-center justify-center shrink-0 overflow-hidden">
                                        ${heroImage ? `<img src="${heroImage}" class="h-full w-full object-cover">` : '<div class="text-[8px] opacity-20 font-mono">HERO</div>'}
                                    </div>
                                    <div class="flex-1 space-y-2">
                                        <div class="flex justify-between items-center"><span class="text-[10px] font-bold text-primary tracking-widest">MISSION HERO // SPLASH</span><span class="badge badge-primary badge-xs scale-75">PRM</span></div>
                                        <div class="join w-full">
                                            <input id="asset-hero-prompt" type="text" class="input input-bordered input-xs join-item flex-1 font-mono text-[10px]" value="${heroPrompt}" onchange="updateAssetPrompt('hero', this.value)">
                                            <button class="btn btn-xs btn-primary join-item px-4 font-bold" onclick="generateAsset('hero')">GENERATE</button>
                                            <button class="btn btn-xs btn-accent join-item font-bold" onclick="saveAssetToGit('hero')">R2</button>
                                        </div>
                                        <input id="asset-hero-url" type="text" class="input input-bordered input-xs w-full font-mono text-[9px] text-success" placeholder="URL" value="${heroImage}" onchange="updateAssetUrl('hero', this.value)">
                                    </div>
                                </div>
                            </div>
                        </div>
            `;

            const slides = accumulatedData.slides || [];
            // We fill 18 slots (2 per slide for 9 content slides)
            for (let i = 0; i < 9; i++) {
                const s = slides[i] || {};
                const slideTitle = s.title || s.shortTitle || `Section ${i + 1}`;

                ['a', 'b'].forEach(v => {
                    const slotId = `${i}-${v}`;
                    const img = (v === 'a') ? (s.tabs?.primary?.image || s.image || '') : (s.tabs?.intel?.image || s.altImage || '');
                    const prompt = (v === 'a') ? (s.imagePrompt || '') : (s.altImagePrompt || '');

                    html += `
                        <div class="card bg-base-100 shadow-md border border-base-content/10">
                            <div class="card-body p-2 space-y-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-[9px] font-bold text-accent opacity-70 truncate">S${i + 1}${v.toUpperCase()}: ${slideTitle.substring(0, 12)}</span>
                                    <span class="badge badge-outline badge-[8px] opacity-30 font-mono">${v === 'a' ? 'PRM' : 'INT'}</span>
                                </div>
                                <div id="asset-${slotId}-preview" class="bg-black/20 rounded aspect-[4/3] flex items-center justify-center border border-white/5 overflow-hidden">
                                    ${img ? `<img src="${img}" class="h-full w-full object-cover">` : '<span class="text-[8px] opacity-20 font-mono">OFFLINE</span>'}
                                </div>
                                <input id="asset-${slotId}-prompt" type="text" class="input input-bordered input-[10px] h-6 w-full font-mono" placeholder="Prompt..." value="${prompt}" onchange="updateAssetPrompt('${slotId}', this.value)">
                                <div class="flex gap-1">
                                    <input id="asset-${slotId}-url" type="text" class="input input-bordered input-[10px] h-6 flex-1 font-mono text-[8px] text-success" placeholder="URL" value="${img}" onchange="updateAssetUrl('${slotId}', this.value)">
                                    <button class="btn btn-xs btn-primary btn-square h-6 w-6" onclick="generateAsset('${slotId}')" title="Generate Image">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                                    </button>
                                    <button class="btn btn-xs btn-accent btn-square h-6 w-6" onclick="saveAssetToGit('${slotId}')" title="Save to R2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg>
                                    </button>
                                    <!-- Context Button -->
                                    <button class="btn btn-xs btn-ghost btn-square h-6 w-6 opacity-50 hover:opacity-100" onclick="viewSlideContext(${i}, '${v}')" title="View Context">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                                    </button>
                                </div>
                            </div>
                        </div>`;
                });
            }

            html += `</div></div>`;
            outputArea.innerHTML = html;
        }

        function viewSlideContext(slideIdx, variant) {
            const slide = accumulatedData.slides[slideIdx];
            if (!slide) return;

            const modal = document.getElementById('intel_modal');
            const title = document.getElementById('intel-modal-title');
            const content = document.getElementById('intel-modal-content');

            const typeLabel = variant === 'a' ? 'PRIMARY' : 'INTEL';
            title.innerText = `CONTEXT: S${slideIdx + 1}${variant.toUpperCase()} (${typeLabel})`;

            let text = "";
            if (variant === 'a') {
                text = slide.tabs?.primary?.content || slide.content || slide.brief || "* NO DATA *";
            } else {
                text = slide.tabs?.intel?.content || slide.tabs?.intel || slide.intel || "* NO INTEL DATA *";
            }

            content.innerHTML = (typeof marked !== 'undefined') ? marked.parse(text) : text;
            modal.showModal();
        }

        function updateAssetPrompt(slotId, prompt) {
            if (slotId === 'hero') {
                if (!accumulatedData.metadata) accumulatedData.metadata = {};
                accumulatedData.metadata.heroPrompt = prompt;
            } else if (typeof slotId === 'string' && slotId.includes('-')) {
                const [slideIdx, variant] = slotId.split('-');
                const idx = parseInt(slideIdx);
                if (!accumulatedData.slides[idx]) accumulatedData.slides[idx] = {};
                if (variant === 'a') {
                    accumulatedData.slides[idx].imagePrompt = prompt;
                } else {
                    accumulatedData.slides[idx].altImagePrompt = prompt;
                }
            }
            log(`Asset prompt updated for slot ${slotId}`, 'info');
            saveDraft(); // Auto-save on asset prompt update
        }

        function updateAssetUrl(slotId, url) {
            if (slotId === 'hero') {
                if (!accumulatedData.metadata) accumulatedData.metadata = {};
                accumulatedData.metadata.heroImage = url;
                const prev = document.getElementById('asset-hero-preview');
                if (prev) prev.innerHTML = url ? `<img src="${url}" class="max-h-[160px] object-contain shadow-2xl">` : '<div class="text-[10px] opacity-20 font-mono">NO IMAGE DATA</div>';
            } else if (typeof slotId === 'string' && slotId.includes('-')) {
                const [slideIdx, variant] = slotId.split('-');
                const idx = parseInt(slideIdx);

                if (!accumulatedData.slides[idx]) accumulatedData.slides[idx] = {};
                if (!accumulatedData.slides[idx].tabs) accumulatedData.slides[idx].tabs = { primary: {}, intel: {} };

                if (variant === 'a') {
                    accumulatedData.slides[idx].tabs.primary.image = url;
                    accumulatedData.slides[idx].image = url;
                } else {
                    accumulatedData.slides[idx].tabs.intel.image = url;
                }

                const prev = document.getElementById(`asset-${slotId}-preview`);
                if (prev) prev.innerHTML = url ? `<img src="${url}" class="max-h-full object-contain">` : '<span class="text-[10px] opacity-20 font-mono">Offline</span>';
            }
            log(`Asset URL updated for slot ${slotId}`, 'success');
            saveDraft(); // Auto-save on asset URL update
        }

        async function generateAsset(slotId) {
            const promptEl = document.getElementById(slotId === 'hero' ? 'asset-hero-prompt' : `asset-${slotId}-prompt`);
            const urlEl = document.getElementById(slotId === 'hero' ? 'asset-hero-url' : `asset-${slotId}-url`);
            const previewEl = document.getElementById(slotId === 'hero' ? 'asset-hero-preview' : `asset-${slotId}-preview`);

            const prompt = promptEl?.value;
            if (!prompt) {
                alert('Enter a synthesis directive first!');
                return;
            }

            // Get OpenRouter key or Vercel Proxy
            let orKey = localStorage.getItem('TM_OPENROUTER_KEY');
            if (!orKey) {
                orKey = window.prompt("Enter OpenRouter API Key for Image Synthesis:");
                if (!orKey) return;
                localStorage.setItem('TM_OPENROUTER_KEY', orKey.trim());
            }

            try {
                previewEl.innerHTML = '<span class="loading loading-spinner text-primary"></span>';
                log(`Synthesis Initiated [${slotId}]...`, 'info');

                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${orKey}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        "model": "black-forest-labs/flux.2-pro",
                        "messages": [{ "role": "user", "content": prompt }]
                    })
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error.message);

                const message = data.choices[0].message;
                let imageUrl = null;

                if (message.images && message.images.length > 0) {
                    imageUrl = message.images[0].image_url?.url || message.images[0];
                }

                if (!imageUrl) {
                    const urlMatch = (message.content || "").match(/https?:\/\/[^\s\)]+/g);
                    if (urlMatch) imageUrl = urlMatch[0];
                }

                if (!imageUrl) throw new Error("Synthesis failed to yield visual data.");

                urlEl.value = imageUrl;
                updateAssetUrl(slotId, imageUrl);
                log(`Synthesis Successful [${slotId}]`, 'success');

            } catch (e) {
                log(`Synthesis Error [${slotId}]: ${e.message}`, 'error');
                previewEl.innerHTML = `<span class="text-[10px] text-error font-mono leading-none text-center">FAILURE:<br>${e.message.substring(0, 30)}...</span>`;
            }
        }

        async function generateAllAssets() {
            if (!confirm("Synthesize ALL assets? This consumes significant credits.")) return;
            const slots = ['hero'];
            for (let i = 0; i < (accumulatedData.slides?.length || 0); i++) {
                slots.push(`${i}-a`, `${i}-b`);
            }

            for (const slotId of slots) {
                const promptEl = document.getElementById(slotId === 'hero' ? 'asset-hero-prompt' : `asset-${slotId}-prompt`);
                if (promptEl?.value?.trim()) {
                    await generateAsset(slotId);
                    await new Promise(r => setTimeout(r, 1000)); // Rate limiting
                }
            }
        }

        async function saveAssetToGit(slotId) {
            const urlEl = document.getElementById(slotId === 'hero' ? 'asset-hero-url' : `asset-${slotId}-url`);
            const previewEl = document.getElementById(slotId === 'hero' ? 'asset-hero-preview' : `asset-${slotId}-preview`);
            const url = urlEl?.value;

            if (!url) return alert('No asset URL found.');

            const R2_WORKER_URL = 'https://proud-tooth-42cf.icumusicvideo.workers.dev';
            const originalContent = previewEl.innerHTML;

            try {
                log(`R2 Uplink [${slotId}]: Processing...`, 'info');
                previewEl.innerHTML = '<span class="loading loading-spinner text-accent"></span>';

                // Convert to JPG via canvas (for optimization and consistency)
                const img = new Image();
                img.crossOrigin = "anonymous";
                await new Promise((res, rej) => {
                    img.onload = res;
                    img.onerror = rej;
                    img.src = url;
                });

                const canvas = document.createElement('canvas');
                canvas.width = img.width; canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#FFF'; ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
                const jpgData = canvas.toDataURL('image/jpeg', 0.8);

                const res = await fetch(`${R2_WORKER_URL}?filename=${encodeURIComponent(`TM_${slotId}_${Date.now()}.jpg`)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: jpgData })
                });

                const data = await res.json();
                if (!data.success) throw new Error(data.error);

                urlEl.value = data.url;
                updateAssetUrl(slotId, data.url);
                log(`R2 Archive Complete [${slotId}]`, 'success');

            } catch (e) {
                log(`R2 Error [${slotId}]: ${e.message}`, 'error');
                previewEl.innerHTML = originalContent;
                alert(`Archive Failed: ${e.message}`);
            }
        }

        async function saveAllAssetsToR2() {
            const slots = [];
            const heroUrl = document.getElementById('asset-hero-url')?.value;
            if (heroUrl) slots.push('hero');

            for (let i = 0; i < (accumulatedData.slides?.length || 0); i++) {
                if (document.getElementById(`asset-${i}-a-url`)?.value) slots.push(`${i}-a`);
                if (document.getElementById(`asset-${i}-b-url`)?.value) slots.push(`${i}-b`);
            }

            if (!confirm(`Archive ${slots.length} assets to central R2 storage?`)) return;

            for (const slotId of slots) {
                await saveAssetToGit(slotId);
                await new Promise(r => setTimeout(r, 500));
            }
            alert("Batch Archive Sequence Complete.");
        }

        // --- HOSPITAL (SURGICAL THEATER) LOGIC ---
        let currentHospNode = 'metadata'; // 'metadata', 'glossary', or index
        let activeTabKey = 'primary';
        let quill = null;
        let turndownService = (typeof TurndownService !== 'undefined') ? new TurndownService() : null;

        function openHospital() {
            if (!accumulatedData.metadata) accumulatedData.metadata = { title: "Untitled Mission", author: "Unknown", version: "1.0", learningOutcomes: [] };
            if (!accumulatedData.slides) accumulatedData.slides = [];

            document.getElementById('hospital_modal').showModal();
            loadNodeEditor('metadata');
        }

        function closeHospital() {
            document.getElementById('hospital_modal').close();
        }

        function renderHospitalSidebar() {
            const list = document.getElementById('h-node-list');
            if (!list) return;

            let html = `
                <button class="btn btn-sm ${currentHospNode === 'metadata' ? 'btn-secondary' : 'btn-ghost'} justify-start w-full normal-case text-xs mb-1" onclick="loadNodeEditor('metadata')">
                    📜 PATIENT DOSSIER
                </button>
                <button class="btn btn-sm ${currentHospNode === 'glossary' ? 'btn-secondary' : 'btn-ghost'} justify-start w-full normal-case text-xs mb-3" onclick="loadNodeEditor('glossary')">
                    🧠 INTELLIGENCE GLOSSARY
                </button>
                <div class="text-[9px] font-bold opacity-20 uppercase tracking-tighter mb-2 ml-1">Mission Slides</div>
            `;

            (accumulatedData.slides || []).forEach((s, i) => {
                if (!s) return; // Skip null nodes
                const active = currentHospNode === i ? 'btn-active btn-primary' : 'btn-ghost';
                html += `<button class="btn btn-xs ${active} justify-start w-full normal-case text-[11px] mb-1 px-2 py-3 h-auto leading-tight" onclick="loadNodeEditor(${i})">
                    <span class="opacity-30 mr-1">${i + 1}.</span>
                    <span class="truncate">${s.title || 'Untitled Step'}</span>
                </button>`;
            });

            html += `<button class="btn btn-xs btn-ghost btn-outline border-dashed opacity-40 mt-4 w-full" onclick="addHospitalNode()">+ ADD SLIDE</button>`;
            list.innerHTML = html;
        }

        // --- HOSPITAL HELPER FUNCTIONS ---
        function updateHospitalPreview(imageUrl) {
            const previewEl = document.getElementById('h-preview-img');
            if (previewEl) {
                if (imageUrl) {
                    previewEl.src = imageUrl;
                    previewEl.classList.remove('hidden');
                } else {
                    previewEl.src = "";
                    previewEl.classList.add('hidden');
                }
            }
        }

        async function saveIdeaProgress() {
            // Auto-save WIP to Supabase (optional feature)
            if (!window.SupabaseBridge || !SupabaseBridge.client || !googleUser) {
                console.log("SAVE_IDEA: Skipping (no auth or client)");
                return;
            }
            try {
                const ideaId = accumulatedData.metadata?.id || 'WIP_' + Date.now();
                const name = accumulatedData.metadata?.title || 'Untitled';
                await SupabaseBridge.saveIdea(ideaId, name, accumulatedData, getCurrentTeacherId());
                console.log("SAVE_IDEA: Progress saved to cloud.");
            } catch (e) {
                console.warn("SAVE_IDEA: Auto-save failed:", e.message);
            }
        }

        function loadNodeEditor(nodeId) {
            currentHospNode = nodeId;
            renderHospitalSidebar();

            const editorWrap = document.getElementById('h-editor-wrap');
            const formWrap = document.getElementById('h-form-wrap');
            const pathEl = document.getElementById('h-path');
            const typeEl = document.getElementById('h-node-type');

            // Reset UI
            editorWrap.classList.add('hidden');
            formWrap.classList.add('hidden');
            document.getElementById('h-field-choices-wrap').classList.add('hidden');

            if (nodeId === 'metadata') {
                pathEl.innerText = "NODE_SYSTEM: METADATA";
                typeEl.innerText = "Node Type: Dossier";
                formWrap.classList.remove('hidden');
                renderMetadataForm();
                updateHospitalPreview(accumulatedData.metadata.heroImage);
            } else if (nodeId === 'glossary') {
                pathEl.innerText = "NODE_SYSTEM: GLOSSARY";
                typeEl.innerText = "Node Type: Intelligence";
                formWrap.classList.remove('hidden');
                renderGlossaryForm();
                updateHospitalPreview("");
            } else {
                const slide = accumulatedData.slides[nodeId];
                if (!slide) {
                    pathEl.innerText = "ERROR: NULL_NODE";
                    return;
                }
                pathEl.innerText = `NODE_PAYLOAD: SLIDE_${nodeId + 1}`;
                typeEl.innerText = "Node Type: Operational";
                editorWrap.classList.remove('hidden');
                document.getElementById('h-field-choices-wrap').classList.remove('hidden');

                if (!slide.tabs) slide.tabs = { primary: { label: "Main", body: "" } };
                if (!slide.tabs[activeTabKey]) activeTabKey = Object.keys(slide.tabs)[0];

                const tabData = slide.tabs[activeTabKey];
                document.getElementById('h-title').value = slide.title || "";
                document.getElementById('h-media-url').value = tabData.image || slide.image || "";
                document.getElementById('h-choice-a').value = slide.options?.[0] || "";
                document.getElementById('h-choice-b').value = slide.options?.[1] || "";

                updateHospitalPreview(document.getElementById('h-media-url').value);
                renderTabNav(slide);
                initQuill(tabData.body || "");
            }
        }

        function renderTabNav(slide) {
            const nav = document.getElementById('h-tabs-nav');
            let html = '';
            Object.keys(slide.tabs).forEach(key => {
                const active = key === activeTabKey ? 'btn-primary btn-active text-white' : 'btn-ghost opacity-60';
                html += `<button class="btn btn-[10px] h-6 min-h-0 ${active} px-3" onclick="switchHospitalTab('${key}')">${(slide.tabs[key].label || key).toUpperCase()}</button>`;
            });
            html += `<button class="btn btn-xs btn-ghost text-secondary" onclick="addHospitalTab()">+</button>`;
            nav.innerHTML = html;
        }

        function switchHospitalTab(key) {
            activeTabKey = key;
            loadNodeEditor(currentHospNode);
        }

        function addHospitalTab() {
            const slide = accumulatedData.slides[currentHospNode];
            const name = prompt("Enter tab label (e.g. Intel, Map):");
            if (!name) return;
            const key = name.toLowerCase().replace(/\s/g, '_');
            slide.tabs[key] = { label: name, body: "" };
            switchHospitalTab(key);
        }

        function initQuill(content) {
            const container = document.getElementById('quill-editor');
            if (!container) return;
            container.innerHTML = '';
            const editorDiv = document.createElement('div');
            container.appendChild(editorDiv);

            quill = new Quill(editorDiv, {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, false] }],
                        ['bold', 'italic', 'underline'],
                        ['link', 'blockquote', 'code-block'],
                        [{ 'list': 'ordered' }, { 'list': 'bullet' }]
                    ]
                }
            });

            quill.root.innerHTML = (typeof marked !== 'undefined') ? marked.parse(content || "") : content;

            quill.on('text-change', () => {
                if (typeof currentHospNode === 'number' && accumulatedData.slides[currentHospNode]) {
                    const html = quill.root.innerHTML;
                    const md = turndownService ? turndownService.turndown(html) : html;
                    accumulatedData.slides[currentHospNode].tabs[activeTabKey].body = md;
                    saveDraft(); // Auto-save on quill text change
                }
            });
        }

        function renderMetadataForm() {
            const data = accumulatedData.metadata;
            const wrap = document.getElementById('h-form-wrap');
            wrap.innerHTML = `
                <div class="max-w-2xl mx-auto space-y-6">
                    <h3 class="text-lg font-display tracking-widest text-primary border-b border-primary/20 pb-2">PATIENT DOSSIER</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-control"><label class="label"><span class="label-text-alt uppercase font-bold opacity-40">Mission ID</span></label><input type="text" value="${data.id || ''}" class="input input-bordered input-sm" onchange="accumulatedData.metadata.id = this.value; saveDraft();"></div>
                        <div class="form-control"><label class="label"><span class="label-text-alt uppercase font-bold opacity-40">Version</span></label><input type="text" value="${data.version || ''}" class="input input-bordered input-sm" onchange="accumulatedData.metadata.version = this.value; saveDraft();"></div>
                    </div>
                    <div class="form-control"><label class="label"><span class="label-text-alt uppercase font-bold opacity-40">Mission Title</span></label><input type="text" value="${data.title || ''}" class="input input-bordered input-sm" onchange="accumulatedData.metadata.title = this.value; saveDraft();"></div>
                    <div class="form-control"><label class="label"><span class="label-text-alt uppercase font-bold opacity-40">Briefing Summary</span></label><textarea class="textarea textarea-bordered h-24" onchange="accumulatedData.metadata.description = this.value; saveDraft();">${data.description || ''}</textarea></div>
                    
                    <div class="space-y-4 pt-4">
                        <h4 class="text-xs font-bold opacity-50 uppercase tracking-widest">Learning Outcomes</h4>
                        <div id="h-outcomes-list" class="space-y-2"></div>
                        <button class="btn btn-xs btn-outline btn-secondary" onclick="addHospitalOutcome()">+ ADD OUTCOME</button>
                    </div>

                    <div class="divider opacity-10"></div>
                    <div class="form-control">
                        <label class="label cursor-pointer justify-start gap-4">
                            <input type="checkbox" class="checkbox checkbox-primary" ${data.enableDevilsAdvocate !== false ? 'checked' : ''} onchange="accumulatedData.metadata.enableDevilsAdvocate = this.checked; saveDraft();">
                            <span class="label-text">Enable AI 'Devil's Advocate' (Critique Student Rationales)</span>
                        </label>
                    </div>
                </div>
            `;
            renderMetadataOutcomes();
        }

        function renderMetadataOutcomes() {
            const list = document.getElementById('h-outcomes-list');
            if (!list) return;
            const outcomes = accumulatedData.metadata.learningOutcomes || [];
            list.innerHTML = outcomes.map((o, i) => `
                <div class="flex gap-2">
                    <input type="text" class="input input-bordered input-xs flex-1" value="${o}" onchange="accumulatedData.metadata.learningOutcomes[${i}] = this.value; saveDraft();">
                    <button class="btn btn-xs btn-square btn-error btn-outline" onclick="removeHospitalOutcome(${i})">×</button>
                </div>
            `).join('');
        }

        function addHospitalOutcome() { if (!accumulatedData.metadata.learningOutcomes) accumulatedData.metadata.learningOutcomes = []; accumulatedData.metadata.learningOutcomes.push(""); renderMetadataForm(); saveDraft(); }
        function removeHospitalOutcome(i) { accumulatedData.metadata.learningOutcomes.splice(i, 1); renderMetadataForm(); saveDraft(); }

        function renderGlossaryForm() {
            const data = accumulatedData.intelligenceGlossary || [];
            const wrap = document.getElementById('h-form-wrap');
            wrap.innerHTML = `
                <div class="max-w-3xl mx-auto space-y-6">
                    <h3 class="text-lg font-display tracking-widest text-warning border-b border-warning/20 pb-2">INTELLIGENCE GLOSSARY</h3>
                    <p class="text-[10px] opacity-40 uppercase">Define critical terms to anchor AI behavior and student reference.</p>
                    <div id="h-glossary-list" class="space-y-3"></div>
                    <button class="btn btn-sm btn-outline btn-warning" onclick="addHospitalGlossaryTerm()">+ ADD TERM</button>
                </div>
            `;
            const list = document.getElementById('h-glossary-list');
            list.innerHTML = data.map((item, i) => `
                <div class="flex gap-3 items-start bg-base-200/50 p-3 rounded border border-white/5">
                    <div class="w-1/3"><input type="text" class="input input-bordered input-sm w-full font-bold" value="${item.term}" placeholder="Term" onchange="accumulatedData.intelligenceGlossary[${i}].term = this.value; saveDraft();"></div>
                    <div class="flex-1"><textarea class="textarea textarea-bordered textarea-sm w-full leading-tight" placeholder="Definition" onchange="accumulatedData.intelligenceGlossary[${i}].definition = this.value; saveDraft();">${item.definition}</textarea></div>
                    <button class="btn btn-sm btn-square btn-error btn-outline" onclick="removeHospitalGlossaryTerm(${i})">×</button>
                </div>
            `).join('');
        }

        function addHospitalGlossaryTerm() { if (!accumulatedData.intelligenceGlossary) accumulatedData.intelligenceGlossary = []; accumulatedData.intelligenceGlossary.push({ term: "", definition: "" }); renderGlossaryForm(); saveDraft(); }
        function removeHospitalGlossaryTerm(i) { accumulatedData.intelligenceGlossary.splice(i, 1); renderGlossaryForm(); saveDraft(); }

        function saveHospitalChanges() {
            if (typeof currentHospNode === 'number') {
                const slide = accumulatedData.slides[currentHospNode];
                if (!slide) return;
                slide.title = document.getElementById('h-title').value;
                slide.options = [document.getElementById('h-choice-a').value, document.getElementById('h-choice-b').value];
                slide.tabs[activeTabKey].image = document.getElementById('h-media-url').value;
                if (quill && turndownService) {
                    slide.tabs[activeTabKey].body = turndownService.turndown(quill.root.innerHTML);
                }
            }
            log(`CHANGES_SAVED: ${currentHospNode}`, "success");
            saveIdeaProgress();
            saveDraft(); // Auto-save after hospital changes
        }

        async function finalizeForge() {
            if (!confirm("FINALIZING: Push this mission to records?")) return;
            saveHospitalChanges();

            try {
                // Final Metadata Sync
                const missionId = accumulatedData.metadata?.id || `M-${Date.now()}`;
                const title = accumulatedData.metadata?.title || "Untitled Mission";
                const teacherId = googleUser?.email || 'GUEST';

                log(`DEPLO_FORGE: Sanitizing mission capsule [${missionId}]...`, "info");

                // Ensure slides have consistent 3-tab structure before saving
                accumulatedData.slides = (accumulatedData.slides || []).filter(s => !!s);
                accumulatedData.slides.forEach(s => {
                    if (!s.tabs) s.tabs = { primary: { label: "Main", body: "" } };
                    if (!s.tabs.intel) s.tabs.intel = { label: "Intel", body: "" };
                });

                await SupabaseBridge.saveMission(missionId, title, accumulatedData, teacherId);

                log(`BIRTH SUCCESSFUL: Capsule [${missionId}] committed to cloud hub.`, "success");
                alert("Birth Successful! Redirecting to Library...");
                window.location.reload();
            } catch (e) {
                log(`BIRTH FAILURE: ${e.message}`, "error");
                alert(`Birth Failed: ${e.message}`);
            }
        }

        async function deployMission() {
            if (!confirm("CONFIRM DEPLOYMENT? This will compile the mission dossier.")) return;

            // Final Metadata Sync
            updateMissionMetadata();

            // Sanitize (Strip base64)
            const cleanedData = sanitizeForBirth(accumulatedData);

            // Generate minimal JSON structure
            const missionId = cleanedData.metadata?.id || `MISSION_${Date.now().toString().slice(-6)}`;

            // Re-map slides to ensure consistent structure
            const slides = (cleanedData.slides || []).map(s => {
                // Ensure tabs structure
                if (!s.tabs) s.tabs = { primary: { label: "Primary", content: s.content || s.brief || "" }, intel: { label: "Intel", content: "" } };
                if (s.image && !s.tabs.primary.image) s.tabs.primary.image = s.image;
                return s;
            });

            const finalData = {
                metadata: {
                    ...cleanedData.metadata,
                    id: missionId,
                    author: googleUser?.email || "GUEST",
                    created: new Date().toISOString()
                },
                history: BuilderHistory,
                slides: slides,
                intelligenceGlossary: cleanedData.intelligenceGlossary || []
            };

            // 1. Cloud Save (if authenticated OR has teacher handle)
            const teacherId = getCurrentTeacherId();
            // Check SupabaseBridge directly (not window.SupabaseBridge)
            const hasCloudAccess = !!(SupabaseBridge && SupabaseBridge.client && teacherId && teacherId !== 'GUEST');
            console.log("DEPLOY_DEBUG_V4: hasCloudAccess:", hasCloudAccess, "teacherId:", teacherId);

            if (hasCloudAccess) {
                try {
                    log(`Uploading to Command Cloud: ${missionId}...`);
                    console.log("DEPLOY_DEBUG: Calling saveMission with teacherId:", teacherId);
                    await SupabaseBridge.saveMission(missionId, finalData.metadata.title, finalData, teacherId);
                    log("Cloud Upload Successful.", "success");
                    addBuilderChat('ai', `**MISSION DEPLOYED TO CLOUD.**\nID: \`${missionId}\`\nThis mission is now live in your Library.`);
                    alert("✅ Mission deployed to cloud successfully!");
                    fetchMissions(); // Update library UI
                    return; // EXIT FUNCTION - Do not force local download on success
                } catch (e) {
                    console.error("DEPLOY_DEBUG: Cloud Upload Error:", e);
                    log(`Cloud Upload Failed: ${e.message}. Falling back to local storage.`, "error");
                    alert("Cloud upload failed. One moment, initiating local backup...");
                }
            } else {
                console.warn("DEPLOY_DEBUG: Skipping cloud save. hasCloudAccess:", hasCloudAccess);
                log("GUEST MODE: Saving local copy only. Set Teacher Handle in Settings for cloud sync.", "warning");
            }

            // 2. Download Blob (Fallback / Guest Mode)
            const blob = new Blob([JSON.stringify(finalData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${missionId}.blob`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            if (!googleUser) log(`Mission Deployed Locally: ${missionId}`, 'success');
        }

        // --- IDEA SAVE/LOAD SYSTEM ---
        async function saveIdea() {
            const teacherId = googleUser?.email || 'GUEST';

            // Prompt for idea name
            const defaultName = accumulatedData?.metadata?.title || `Idea_${Date.now()}`;
            const ideaName = window.prompt("Name this idea (for later reference):", defaultName);
            if (!ideaName) return;

            const ideaId = `IDEA_${Date.now()}`;

            // Capture full Builder state
            const ideaData = {
                name: ideaName,
                savedAt: new Date().toISOString(),
                BuilderHistory: BuilderHistory,
                currentPhaseIndex: currentPhaseIndex,
                accumulatedData: accumulatedData,
                curriculum: {
                    country: document.getElementById('f-country')?.value || '',
                    region: document.getElementById('f-region')?.value || '',
                    course: document.getElementById('f-course')?.value || '',
                    selectedOutcomes: Array.from(document.querySelectorAll('#f-outcomes input:checked')).map(c => c.value)
                },
                settings: {
                    model: document.getElementById('f-model')?.value || 'google/gemini-2.0-flash-exp:free',
                    complexity: 'Medium'
                }
            };

            try {
                await SupabaseBridge.saveIdea(ideaId, teacherId, ideaData);
                log(`IDEA SAVED: "${ideaName}" [${ideaId}]`, 'success');
                addBuilderChat('ai', `💾 **Idea Saved!** You can close this session and resume later via "LOAD IDEA".`);
            } catch (e) {
                log(`IDEA SAVE FAILED: ${e.message}`, 'error');
                alert(`Failed to save idea: ${e.message}`);
            }
        }

        async function openIdeaLoader() {
            const teacherId = googleUser?.email || 'GUEST';

            try {
                const ideas = await SupabaseBridge.fetchIdeas(teacherId);

                if (!ideas || ideas.length === 0) {
                    alert("No saved ideas found. Start creating and use SAVE IDEA to preserve your progress.");
                    return;
                }

                // Build selection list
                let msg = "SAVED IDEAS:\n\n";
                ideas.forEach((idea, i) => {
                    const date = new Date(idea.updated_at || idea.updated).toLocaleDateString();
                    msg += `${i + 1}. ${idea.name} (${date})\n`;
                });
                msg += "\nEnter the number to load, or 0 to cancel:";

                const selection = window.prompt(msg);
                if (!selection || selection === '0') return;

                const idx = parseInt(selection) - 1;
                if (idx < 0 || idx >= ideas.length) {
                    alert("Invalid selection.");
                    return;
                }

                await loadIdea(ideas[idx].id, teacherId);
            } catch (e) {
                log(`IDEA LOAD FAILED: ${e.message}`, 'error');
                alert(`Failed to load ideas: ${e.message}`);
            }
        }

        async function loadIdea(ideaId, teacherId) {
            try {
                const ideaData = await SupabaseBridge.loadIdea(ideaId, teacherId);

                if (!ideaData) {
                    alert("Idea data not found.");
                    return;
                }

                // Restore Builder state
                BuilderHistory = ideaData.BuilderHistory || [];
                currentPhaseIndex = ideaData.currentPhaseIndex || 0;
                accumulatedData = ideaData.accumulatedData || {};

                // Restore curriculum selections
                if (ideaData.curriculum) {
                    const c = ideaData.curriculum;
                    if (c.country && document.getElementById('f-country')) {
                        document.getElementById('f-country').value = c.country;
                        updateBuilderRegions();
                        setTimeout(() => {
                            if (c.region && document.getElementById('f-region')) {
                                document.getElementById('f-region').value = c.region;
                                updateBuilderCourses();
                                setTimeout(() => {
                                    if (c.course && document.getElementById('f-course')) {
                                        document.getElementById('f-course').value = c.course;
                                        updateBuilderOutcomes();
                                    }
                                }, 100);
                            }
                        }, 100);
                    }
                }

                // Restore Model Selection
                if (ideaData.settings?.model && document.getElementById('f-model')) {
                    document.getElementById('f-model').value = ideaData.settings.model;
                }

                // Refresh UI
                renderPipelineStepper();
                updateBuilderUI();

                // Refresh Chat
                const chat = document.getElementById('Builder-chat');
                chat.innerHTML = '';
                BuilderHistory.forEach(m => addBuilderChat(m.role === 'user' ? 'user' : 'ai', m.content));

                log(`LOADED IDEA: ${ideaId}`, 'success');
                addBuilderChat('ai', `🔄 **Session Restored.** Current Phase: ${getCurrentPhase().label.toUpperCase()}`);

            } catch (e) {
                log(`LOAD ERROR: ${e.message}`, 'error');
                alert(`Failed to restore session: ${e.message}`);
            }
        }

        function renderBirthScreen(outputArea) {
            const missionId = accumulatedData?.metadata?.id || `MISSION_${Date.now().toString().slice(-6)}`;
            const missionTitle = accumulatedData?.metadata?.title || `MISSION_${new Date().toLocaleDateString()}`;

            outputArea.innerHTML = `
                <div class="p-6 h-full overflow-y-auto bg-base-300">
                    <div class="max-w-4xl mx-auto space-y-6">
                        <div class="card bg-base-100 shadow-2xl border border-primary/30">
                            <div class="card-body">
                                <h2 class="card-title text-2xl font-display tracking-widest text-primary flex items-center gap-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                                    </svg>
                                    MISSION FINAL ASSEMBLY
                                </h2>
                                <p class="text-xs opacity-60 font-mono italic">Validating encrypted dossier for tactical deployment.</p>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-6">
                                    <div class="space-y-6">
                                        <div class="space-y-4">
                                            <div class="form-control">
                                                <label class="label py-1"><span class="label-text text-[10px] font-bold opacity-50 uppercase">Mission Callsign (Title)</span></label>
                                                <input id="birth-mission-title" type="text" class="input input-bordered input-sm font-mono text-xs" value="${missionTitle}" onchange="updateMissionMetadata()">
                                            </div>
                                            <div class="form-control">
                                                <label class="label py-1"><span class="label-text text-[10px] font-bold opacity-50 uppercase">Strategic Identifier (ID)</span></label>
                                                <input id="birth-mission-id" type="text" class="input input-bordered input-sm font-mono text-xs" value="${missionId}" onchange="updateMissionMetadata()">
                                            </div>
                                        </div>
                                        
                                        <div class="p-4 bg-black/20 rounded border border-white/5">
                                            <h4 class="text-[10px] font-bold opacity-50 uppercase mb-3 tracking-widest">Integrity Report</h4>
                                            <div id="birth-validation" class="space-y-2 font-mono text-[11px]">
                                                <!-- JS Loaded -->
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="flex flex-col h-full">
                                        <label class="label py-1"><span class="label-text text-[10px] font-bold opacity-50 uppercase">Dossier Data Preview (JSON)</span></label>
                                        <div class="bg-black shadow-inner rounded p-4 font-mono text-[9px] flex-1 overflow-auto max-h-[350px] border border-white/5 scrollbar-thin">
                                            <pre id="birth-json-preview" class="text-success/80">${JSON.stringify(accumulatedData, null, 2)}</pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Birth Action Buttons -->
                        <div class="card bg-base-100 shadow-xl border border-secondary/20">
                            <div class="card-body p-4">
                                <h3 class="text-xs font-bold uppercase opacity-50 tracking-widest mb-3">Deployment Operations</h3>
                                <div class="flex flex-wrap gap-3">
                                    <button class="btn btn-outline btn-secondary btn-sm flex-1 gap-2" onclick="birthMission()">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                                        </svg>
                                        AI STRUCTURE
                                    </button>
                                    <button class="btn btn-outline btn-accent btn-sm flex-1 gap-2" onclick="downloadBirthedBlob()">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                        </svg>
                                        DOWNLOAD .BLOB
                                    </button>
                                    <button class="btn btn-primary btn-sm flex-1 gap-2" onclick="deployMission()">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                        </svg>
                                        DEPLOY TO CLOUD
                                    </button>
                                    <button class="btn btn-ghost btn-sm gap-1 opacity-70" onclick="openHospital()">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                        </svg>
                                        Manual Edit
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            updateValidationMark();
        }

        function updateValidationMark() {
            const validationEl = document.getElementById('birth-validation');
            if (!validationEl) return;

            const slides = accumulatedData?.slides || [];
            const metadata = accumulatedData?.metadata || {};

            let html = '';

            const check = (label, pass, info) => {
                const icon = pass ? '✓' : '✗';
                const color = pass ? 'text-success' : 'text-error';
                return `<div class="flex justify-between items-center ${color}">
                    <span>${icon} ${label}</span>
                    <span class="opacity-50 text-[9px]">${info}</span>
                </div>`;
            };

            html += check('MISSION TITLE', !!metadata.title, metadata.title ? 'VERIFIED' : 'MISSING');
            html += check('SLIDE CAPACITY', slides.length >= 10, `${slides.length}/10 NODES`);

            let imgCount = 0;
            slides.forEach(s => {
                if (s && (s.image || s.tabs?.primary?.image)) imgCount++;
            });
            html += check('VISUAL ASSETS', imgCount >= 10, `${imgCount}/10 LOADED`);

            const hasGlossary = Array.isArray(accumulatedData?.intelligenceGlossary) && accumulatedData.intelligenceGlossary.length > 0;
            html += check('INTEL GLOSSARY', hasGlossary, hasGlossary ? 'ACTIVE' : 'NONE');

            validationEl.innerHTML = html;
        }

        // --- DASHBOARD & SYNC LOGIC (Restored V3 Brains) ---
        function refreshDashboardStats() {
            log("Updating Dashboard Telemetry...", "info");

            // 1. Missions Count
            const missionCountEl = document.getElementById('dash-stat-missions');
            if (missionCountEl) missionCountEl.innerText = currentMissions.length;

            // 2. Classes Count
            const classCountEl = document.getElementById('dash-stat-classes');
            // Note: dash-stat-students might be used for classes in some V3 layouts, checking...
            const studentsCountEl = document.getElementById('dash-stat-students');
            if (classCountEl) classCountEl.innerText = currentClasses.length;
            if (studentsCountEl) studentsCountEl.innerText = allProgress.length;

            // 3. Sync Status
            const syncEl = document.getElementById('dash-stat-sync');
            if (syncEl) {
                syncEl.innerHTML = `
                    <div class="stat-value text-accent flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-accent animate-pulse"></div>
                        ACTIVE
                        <span class="text-[9px] font-mono opacity-30 ml-2 mt-1">SYNC: ${new Date().toLocaleTimeString()}</span>
                    </div>
                    <div class="stat-desc text-success">Cloud Sync Optimal</div>
                `;
            }
        }

        async function fetchProgress() {
            const currentTeacher = localStorage.getItem('TM_TEACHER_HANDLE') || googleUser?.email || 'GUEST';
            if (currentTeacher === 'GUEST') return;

            log("Syncing Student Progress...", "info");
            try {
                if (SupabaseBridge.client) {
                    const logs = await SupabaseBridge.fetchLogs(currentTeacher);
                    if (logs) {
                        // Normalize logs into student progress objects
                        const normalized = {};
                        logs.forEach(l => {
                            const key = `${l.student_name}_${l.class_period}`;
                            if (!normalized[key]) {
                                normalized[key] = {
                                    id: l.id,
                                    name: l.student_name,
                                    class: l.class_period || "UNKNOWN",
                                    missionData: {}
                                };
                            }
                            if (!normalized[key].missionData[l.mission_id]) {
                                normalized[key].missionData[l.mission_id] = { steps: 0, status: 'IN_FIELD' };
                            }
                            // Increase step count if decision exists
                            if (l.decision_json) normalized[key].missionData[l.mission_id].steps++;
                        });
                        allProgress = Object.values(normalized);
                        log(`Telemetry Received: ${allProgress.length} students synced.`, "success");
                        refreshDashboardStats();
                        renderProgress();
                        if (document.getElementById('projector-view').classList.contains('active')) {
                            renderProjectorBoard();
                        }
                    }
                }
            } catch (e) {
                log(`Sync Error: ${e.message}`, "error");
            }
        }

        function renderProgress() {
            const tbody = document.getElementById('students-tbody');
            if (!tbody) return;

            let html = '';
            allProgress.forEach(p => {
                const missions = Object.keys(p.missionData).join(", ");
                html += `
                <tr class="hover:bg-base-200/50 transition-colors border-b border-base-content/5">
                    <td>
                        <div class="flex items-center gap-3">
                            <div class="avatar placeholder">
                                <div class="bg-neutral text-neutral-content rounded-full w-8">
                                    <span class="text-xs">${p.name[0]}</span>
                                </div>
                            </div>
                            <div>
                                <div class="font-bold text-xs">${p.name}</div>
                                <div class="text-[10px] opacity-50 font-mono">${p.class}</div>
                            </div>
                        </div>
                    </td>
                    <td><span class="badge badge-ghost badge-xs font-mono">${missions}</span></td>
                    <td class="text-right space-x-1">
                        <button class="btn btn-ghost btn-xs text-secondary" onclick="runAI('${p.name}', '${p.class}', '${missions.split(',')[0]}')">Analyze</button>
                        <button class="btn btn-ghost btn-xs text-error" onclick="deleteStudentData('${p.name}', '${p.class}')">Scrub</button>
                    </td>
                </tr>`;
            });

            if (allProgress.length === 0) {
                html = `<tr><td colspan="3" class="text-center opacity-30 py-10 text-xs font-mono">NO ACTIVE FIELD AGENTS DETECTED</td></tr>`;
            }
            tbody.innerHTML = html;
        }

        async function deleteStudentData(name, classCode) {
            if (!confirm(`CONFIRM DATA SCRUB: Permanently delete records for [${name}] in [${classCode}]?`)) return;
            try {
                if (SupabaseBridge.client) {
                    await SupabaseBridge.deleteLogs(name, classCode);
                    log(`Data Scrub Successful: ${name}`, "success");
                    fetchProgress();
                }
            } catch (e) {
                log(`Scrub Failed: ${e.message}`, "error");
            }
        }

        function updateMissionMetadata() {
            const title = document.getElementById('birth-mission-title')?.value?.trim();
            const id = document.getElementById('birth-mission-id')?.value?.trim();

            if (!accumulatedData.metadata) accumulatedData.metadata = {};
            if (title) accumulatedData.metadata.title = title;
            if (id) accumulatedData.metadata.id = id;

            // Update JSON preview if visible
            const preview = document.getElementById('birth-json-preview');
            if (preview) preview.textContent = JSON.stringify(accumulatedData, null, 2);

            updateValidationMark();
            log('Mission identifiers synchronized.', 'info');
            saveDraft(); // Auto-save on mission metadata update
        }


        // --- CLASS DIRECTORY LOGIC ---
        async function refreshClasses() {
            // Mock data if Supabase offline
            // if (!SupabaseBridge.client) {
            //     renderClasses([]);
            //     return;
            // }

            try {
                const classes = await SupabaseBridge.fetchClasses(localStorage.getItem('TM_TEACHER_HANDLE') || googleUser?.email || 'GUEST');
                window.activeClassesData = classes; // Store for local updates
                currentClasses = classes;
                renderClasses(classes);
                refreshDashboardStats();
            } catch (e) {
                log("Class Sync Failed: " + e.message, "error");
            }
        }

        function renderClasses(classes) {
            const tbody = document.getElementById('class-directory-list-body');
            if (!tbody) return;

            if (!classes.length) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center opacity-50 py-8">No active classes found. Create one to begin.</td></tr>`;
                return;
            }

            let html = '';
            classes.forEach(c => {
                const isFav = c.is_favorite ? 'text-error fill-current' : 'text-base-content/20 hover:text-error';
                html += `
                <tr class="hover transition-colors group">
                    <td>
                        <div class="flex items-center gap-2">
                            <button onclick="toggleFavoriteClass('${c.id}')" class="btn btn-ghost btn-xs ${isFav}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" /></svg>
                            </button>
                            <span class="font-bold text-primary">${c.class_name}</span>
                        </div>
                    </td>
                    <td>
                        <div class="badge badge-lg badge-neutral font-mono tracking-widest text-accent">${c.passcode}</div>
                    </td>
                    <td>
                        <div class="flex items-center gap-2">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-50" viewBox="0 0 20 20" fill="currentColor"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" /></svg>
                             ${c.student_count || 0}
                        </div>
                    </td>
                    <td>
                        <div class="tooltip" data-tip="Click to Manage Missions">
                             <button class="btn btn-xs btn-ghost gap-2" onclick="assignMissionUI('${c.id}')">
                                <span class="badge badge-sm badge-primary badge-outline">${(c.mission_ids || []).length}</span>
                                <span class="text-[0.6rem] opacity-50 uppercase tracking-wider group-hover:opacity-100 transition-opacity">Assign</span>
                             </button>
                        </div>
                    </td>
                    <td>
                        <div class="join">
                            <button class="btn btn-xs btn-outline join-item" onclick="editClassUI('${c.id}')">Rename</button>
                            <button class="btn btn-xs btn-outline join-item" onclick="manageMissionsUI('${c.id}')">Missions</button>
                            <button class="btn btn-xs btn-outline join-item" onclick="manageStudentsUI('${c.passcode}')">Roster</button>
                            <button class="btn btn-xs btn-error btn-outline join-item" onclick="deleteClassUI('${c.id}')">X</button>
                        </div>
                    </td>
                </tr>`;
            });
            tbody.innerHTML = html;
        }

        // --- LIBRARY LOGIC ---
        async function fetchMissions() {
            log("Syncing Archive...", "info");

            // Define samples for GUEST/OFFLINE mode only
            const sampleMissions = [
                { id: "SAMPLE-01", name: "Cuban Missile Crisis", description: "Naval blockade simulation sample.", thumb: "https://images.unsplash.com/photo-1599839575945-a9e5af0c3fa5?auto=format&fit=crop&q=80&w=200" },
                { id: "SAMPLE-02", name: "Mars Colony v1", description: "Resource management failure scenario sample.", thumb: "https://images.unsplash.com/photo-1614728853970-32a2f51d15d6?auto=format&fit=crop&q=80&w=200" }
            ];

            const currentTeacher = localStorage.getItem('TM_TEACHER_HANDLE') || googleUser?.email || 'GUEST';
            const isGuest = currentTeacher === 'GUEST';

            if (SupabaseBridge.client && !isGuest) {
                try {
                    const realMissions = await SupabaseBridge.fetchMissions(currentTeacher);
                    currentMissions = realMissions;
                    log(`Archive Synced. Found ${currentMissions.length} dossiers.`, "success");
                } catch (e) {
                    log(`Archive Sync Failed: ${e.message}`, "error");
                    currentMissions = [];
                }
            } else {
                // Not logged in or no Supabase -> Show samples
                currentMissions = sampleMissions;
                if (isGuest) log("Guest Mode: Viewing sample simulations.", "warning");
            }

            renderLibrary(currentMissions);
            refreshDashboardStats();
        }

        function renderLibrary(missions) {
            const grid = document.getElementById('hub-grid');
            if (!grid) return;

            const isUserAdmin = (typeof googleUser !== 'undefined' && googleUser?.email === 'dwaugh@gmail.com');

            let html = '';
            missions.forEach(m => {
                const isSample = m.id.startsWith('SAMPLE-');
                const deleteBtn = isSample ? '' : `<button class="btn btn-xs btn-error btn-outline opacity-0 group-hover:opacity-100 transition-opacity" onclick="event.stopPropagation(); deleteMission('${m.id}')">Delete</button>`;
                const publishBtn = isSample ? '' : `<button class="btn btn-xs btn-secondary btn-outline opacity-0 group-hover:opacity-100 transition-opacity" onclick="event.stopPropagation(); publishToCommunity('${m.id}')" title="Share to Community Hub">📤</button>`;

                html += `
                <div class="card bg-base-100 shadow-xl image-full group cursor-pointer hover:scale-[1.02] transition-transform" onclick="loadMission('${m.id}')">
                    <figure><img src="${m.thumb || 'https://images.unsplash.com/photo-1451187580459-43490279c0fa'}" alt="Mission" class="opacity-40 group-hover:opacity-60 transition-opacity w-full h-48 object-cover" /></figure>
                    <div class="card-body p-4 justify-between">
                        <div>
                            <div class="flex justify-between items-start gap-2">
                                <h2 class="card-title text-sm text-white tracking-wider mb-1 line-clamp-1">${m.name}</h2>
                                <div class="flex gap-1">
                                    ${publishBtn}
                                    ${deleteBtn}
                                </div>
                            </div>
                            <p class="text-[10px] text-base-200/80 line-clamp-2">${m.description || "No description available."}</p>
                        </div>
                        <div class="card-actions justify-between items-center mt-2">
                            <div class="badge badge-xs badge-ghost font-mono opacity-50">${m.id}</div>
                            <div class="flex gap-2">
                                <button class="btn btn-xs btn-primary" onclick="event.stopPropagation(); loadMission('${m.id}')">Load</button>
                            </div>
                        </div>
                    </div>
                </div>`;
            });

            if (!missions.length) html = `<div class="col-span-1 md:col-span-3 text-center opacity-50 p-10 font-mono text-xs">NO MISSION DATA DETECTED IN ARCHIVE.</div>`;
            grid.innerHTML = html;
        }

        // --- COMMUNITY HUB LOGIC ---
        // const COMMUNITY_LIB_URL = "https://raw.githubusercontent.com/..."; // DEPRECATED - Now using Supabase

        function toggleCommunityHub() {
            const modal = document.getElementById('community_hub_modal');
            modal.showModal();
            fetchCommunityLibrary();
        }

        async function fetchCommunityLibrary() {
            const grid = document.getElementById('community-hub-grid');
            grid.innerHTML = `<div class="col-span-full text-center opacity-30 py-20"><span class="loading loading-spinner loading-md"></span><br>Loading Community Catalog...</div>`;

            try {
                if (window.SupabaseBridge && SupabaseBridge.client) {
                    const capsules = await SupabaseBridge.fetchCommunityCatalog();
                    renderCommunityHub(capsules);
                } else {
                    // Fallback to static file for offline mode
                    const res = await fetch("https://raw.githubusercontent.com/dwaugh-edsim/projectimages/main/capsule-library/index.json");
                    if (!res.ok) throw new Error("Catalog not found.");
                    const data = await res.json();
                    renderCommunityHub((data.capsules || []).map(c => ({
                        mission_id: c.id,
                        title: c.title,
                        author: c.author,
                        description: c.description,
                        thumb: c.thumb,
                        blob_data: null,
                        download_url: c.downloadUrl
                    })));
                }
            } catch (e) {
                grid.innerHTML = `<div class="col-span-full text-center text-error py-20">COMMUNITY_CATALOG_OFFLINE<br><span class="text-xs opacity-50">${e.message}</span></div>`;
                log("Community Hub Fetch Failed: " + e.message, "error");
            }
        }

        function renderCommunityHub(capsules) {
            const grid = document.getElementById('community-hub-grid');
            const currentTeacher = getCurrentTeacherId();

            if (!capsules.length) {
                grid.innerHTML = `<div class="col-span-full text-center opacity-50 py-20">No missions in community catalog yet.<br><span class="text-xs">Publish your first mission from the Library!</span></div>`;
                return;
            }
            let html = '';
            capsules.forEach(c => {
                const isOwner = c.author === currentTeacher || c.author === googleUser?.email;
                const removeBtn = isOwner ? `<button class="btn btn-xs btn-error btn-outline" onclick="removeFromCommunity('${c.mission_id}')">REMOVE</button>` : '';

                html += `
                <div class="card bg-base-200 shadow-md border border-base-content/10 group">
                    <figure class="h-32 bg-black/30">
                        <img src="${c.thumb || 'https://placehold.co/400x200/111/333?text=NO+IMAGE'}" alt="${c.title}" class="w-full h-full object-cover opacity-80">
                    </figure>
                    <div class="card-body p-3">
                        <h2 class="card-title text-sm font-display tracking-wide">${c.title}</h2>
                        <p class="text-[10px] opacity-50 font-mono uppercase">BY: ${c.author || 'UNKNOWN'}</p>
                        <p class="text-xs opacity-70 line-clamp-2">${c.description || 'An interactive educational simulation.'}</p>
                        <div class="card-actions justify-between mt-2 items-center">
                            ${removeBtn}
                            <button class="btn btn-xs btn-secondary ml-auto" onclick="importCommunityMission('${c.mission_id}', '${c.title.replace(/'/g, "\\'")}', ${c.blob_data ? 'true' : 'false'})">IMPORT</button>
                        </div>
                    </div>
                </div>`;
            });
            grid.innerHTML = html;
        }

        async function removeFromCommunity(missionId) {
            if (!confirm(`Remove this mission from the Community Hub?`)) return;

            try {
                await SupabaseBridge.removeFromCommunity(missionId);
                log(`Mission removed from Community Hub: ${missionId}`, "success");
                fetchCommunityLibrary();
            } catch (e) {
                log(`Failed to remove: ${e.message}`, "error");
                alert(`Error: ${e.message}`);
            }
        }

        async function publishToCommunity(missionId) {
            const mission = currentMissions.find(m => m.id === missionId);
            if (!mission) return alert("Mission not found in library.");

            const author = getCurrentTeacherId();
            const title = mission.name || mission.payload?.metadata?.title || "Untitled";
            const description = mission.payload?.metadata?.description || "";
            const thumb = mission.thumb || mission.payload?.metadata?.heroImage || "";

            if (!confirm(`Publish "${title}" to the Community Hub?\n\nThis makes it available to ALL teachers.`)) return;

            try {
                await SupabaseBridge.publishToCommunity(missionId, title, author, description, thumb, mission.payload);
                log(`Mission published to Community Hub: ${title}`, "success");
                alert(`"${title}" is now live in the Community Hub!`);
            } catch (e) {
                log(`Publish failed: ${e.message}`, "error");
                alert(`Error publishing: ${e.message}`);
            }
        }

        async function importCommunityMission(missionId, title, hasInlineData) {
            log(`Importing Community Capsule [${missionId}]...`, "info");
            try {
                let data;

                if (hasInlineData && window.SupabaseBridge && SupabaseBridge.client) {
                    // Fetch full record from community_catalog
                    const catalog = await SupabaseBridge.fetchCommunityCatalog();
                    const capsule = catalog.find(c => c.mission_id === missionId);
                    if (!capsule || !capsule.blob_data) throw new Error("Mission data not found in catalog.");
                    data = capsule.blob_data;
                } else {
                    // Fallback to URL fetch (legacy)
                    throw new Error("Legacy URL import not supported. Mission must have inline data.");
                }

                // Save to personal library
                const teacherId = getCurrentTeacherId();
                if (window.SupabaseBridge && SupabaseBridge.client && googleUser) {
                    await SupabaseBridge.saveMission(missionId, title, data, teacherId);
                    log(`Mission [${title}] imported to your library!`, "success");
                    alert(`Mission imported!\n\n"${title}" is now in your personal Library.`);
                    fetchMissions(); // Refresh library
                } else {
                    // Fallback: Download locally
                    log("Guest Mode: Downloading mission locally.", "warning");
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = `${missionId}.blob`;
                    a.click();
                }
                document.getElementById('community_hub_modal').close();
            } catch (e) {
                log(`Import Failed: ${e.message}`, "error");
                alert("Failed to import mission: " + e.message);
            }
        }

        async function handleFile(file) {
            if (!file) return;
            log(`Parsing local dossier: ${file.name}...`);
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const raw = e.target.result.trim();
                    // Robust Isolate: Find first { and last } to strip potential markdown or noise
                    const start = raw.indexOf('{');
                    const end = raw.lastIndexOf('}');
                    if (start === -1 || end === -1) throw new Error("No JSON object found.");

                    const data = JSON.parse(raw.substring(start, end + 1));
                    accumulatedData = data;

                    // SCHEMATIC ADAPTER (Legacy -> V72)
                    // 1. Metadata Normalization
                    if (!accumulatedData.metadata) {
                        accumulatedData.metadata = {
                            id: data.id || `LEGACY_${Date.now()}`,
                            title: data.title || data.missionTitle || "Untitled Legacy Mission",
                            author: data.author || "Unknown",
                            description: data.description || "",
                            version: data.version || "1.0"
                        };
                        // Copy root outcomes if metadata missing
                        if (data.learningOutcomes) accumulatedData.metadata.learningOutcomes = data.learningOutcomes;
                        if (data.intelligenceGlossary) accumulatedData.intelligenceGlossary = data.intelligenceGlossary;
                    }

                    // 2. Slide Normalization (Critical for Cuba/Defcon blobs)
                    if (accumulatedData.slides && Array.isArray(accumulatedData.slides)) {
                        accumulatedData.slides.forEach(s => {
                            if (!s) return;
                            // Fix Title
                            if (!s.title && s.shortTitle) s.title = s.shortTitle;

                            // Fix Tabs (Object -> Standard Schema)
                            // If tabs is an object with keys 'primary', 'intel', etc.
                            // The current builder expects specific structure or just raw keys? 
                            // Looking at 'loadMission' mock, it seems we keep the structure but ensure 'body' exists.
                            // Cuba blob has: tabs.primary.content. Builder uses tabs.primary.body? 
                            // Let's normalize content -> body if needed.
                            if (s.tabs) {
                                ['primary', 'legal', 'intel', 'background'].forEach(k => {
                                    if (s.tabs[k]) {
                                        if (s.tabs[k].content && !s.tabs[k].body) s.tabs[k].body = s.tabs[k].content;
                                        if (s.tabs[k].label && !s.tabs[k].name) s.tabs[k].name = s.tabs[k].label;
                                    }
                                });
                            }
                        });
                    }

                    // Populate BuilderHistory if possible
                    if (data.history) BuilderHistory = data.history;

                    log(`Legacy Dossier Loaded: ${accumulatedData.metadata.title}`, "success");
                    alert(`Mission Loaded: ${accumulatedData.metadata.title}`);

                    // Switch to an active phase tab to show data
                    switchMainTab('Builder');
                    updateBuilderUI();
                    saveDraft(); // Auto-save after loading file
                } catch (err) {
                    log(`Parse Error: ${err.message}`, "error");
                    alert("Invalid Dossier format: " + err.message);
                }
            };
            reader.readAsText(file);
        }

        async function deleteMission(id) {
            const currentTeacher = getCurrentTeacherId();
            console.log(`[DELETE] Attempting to delete mission: ${id} for teacher: ${currentTeacher}`);

            if (id.startsWith('SAMPLE-')) {
                log("Local samples cannot be scrubbed from the factory archive.", "warning");
                alert("Cannot delete factory samples.");
                return;
            }

            if (!confirm(`PERMANENT DELETION: Are you sure you want to scrub mission [${id}] from the record?`)) return;

            log(`SCRUBBING MISSION [${id}]...`);

            if (window.SupabaseBridge && SupabaseBridge.client) {
                try {
                    const result = await SupabaseBridge.deleteMission(id, currentTeacher);
                    console.log(`[DELETE] Supabase returned:`, result);

                    if (result && result.length > 0) {
                        log(`Mission scrubbed from cloud: ${id}`, "success");
                    } else {
                        log(`Mission [${id}] was not found or already deleted (no rows affected).`, "warning");
                    }
                    await fetchMissions();
                } catch (e) {
                    console.error(`[DELETE] Error:`, e);
                    log(`Deletion Failed: ${e.message}`, "error");
                    alert(`Deletion failed: ${e.message}`);
                }
            } else {
                log("Supabase not configured. Cannot delete from cloud.", "error");
            }
        }

        // --- CURRICULUM CONTEXT ---
        // --- CURRICULUM CONTEXT ---
        async function fetchCurriculum() {
            log("Synchronizing Curriculum Hub...", "info");

            try {
                // 1. Load static curriculum.json (fast, cached)
                const res = await fetch("curriculum.json?v=" + Date.now());
                if (res.ok) {
                    window.curriculumData = await res.json();
                    log("Base Curriculum Loaded.", "success");
                } else {
                    window.curriculumData = {};
                }
            } catch (err) {
                log("Local Curriculum Load Failed (CORS/Offline). Skipping to Cloud.", "warning");
                window.curriculumData = {};
            }

            // 2. Fetch from Supabase (extended library)
            if (window.SupabaseBridge && SupabaseBridge.client) {
                try {
                    const outcomes = await SupabaseBridge.fetchAllOutcomes();
                    outcomes.forEach(o => {
                        if (!window.curriculumData[o.country]) window.curriculumData[o.country] = {};
                        if (!window.curriculumData[o.country][o.region]) window.curriculumData[o.country][o.region] = {};
                        if (!window.curriculumData[o.country][o.region][o.course]) window.curriculumData[o.country][o.region][o.course] = [];

                        let target = window.curriculumData[o.country][o.region][o.course];
                        if (Array.isArray(target) && !target.includes(o.description)) {
                            target.push(o.description);
                        }
                    });
                    log(`Cloud Curriculum Synced: ${outcomes.length} cloud outcomes.`, "success");
                } catch (e) {
                    log(`Cloud Sync Warning: ${e.message}`, "warning");
                }
            }

            // 3. Merge Local Custom Lab
            try {
                const local = JSON.parse(localStorage.getItem('blob_custom_curriculum')) || {};
                Object.keys(local).forEach(c => {
                    if (!window.curriculumData[c]) window.curriculumData[c] = {};
                    Object.keys(local[c]).forEach(r => {
                        if (!window.curriculumData[c][r]) window.curriculumData[c][r] = {};
                        Object.assign(window.curriculumData[c][r], local[c][r]);
                    });
                });
                log("Custom Lab Synchronized.", "success");
            } catch (e) {
                log("Custom Lab Sync Error.", "warning");
            }

            log("Curriculum Hybridization Complete.");

            // Populate Country Select
            const sel = document.getElementById('f-country');
            if (sel) {
                const currentVal = sel.value;
                sel.innerHTML = `<option value="">-- SELECT COUNTRY --</option>`;
                Object.keys(window.curriculumData).sort().forEach(c => {
                    sel.innerHTML += `<option value="${c}">${c}</option>`;
                });
                if (currentVal) sel.value = currentVal;
                // Sticky Restoration
                window.isRestoringCurriculum = true;
                const savedCountry = localStorage.getItem('TM_Builder_COUNTRY');
                if (savedCountry && window.curriculumData[savedCountry]) {
                    if (sel) sel.value = savedCountry;
                    updateBuilderRegions();

                    const savedRegion = localStorage.getItem('TM_Builder_REGION');
                    const rSel = document.getElementById('f-region');
                    if (savedRegion && window.curriculumData[savedCountry][savedRegion]) {
                        rSel.value = savedRegion;
                        updateBuilderCourses();

                        const savedCourse = localStorage.getItem('TM_Builder_COURSE');
                        const cSel = document.getElementById('f-course');
                        if (savedCourse && window.curriculumData[savedCountry][savedRegion][savedCourse]) {
                            cSel.value = savedCourse;
                            updateBuilderOutcomes();
                        }
                    }
                }
                window.isRestoringCurriculum = false;
            }
        }

        function updateBuilderRegions() {
            const country = document.getElementById('f-country').value;
            const rSel = document.getElementById('f-region');
            const cSel = document.getElementById('f-course');
            const outDiv = document.getElementById('f-outcomes');

            if (!window.isRestoringCurriculum) {
                localStorage.setItem('TM_Builder_COUNTRY', country);
                localStorage.removeItem('TM_Builder_REGION');
                localStorage.removeItem('TM_Builder_COURSE');
            }

            rSel.innerHTML = `<option value="">-- SELECT REGION --</option>`;
            cSel.innerHTML = `<option value="">-- SELECT COURSE --</option>`;
            rSel.classList.add('hidden');
            cSel.classList.add('hidden');
            if (outDiv) outDiv.innerHTML = `<p class="text-center opacity-30 text-[0.6rem] py-4">SELECT COURSE TO LOAD OUTCOMES</p>`;

            if (!country || !window.curriculumData[country]) return;

            Object.keys(window.curriculumData[country]).sort().forEach(r => {
                rSel.innerHTML += `<option value="${r}">${r}</option>`;
            });
            rSel.classList.remove('hidden');
        }

        function updateBuilderCourses() {
            const country = document.getElementById('f-country').value;
            const region = document.getElementById('f-region').value;
            const cSel = document.getElementById('f-course');

            if (!window.isRestoringCurriculum) {
                localStorage.setItem('TM_Builder_REGION', region);
                localStorage.removeItem('TM_Builder_COURSE');
            }

            cSel.innerHTML = `<option value="">-- SELECT COURSE --</option>`;
            cSel.classList.add('hidden');

            if (!region || !window.curriculumData[country][region]) return;

            Object.keys(window.curriculumData[country][region]).sort().forEach(c => {
                cSel.innerHTML += `<option value="${c}">${c}</option>`;
            });
            cSel.classList.remove('hidden');
        }

        function updateBuilderOutcomes() {
            const country = document.getElementById('f-country').value;
            const region = document.getElementById('f-region').value;
            const course = document.getElementById('f-course').value;
            const outDiv = document.getElementById('f-outcomes');

            if (!window.isRestoringCurriculum) {
                localStorage.setItem('TM_Builder_COURSE', course);
            }

            if (!course || !window.curriculumData[country][region][course]) {
                if (outDiv) outDiv.innerHTML = `<p class="text-center opacity-30 text-[0.6rem] py-4">SELECT COURSE TO LOAD OUTCOMES</p>`;
                return;
            }

            const outcomes = window.curriculumData[country][region][course];
            let html = '';
            outcomes.forEach((o, i) => {
                html += `
                <label class="flex gap-2 items-start p-2 hover:bg-base-200 rounded cursor-pointer transition-colors group">
                    <input type="checkbox" value="${o}" class="checkbox checkbox-primary checkbox-xs mt-0.5 outcome-check">
                    <span class="text-[0.7rem] leading-tight opacity-70 group-hover:opacity-100">${o}</span>
                </label>`;
            });
            if (outDiv) outDiv.innerHTML = html;
            log(`Loaded ${outcomes.length} outcomes for ${course}.`, "success");
        }

        // --- CUSTOM COURSE LOGIC ---
        function toggleAllOutcomes() {
            const checks = document.querySelectorAll('.outcome-check');
            if (checks.length === 0) return;

            // If any are unchecked, select all. Otherwise, deselect all.
            const anyUnchecked = Array.from(checks).some(c => !c.checked);
            checks.forEach(c => c.checked = anyUnchecked);
            log(`${anyUnchecked ? 'Selected' : 'Deselected'} all ${checks.length} outcomes.`, 'info');
        }

        function toggleCustomAdd() {
            const zone = document.getElementById('custom-add-zone');
            zone.classList.toggle('hidden');
        }

        async function saveCustomCourse() {
            const country = document.getElementById('custom-country').value.trim() || "CUSTOM_LAB";
            const region = document.getElementById('custom-region').value.trim() || "LOCAL";
            const name = document.getElementById('custom-course-name').value.trim();
            const raw = document.getElementById('custom-outcomes-raw').value;

            if (!name || !raw) return alert("MISSING PARAMETERS: Course Name and Outcomes are required.");

            const outcomes = raw.split("\n").map(o => o.trim()).filter(o => o.length > 0);

            // Save to LocalStorage
            const custom = JSON.parse(localStorage.getItem('blob_custom_curriculum')) || {};
            if (!custom[country]) custom[country] = {};
            if (!custom[country][region]) custom[country][region] = {};
            custom[country][region][name] = outcomes;
            localStorage.setItem('blob_custom_curriculum', JSON.stringify(custom));

            // Sync to Supabase
            if (SupabaseBridge.client) {
                try {
                    for (const outcome of outcomes) {
                        await SupabaseBridge.saveCustomOutcome(country, region, name, outcome);
                    }
                    log(`Custom Course [${name}] synced to Supabase.`, "success");
                } catch (e) {
                    log(`Sync Error: ${e.message}`, "error");
                }
            }

            alert("Course Saved to Lab. Refreshing curriculum...");
            fetchCurriculum();
        }

        // --- UI HELPERS ---
        function openSettings() {
            console.log("openSettings: Interaction Hook Fired.");
            try {
                const modal = document.getElementById('settings_modal');
                if (!modal) {
                    console.error("openSettings: Modal element 'settings_modal' missing from DOM.");
                    log("CRITICAL: settings_modal element missing.", "error");
                    return;
                }

                const ids = {
                    'cfg-vercel-proxy': 'TM_VERCEL_PROXY',
                    'cfg-gcp-key': 'TM_GCP_KEY',
                    'cfg-gcp-project': 'TM_GCP_PROJECT',
                    'cfg-gcp-location': 'TM_GCP_LOCATION',
                    'cfg-gcp-model': 'TM_GCP_MODEL',
                    'cfg-gcp-client-id': 'TM_GCP_CLIENT_ID',
                    'cfg-teacher-id': 'TM_TEACHER_HANDLE',
                    'cfg-builder-model': 'TM_BUILDER_MODEL'
                };

                for (let [id, storageKey] of Object.entries(ids)) {
                    const el = document.getElementById(id);
                    if (el) {
                        let val = localStorage.getItem(storageKey) || '';
                        // Fallbacks for certain fields to match V2 defaults
                        if (!val && storageKey === 'TM_GCP_LOCATION') val = "us-central1";
                        if (!val && storageKey === 'TM_GCP_MODEL') val = "gemini-1.5-flash";
                        if (!val && storageKey === 'TM_GCP_CLIENT_ID') val = "985904065235-u0115ektel546fs42mar5rch46utkki6.apps.googleusercontent.com";

                        el.value = val;
                    }
                    else console.warn(`openSettings: Input field '${id}' missing.`);
                }

                modal.showModal();
                log("Opening System Configuration...");
            } catch (e) {
                console.error("openSettings: Execution Error", e);
                log("Settings Error: " + e.message, "error");
            }
        }

        function saveSettings() {
            try {
                // Auto-save draft before reload to prevent data loss
                saveDraft(false);

                const mappings = {
                    'cfg-vercel-proxy': 'TM_VERCEL_PROXY',
                    'cfg-gcp-key': 'TM_GCP_KEY',
                    'cfg-gcp-project': 'TM_GCP_PROJECT',
                    'cfg-gcp-location': 'TM_GCP_LOCATION',
                    'cfg-gcp-model': 'TM_GCP_MODEL',
                    'cfg-gcp-client-id': 'TM_GCP_CLIENT_ID',
                    'cfg-teacher-id': 'TM_TEACHER_HANDLE',
                    'cfg-builder-model': 'TM_BUILDER_MODEL'
                };

                console.log("saveSettings: Starting save process...");
                for (let [id, storageKey] of Object.entries(mappings)) {
                    const el = document.getElementById(id);
                    if (el) {
                        let val = el.value.trim();
                        if (storageKey === 'TM_TEACHER_HANDLE') val = val.toUpperCase();
                        console.log(`saveSettings: Saving ${storageKey} = "${val.substring(0, 10)}..."`);
                        localStorage.setItem(storageKey, val);
                    } else {
                        console.warn(`saveSettings: Element '${id}' not found!`);
                    }
                }

                // Verify key was saved
                const savedKey = localStorage.getItem('TM_GCP_KEY');
                console.log("saveSettings: Verification - TM_GCP_KEY =", savedKey ? `${savedKey.substring(0, 8)}...` : "EMPTY");
                log(`Settings Saved. GCP Key: ${savedKey ? 'Stored' : 'MISSING'}`, savedKey ? "success" : "error");

                // Sync Builder Model specifically
                const bModel = document.getElementById('cfg-builder-model')?.value;
                if (bModel && document.getElementById('f-model')) {
                    document.getElementById('f-model').value = bModel;
                }

                alert("Settings Saved. Refreshing to apply cloud credentials.");
                location.reload();
            } catch (e) {
                console.error("saveSettings Error:", e);
                alert("Failed to save settings: " + e.message);
            }
        }

        // --- SAVE SYSTEM ---
        let lastDraftTime = 0;
        async function saveDraft(forceCloud = false) {
            // Local Draft
            const bundle = {
                data: accumulatedData,
                history: BuilderHistory,
                phase: currentPhaseIndex,
                ts: Date.now()
            };
            localStorage.setItem('TM_Builder_DRAFT', JSON.stringify(bundle));

            // Cloud Auto-Save (Throttle: 30s)
            const id = accumulatedData?.metadata?.id;
            const tId = getCurrentTeacherId();
            if (id && !id.startsWith('SAMPLE-') && window.SupabaseBridge && SupabaseBridge.client) {
                const now = Date.now();
                if (forceCloud || (now - lastDraftTime > 30000)) {
                    lastDraftTime = now;
                    try {
                        const loading = document.getElementById('builder-save-indicator');
                        if (loading) loading.innerText = "Cloud Syncing...";
                        await SupabaseBridge.saveMission(id, accumulatedData.metadata.title, accumulatedData, tId);
                        if (loading) loading.innerText = "Synced";
                        setTimeout(() => { if (loading) loading.innerText = ""; }, 2000);
                        console.log("Auto-Save: Cloud Sync Complete");
                    } catch (e) { console.warn("Auto-Save Failed:", e); }
                }
            }
        }

        function restoreDraft() {
            const raw = localStorage.getItem('TM_Builder_DRAFT');
            if (!raw) return false;

            try {
                const bundle = JSON.parse(raw);
                // Expire drafts older than 24h
                if (Date.now() - bundle.ts > 86400000) return false;

                const date = new Date(bundle.ts).toLocaleTimeString();
                if (confirm(`Unsaved draft found from ${date}. Resume work?`)) {
                    accumulatedData = bundle.data;
                    BuilderHistory = bundle.history;
                    currentPhaseIndex = bundle.phase || 0;
                    switchMainTab('Builder');
                    updateBuilderUI();
                    log("Draft restored successfully.", "success");
                    return true;
                }
                return false;
            } catch (e) { console.error("Draft restore error", e); return false; }
        }

        async function loadMission(id) {
            const mission = currentMissions.find(m => m.id === id);
            if (!mission) return log(`Mission ${id} not found locally.`, 'error');

            if (confirm(`Load mission "${mission.name}" into Builder? Current progress will be overwritten.`)) {
                // Determine phase based on completeness (Mock logic)
                accumulatedData = { metadata: mission, slides: [] };
                BuilderHistory = [];
                currentPhaseIndex = 1; // Jump to Narrative as example
                updateBuilderUI();
                switchMainTab('Builder');
                addBuilderChat('ai', `**MISSION LOADED: ${mission.name}**\nResuming architecture sequence at Phase: ${getCurrentPhase().label}.`);
                saveDraft(); // Auto-save after loading mission
            }
        }

        function resetBuilder() {
            if (!confirm("RESET ALL PROGRESS? This will clear the current builder session.")) return;
            BuilderHistory = [];
            currentPhaseIndex = 0;
            accumulatedData = {
                metadata: {},
                slides: [],
                intelligenceGlossary: [],
                aiPromptsExtracted: false
            };
            localStorage.removeItem('TM_Builder_HISTORY');
            localStorage.removeItem('TM_Builder_DATA');
            localStorage.removeItem('TM_Builder_DRAFT');

            const chat = document.getElementById('Builder-chat');
            if (chat) {
                chat.innerHTML = `
                    <div class="chat chat-start">
                        <div class="chat-image avatar placeholder">
                            <div class="w-10 rounded-full bg-neutral text-neutral-content">
                                <span>AI</span>
                            </div>
                        </div>
                        <div class="chat-bubble chat-bubble-primary font-mono text-sm leading-relaxed">
                            <strong>SESSION RESET.</strong><br>
                            Builder systems purged. Ready for new curriculum context.
                        </div>
                    </div>`;
            }

            renderPipelineStepper();
            updateBuilderUI();
            log("Builder session reset.", "warning");
        }

        function generateClassCode() {
            const chars = "ABCDEFGHJKMNPQRSTUVWXYZ23456789";
            let code = "";
            for (let i = 0; i < 5; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }



        // --- HELPER: GET CURRENT TEACHER ID ---
        function getCurrentTeacherId() {
            return localStorage.getItem('TM_TEACHER_HANDLE') || googleUser?.email || 'GUEST';
        }

        async function registerClass() {
            const className = prompt("Enter Class Name (e.g., Period 1 History):", "New Class");
            if (!className) return;

            const code = generateClassCode();
            const tId = getCurrentTeacherId();

            if (!confirm(`Register new class [${className}] with code: ${code}?`)) return;

            if (SupabaseBridge.client) {
                try {
                    await SupabaseBridge.saveClass(tId, className, code);
                    log(`CLASS REGISTERED: [${className}] Code: ${code}`, "success");
                    alert(`Class Registered!\n\nName: ${className}\nCode: ${code}\n\nGive this code to your students.`);
                    refreshClasses();
                } catch (e) {
                    log("Class Registration Failed: " + e.message, "error");
                    alert("Failed to register class: " + e.message);
                }
            } else {
                alert("Supabase not connected. Cannot register class.");
            }
        }

        async function editClassUI(id) {
            const newName = prompt("Enter new Class Name:");
            if (newName && window.SupabaseBridge && SupabaseBridge.client) {
                try {
                    await SupabaseBridge.updateClass(id, { class_name: newName });
                    log(`Class renamed to ${newName}`, 'success');
                    refreshClasses();
                } catch (e) { log(`Edit Failed: ${e.message}`, 'error'); }
            }
        }

        async function deleteClassUI(id) {
            if (!confirm("Delete this class? This will disconnect student connections.")) return;
            if (window.SupabaseBridge && SupabaseBridge.client) {
                try {
                    await SupabaseBridge.deleteClass(id);
                    log(`Class scrubbed from record.`, 'warning');
                    refreshClasses();
                } catch (e) { log(`Delete Failed: ${e.message}`, 'error'); }
            }
        }

        // --- PROJECTOR VIEW LOGIC ---
        function toggleProjector() {
            const pv = document.getElementById('projector-view');
            pv.classList.toggle('active');
            if (pv.classList.contains('active')) {
                renderProjectorBoard();
                // Start auto-refresh loop
                if (window.projInterval) clearInterval(window.projInterval);
                window.projInterval = setInterval(renderProjectorBoard, 10000); // Refresh every 10s
            } else {
                if (window.projInterval) clearInterval(window.projInterval);
            }
        }

        async function renderProjectorBoard() {
            const board = document.getElementById('proj-board');
            const sync = document.getElementById('proj-sync');
            sync.innerText = `[SYNC: ${new Date().toLocaleTimeString()}]`;

            // Fetch real student progress from database
            let progressData = [];
            const teacherId = getCurrentTeacherId();

            if (window.SupabaseBridge && SupabaseBridge.client) {
                try {
                    progressData = await SupabaseBridge.fetchLiveProgress(teacherId);
                } catch (e) {
                    console.warn("Projector: Failed to fetch live data", e);
                }
            }

            // Handle empty state
            if (progressData.length === 0) {
                board.innerHTML = `
                    <div style="text-align:center; padding:40px; opacity:0.5;">
                        <div style="font-size:2rem; margin-bottom:10px;">📡</div>
                        <div style="font-size:0.8rem; text-transform:uppercase; letter-spacing:2px;">Awaiting Student Activity</div>
                        <div style="font-size:0.6rem; margin-top:5px; opacity:0.7;">Students will appear here once they begin a mission.</div>
                    </div>`;
                return;
            }

            let html = "";
            progressData.forEach(p => {
                const pct = Math.min((p.steps / 10) * 100, 100); // Assuming 10 steps max
                const isReady = p.status === "READY";

                html += `
                 <div class="proj-card ${p.steps > 0 ? 'active' : ''}">
                    <div class="proj-name">${p.name}</div>
                    <div class="proj-class">${p.class} // ${p.mission}</div>
                    <div class="proj-stats">
                        <div><div style="color:#d2b48c; font-size:0.5rem; text-transform:uppercase; margin-bottom:2px;">Intel</div><div style="font-size:0.75rem; color:#fff;">${p.steps}</div></div>
                        <div><div style="color:#d2b48c; font-size:0.5rem; text-transform:uppercase; margin-bottom:2px;">Status</div><div style="font-size:0.65rem; color:${isReady ? '#0f0' : '#ff0'};">${p.status}</div></div>
                    </div>
                    <div class="proj-bar"><div class="proj-fill" style="width:${pct}%"></div></div>
                </div>`;
            });

            board.innerHTML = html;
        }

        // --- CLASS MANAGEMENT FEATURES ---
        let activeClassAssignId = null;

        function toggleFavoriteClass(classId) {
            // Local preference persistence for V3
            const key = `fav_class_${classId}`;
            const current = localStorage.getItem(key);
            if (current) localStorage.removeItem(key);
            else localStorage.setItem(key, "true");

            // Re-render (In a real app, this would be a DB field)
            // Monkey-patch the local data for immediate feedback
            document.querySelectorAll(`button[onclick="toggleFavoriteClass('${classId}')"]`).forEach(btn => {
                btn.classList.toggle('text-error');
                btn.classList.toggle('text-base-content/20');
            });
            log("Class favorite status updated.", "info");
        }

        function assignMissionUI(classId) {
            activeClassAssignId = classId;
            const modal = document.createElement('dialog');
            modal.className = 'modal';
            modal.id = 'assign_mission_modal';

            let missionOptions = '';
            if (currentMissions.length === 0) {
                missionOptions = '<div class="p-4 opacity-50 text-center">No missions in Library.</div>';
            } else {
                currentMissions.forEach(m => {
                    missionOptions += `
                    <div class="form-control border-b border-base-content/10 p-2 hover:bg-base-200 cursor-pointer">
                        <label class="label cursor-pointer justify-start gap-4">
                            <input type="checkbox" class="checkbox checkbox-primary" value="${m.id}" />
                            <div class="flex flex-col">
                                <span class="label-text font-bold text-primary">${m.metadata?.title || m.name}</span>
                                <span class="label-text-alt opacity-50">${m.metadata?.id || m.id}</span>
                            </div>
                        </label>
                    </div>`;
                });
            }

            modal.innerHTML = `
                <div class="modal-box bg-base-100 border border-primary/20">
                    <h3 class="font-bold text-lg font-display text-primary mb-4">ASSIGN MISSIONS TO CLASS</h3>
                    <div class="max-h-60 overflow-y-auto border border-base-300 rounded-lg">
                        ${missionOptions}
                    </div>
                    <div class="modal-action">
                        <button class="btn btn-primary btn-sm" onclick="confirmAssignment()">CONFIRM ASSIGNMENT</button>
                        <form method="dialog"><button class="btn btn-ghost btn-sm">CANCEL</button></form>
                    </div>
                </div>
                <form method="dialog" class="modal-backdrop"><button>close</button></form>
            `;

            document.body.appendChild(modal);
            modal.showModal();
            modal.addEventListener('close', () => modal.remove());
        }

        async function confirmAssignment() {
            const checks = document.querySelectorAll('#assign_mission_modal input:checked');
            const ids = Array.from(checks).map(c => c.value);

            if (ids.length > 0) {
                // 1. Merge with existing mission_ids
                let finalIds = [];
                if (window.activeClassesData) {
                    const classToUpdate = window.activeClassesData.find(c => c.id === activeClassAssignId);
                    if (classToUpdate) {
                        finalIds = [...(classToUpdate.mission_ids || [])];
                        ids.forEach(id => {
                            if (!finalIds.includes(id)) finalIds.push(id);
                        });
                    }
                }

                // 2. Persist to database
                if (window.SupabaseBridge && SupabaseBridge.client) {
                    try {
                        await SupabaseBridge.updateClass(activeClassAssignId, { mission_ids: finalIds });
                        log(`Deployed ${ids.length} missions to Class [${activeClassAssignId}].`, "success");
                        // Refresh to get updated counts
                        refreshClasses();
                    } catch (e) {
                        log(`Deployment Failed: ${e.message}`, "error");
                        alert("Failed to deploy missions: " + e.message);
                    }
                } else {
                    // Offline mode: Just update local state
                    if (window.activeClassesData) {
                        const classToUpdate = window.activeClassesData.find(c => c.id === activeClassAssignId);
                        if (classToUpdate) classToUpdate.mission_ids = finalIds;
                        renderClasses(window.activeClassesData);
                    }
                    log(`Assigned ${ids.length} missions locally (offline mode).`, "warning");
                }
            }
            document.getElementById('assign_mission_modal')?.close();
        }

        async function manageStudentsUI(passcode) {
            const modalId = 'manage_roster_modal';
            let existing = document.getElementById(modalId);
            if (existing) existing.remove();

            const modal = document.createElement('dialog');
            modal.id = modalId;
            modal.className = 'modal';

            // Fetch real roster from Supabase
            let roster = [];
            if (window.SupabaseBridge && SupabaseBridge.client) {
                try {
                    roster = await SupabaseBridge.fetchClassRoster(passcode);
                } catch (e) {
                    console.warn("Failed to fetch roster:", e);
                }
            }
            window.activeRoster = roster; // Store for kick functionality

            const renderRows = () => {
                if (roster.length === 0) {
                    return `<tr><td colspan="4" class="text-center py-8 opacity-50">No students enrolled yet. Share code: ${passcode}</td></tr>`;
                }
                return roster.map(s => `
                    <tr class="hover" id="roster-row-${s.name.replace(/\s+/g, '-')}">
                        <td class="font-bold">${s.name}</td>
                        <td><div class="badge ${s.status === 'ONLINE' ? 'badge-success' : 'badge-ghost'} badge-xs mr-1"></div> ${s.status}</td>
                        <td class="font-mono text-xs">${s.score || '--'}%</td>
                        <td><button class="btn btn-xs btn-error btn-outline" onclick="kickStudentUI('${s.name}', '${passcode}')">KICK</button></td>
                    </tr>
                `).join('');
            };

            modal.innerHTML = `
                <div class="modal-box">
                    <h3 class="font-bold text-lg font-display text-secondary mb-2">CLASS ROSTER [${passcode}]</h3>
                    
                    <div class="overflow-x-auto h-64 border border-base-300 rounded mb-4 bg-black/10">
                        <table class="table table-xs w-full">
                            <thead>
                                <tr>
                                    <th>Cadet Name</th>
                                    <th>Status</th>
                                    <th>Progress</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="roster-tbody">${renderRows()}</tbody>
                        </table>
                    </div>
                    
                    <div class="alert alert-info text-xs py-2 mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span>Students join with code <strong>${passcode}</strong> in go.html.</span>
                    </div>

                    <div class="modal-action">
                        <form method="dialog"><button class="btn btn-sm">Close</button></form>
                    </div>
                </div>
                <form method="dialog" class="modal-backdrop"><button>close</button></form>
            `;
            document.body.appendChild(modal);
            modal.showModal();
        }

        window.kickStudentUI = function (name, passcode) {
            if (!confirm(`Are you sure you want to kick ${name} from class ${passcode}?`)) return;

            // Update state
            if (window.activeRoster) {
                window.activeRoster = window.activeRoster.filter(s => s.name !== name);
            }

            // Update UI if the modal is open
            const tbody = document.getElementById('roster-tbody');
            if (tbody) {
                const rows = window.activeRoster.map(s => `
                    <tr class="hover" id="roster-row-${s.name.replace(/\s+/g, '-')}">
                        <td class="font-bold">${s.name}</td>
                        <td><div class="badge ${s.status === 'ONLINE' ? 'badge-success' : 'badge-ghost'} badge-xs mr-1"></div> ${s.status}</td>
                        <td class="font-mono text-xs">${s.score}%</td>
                        <td><button class="btn btn-xs btn-error btn-outline" onclick="kickStudentUI('${s.name}', '${passcode}')">KICK</button></td>
                    </tr>
                `).join('');
                tbody.innerHTML = rows;
            }

            log(`Kicked ${name} from roster.`, "warning");
        };

        // --- PROJECTOR BOARD FILTERS ---
        function renderProjectorBoard() {
            const board = document.getElementById('proj-board');
            if (!board) return;

            const classFilter = document.getElementById('proj-class-filter').value;
            const missionFilter = document.getElementById('proj-mission-filter')?.value || 'ALL';

            // Filter entries
            const filtered = allProgress.filter(p => {
                const classMatch = (classFilter === 'ALL' || p.class === classFilter);
                return classMatch;
            });

            let html = "";
            filtered.forEach(p => {
                Object.keys(p.missionData).forEach(mid => {
                    const st = p.missionData[mid];
                    if (missionFilter !== 'ALL' && mid !== missionFilter) return;

                    const pct = Math.min((st.steps / 10) * 100, 100); // Assume 10 steps for progress bar
                    html += `
                    <div class="proj-card active">
                        <div class="proj-name">${p.name}</div>
                        <div class="proj-class">${p.class} // ${mid}</div>
                        <div class="proj-stats">
                            <div><div style="color:#d2b48c; font-size:0.5rem; text-transform:uppercase; margin-bottom:2px;">Decisions</div><div style="font-size:0.75rem; color:#fff;">${st.steps}</div></div>
                            <div><div style="color:#d2b48c; font-size:0.5rem; text-transform:uppercase; margin-bottom:2px;">Status</div><div style="font-size:0.65rem; color:#0f0;">ACTIVE</div></div>
                        </div>
                        <div class="proj-bar"><div class="proj-fill" style="width:${pct}%"></div></div>
                    </div>`;
                });
            });

            board.innerHTML = html || "<div style='grid-column:1/-1; text-align:center; opacity:0.3; padding:100px; color:#d2b48c;'>WAITING FOR FIELD AGENTS...</div>";
            document.getElementById('proj-sync').innerText = `[${filtered.length} AGENTS ONLINE]`;
        }

        // --- COPY TEACHER CODE ---
        function copyTeacherCode() {
            const codeEl = document.getElementById('dash-stat-teacher-code');
            if (codeEl && codeEl.innerText !== 'AUTH REQUIRED') {
                navigator.clipboard.writeText(codeEl.innerText);
                const btn = codeEl.parentElement.querySelector('button');
                const oldText = btn.innerText;
                btn.innerText = "COPIED!";
                setTimeout(() => btn.innerText = oldText, 2000);
            }
        }

        function toggleProjector() {
            const pv = document.getElementById('projector-view');
            pv.classList.toggle('active');
            if (pv.classList.contains('active')) {
                // Populate filters
                const cFilter = document.getElementById('proj-class-filter');
                const classes = [...new Set(allProgress.map(p => p.class))].sort();
                let cTags = '<option value="ALL">ALL CLASSES</option>';
                classes.forEach(c => cTags += `<option value="${c}">${c}</option>`);
                cFilter.innerHTML = cTags;
                renderProjectorBoard();
            }
        }

        // --- MISSION ASSIGNMENT ---
        let activeClassId = null;
        function manageMissionsUI(classId) {
            activeClassId = classId;
            const cls = currentClasses.find(c => c.id == classId);
            if (!cls) return;

            const modal = document.getElementById('mission_assignment_modal');
            const info = document.getElementById('assignment-class-info');
            const list = document.getElementById('assignment-list');

            info.innerHTML = `ASSIGN TO: <span class="text-primary">${cls.class_name}</span> (${cls.passcode})`;

            const assignedIds = cls.mission_ids || [];

            let html = '';
            currentMissions.forEach(m => {
                const checked = assignedIds.includes(m.id) ? 'checked' : '';
                html += `
                <label class="label cursor-pointer flex justify-start gap-4 hover:bg-base-200 p-2 rounded">
                    <input type="checkbox" class="checkbox checkbox-primary mission-assignment-check" value="${m.id}" ${checked}>
                    <span class="label-text text-xs">${m.name} <span class="opacity-30 font-mono">[${m.id}]</span></span>
                </label>`;
            });

            if (currentMissions.length === 0) html = '<div class="text-center opacity-30 py-4 text-xs">NO MISSIONS FOUND IN ARCHIVE.</div>';
            list.innerHTML = html;
            modal.showModal();
        }

        async function saveMissionAssignment() {
            if (!activeClassId) return;
            const checks = document.querySelectorAll('.mission-assignment-check:checked');
            const selectedIds = Array.from(checks).map(c => c.value);

            log(`Syncing assignments for class [${activeClassId}]...`, "info");
            try {
                if (SupabaseBridge.client) {
                    await SupabaseBridge.updateClass(activeClassId, { mission_ids: selectedIds });
                    log("MISSION ASSIGNMENT LOGGED.", "success");
                    document.getElementById('mission_assignment_modal').close();
                    refreshClasses();
                }
            } catch (e) {
                log(`Assignment Failed: ${e.message}`, "error");
            }
        }

        // --- PAGE INITIALIZATION ---
        window.onload = () => {
            // Initialize Supabase Bridge
            if (typeof SupabaseBridge !== 'undefined' && SB_URL && SB_KEY) {
                const connected = SupabaseBridge.init(SB_URL, SB_KEY);
                if (connected) {
                    const badge = document.getElementById('status-badge-sb');
                    if (badge) {
                        badge.innerHTML = `<div class="w-1.5 h-1.5 rounded-full bg-success"></div> SB_ONLINE`;
                        badge.classList.remove('badge-outline');
                        badge.classList.add('badge-success', 'text-white');
                    }
                    log("Supabase Uplink Established.", "success");
                }
            }

            initGoogleAuth();

            // Sync saved Builder model on load
            const savedBModel = localStorage.getItem('TM_BUILDER_MODEL');
            if (savedBModel && document.getElementById('f-model')) {
                document.getElementById('f-model').value = savedBModel;
            }

            updateBuilderUI();
            log("Command Center v3.0 Initialized.");
            refreshClasses();
            fetchMissions();
            fetchCurriculum();

            // Auto-Save: Restore Draft if available
            if (!restoreDraft()) {
                // Only if no draft, check URL params or load defaults
                const urlParams = new URLSearchParams(window.location.search);
                const missionId = urlParams.get('mission');
                if (missionId) {
                    // Logic to load mission from ID if not draft
                    console.log("Loading mission from URL:", missionId);
                }
            }
            fetchProgress();

            // Set background sync interval (30 seconds)
            setInterval(() => {
                fetchProgress();
                fetchMissions();
                refreshClasses();
            }, 30000);

            // Force Auth Prompt if Guest
            setTimeout(() => {
                if (!googleUser || googleUser.email === 'GUEST') {
                    openAuthModal();
                }
            }, 1500);
        };
    </script>

    <!-- [PORTED] PROJECTOR VIEW OVERLAY -->
    <style>
        /* [PORTED] PROJECTOR VIEW CSS */
        #projector-view {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            z-index: 9999;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
            background-image:
                linear-gradient(rgba(0, 255, 100, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 100, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
        }

        #projector-view.active {
            display: flex;
        }

        .proj-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #333;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .proj-header h1 {
            font-family: 'Oswald', sans-serif;
            font-size: 2.5rem;
            color: #d2b48c;
            margin: 0;
            letter-spacing: 5px;
            text-transform: uppercase;
        }

        .proj-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 15px;
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            align-content: flex-start;
        }

        .proj-card {
            background: #111;
            border: 1px solid #333;
            padding: 15px;
            border-radius: 4px;
            opacity: 0.5;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .proj-card.active {
            opacity: 1;
            border-color: #555;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        .proj-card.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: #00ffcc;
        }

        .proj-name {
            font-family: 'Oswald', sans-serif;
            font-size: 1.1rem;
            color: #fff;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .proj-class {
            font-family: 'Inter', sans-serif;
            font-size: 0.7rem;
            color: #888;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .proj-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            background: #1a1a1a;
            padding: 5px 8px;
            border-radius: 3px;
        }

        .proj-bar {
            height: 6px;
            background: #222;
            border-radius: 3px;
            overflow: hidden;
        }

        .proj-fill {
            height: 100%;
            background: linear-gradient(90deg, #d2b48c, #00ffcc);
            transition: width 0.5s ease;
        }
    </style>

    <div id="projector-view">
        <header class="proj-header">
            <h1>COMMAND PROGRESS BOARD</h1>
            <div style="display:flex; gap:15px; align-items:center;">
                <select id="proj-class-filter" onchange="renderProjectorBoard()"
                    class="select select-bordered select-xs font-mono bg-[#111] text-[#d2b48c] border-[#444] rounded-none">
                    <option value="ALL">ALL CLASSES</option>
                    <div id="proj-sync" class="font-mono text-[0.7rem] text-[#888] tracking-widest animate-pulse">
                        [SYNCING]</div>
                    <button onclick="toggleProjector()"
                        class="btn btn-sm bg-[#d2b48c] text-black border-none hover:bg-white font-bold tracking-widest rounded-sm">EXIT
                        PROJECTOR</button>
            </div>
        </header>

        <div id="proj-grid" class="proj-grid">
            <!-- Injected Projector Cards -->
        </div>
    </div>
</body>

</html>